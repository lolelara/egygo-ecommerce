# ðŸ’° ØªØ¯Ù‚ÙŠÙ‚ Ø´Ø§Ù…Ù„ Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ - EgyGo

**ðŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚:** 24 Ø£ÙƒØªÙˆØ¨Ø± 2025  
**ðŸŽ¯ Ø§Ù„ØºØ±Ø¶:** Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ

---

## ðŸ“Š **Ù…Ù„Ø®Øµ ØªÙ†ÙÙŠØ°ÙŠ**

```
Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©: âš ï¸ 75% Ù…ÙƒØªÙ…Ù„

âœ… Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: 90%
âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª: 85%
âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª: 95%
âš ï¸ Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹: 0%
âš ï¸ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù„Ù„ØªØ¬Ø§Ø±: 70%
âš ï¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©: 80%
```

---

## ðŸ”„ **ØªØ¯ÙÙ‚ Ø§Ù„Ø£Ù…ÙˆØ§Ù„ Ø§Ù„ÙƒØ§Ù…Ù„**

### **Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ:**

```mermaid
Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¯ÙØ¹ â†’ Ø§Ù„Ù…Ù†ØµØ© ØªØ³ØªÙ„Ù… â†’ Ø§Ù„ØªØ§Ø¬Ø± ÙŠØ³ØªÙ„Ù… Ø­ØµØªÙ‡ â†’ Ø§Ù„Ù…Ø³ÙˆÙ‚ ÙŠØ³ØªÙ„Ù… Ø¹Ù…ÙˆÙ„ØªÙ‡ â†’ Ø§Ù„Ù…Ù†ØµØ© ØªØ­ØªÙØ¸ Ø¨Ù†Ø³Ø¨ØªÙ‡Ø§
```

### **Ø§Ù„ØªÙØµÙŠÙ„:**

```
1ï¸âƒ£ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ´ØªØ±ÙŠ Ù…Ù†ØªØ¬ (1000 Ø¬.Ù…)
   â†“
2ï¸âƒ£ Ø§Ù„Ø¯ÙØ¹ ÙŠØªÙ… Ø¹Ø¨Ø± (Paymob/Fawry/COD)
   â†“
3ï¸âƒ£ Ø§Ù„Ù…Ù†ØµØ© ØªØ³ØªÙ„Ù…: 1000 Ø¬.Ù…
   â”œâ”€â”€ Ø­ØµØ© Ø§Ù„ØªØ§Ø¬Ø±: 850 Ø¬.Ù… (85%)
   â”œâ”€â”€ Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ø³ÙˆÙ‚: 100 Ø¬.Ù… (10%)
   â””â”€â”€ Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ù†ØµØ©: 50 Ø¬.Ù… (5%)
   â†“
4ï¸âƒ£ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­:
   â”œâ”€â”€ Ø§Ù„ØªØ§Ø¬Ø± ÙŠØ·Ù„Ø¨ Ø³Ø­Ø¨ 850 Ø¬.Ù…
   â”œâ”€â”€ Ø§Ù„Ù…Ø³ÙˆÙ‚ ÙŠØ·Ù„Ø¨ Ø³Ø­Ø¨ 100 Ø¬.Ù…
   â””â”€â”€ Ø§Ù„Ù…Ù†ØµØ© ØªØ­ØªÙØ¸ Ø¨Ù€ 50 Ø¬.Ù…
   â†“
5ï¸âƒ£ Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠÙˆØ§ÙÙ‚ ÙˆÙŠØ­ÙˆÙ„ Ø§Ù„Ø£Ù…ÙˆØ§Ù„
   â”œâ”€â”€ ØªØ­ÙˆÙŠÙ„ Ù„Ù„ØªØ§Ø¬Ø± (ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´/Ø¨Ù†Ùƒ)
   â””â”€â”€ ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ø³ÙˆÙ‚ (ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´/Ø¨Ù†Ùƒ)
```

---

## âœ… **Ù…Ø§ Ù‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙŠØ¹Ù…Ù„**

### **1ï¸âƒ£ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª (Commission System)**

**Ø§Ù„Ø­Ø§Ù„Ø©:** âœ… **Ù…ÙƒØªÙ…Ù„ 85%**

**Ø§Ù„Ù…Ù„ÙØ§Øª:**
- âœ… `client/lib/commission-system.ts` - Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª
- âœ… `client/pages/AdminCommissions.tsx` - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª
- âœ… `client/pages/AffiliateDashboard.tsx` - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ÙˆÙ‚

**Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**
```typescript
âœ… createCommissionRecord() - Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¹Ù…ÙˆÙ„Ø©
âœ… createMerchantEarning() - Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØªØ§Ø¬Ø±
âœ… approveCommissionAfterPayment() - Ù…ÙˆØ§ÙÙ‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹
âœ… approveMerchantEarningAfterDelivery() - Ù…ÙˆØ§ÙÙ‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØµÙŠÙ„
âœ… getPendingCommissions() - Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
âœ… getPendingMerchantEarnings() - Ø¬Ù„Ø¨ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØªØ¬Ø§Ø±
```

**Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©:**
- Ø§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ†: **15%** (Ø§ÙØªØ±Ø§Ø¶ÙŠØŒ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ®ØµÙŠØµ)
- Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ù†ØµØ© Ù„Ù„ØªØ¬Ø§Ø±: **10%** (Ø§ÙØªØ±Ø§Ø¶ÙŠ)
- Ø§Ù„ØªØ§Ø¬Ø± ÙŠØ³ØªÙ„Ù…: **85-90%** Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬

**Ø§Ù„Ù†Ø§Ù‚Øµ:**
```
âŒ Collection 'affiliate_commissions' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Appwrite
âŒ Collection 'merchant_earnings' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Appwrite
âš ï¸ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†
```

---

### **2ï¸âƒ£ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª (Withdrawals System)**

**Ø§Ù„Ø­Ø§Ù„Ø©:** âœ… **Ù…ÙƒØªÙ…Ù„ 95%**

**Ø§Ù„Ù…Ù„ÙØ§Øª:**
- âœ… `client/pages/AdminWithdrawalsManager.tsx` - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
- âœ… `scripts/setup-withdrawals-collection.js` - Ø¥Ù†Ø´Ø§Ø¡ Collection
- âœ… `scripts/complete-withdrawals-collection.js` - Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù†Ø§Ù‚Øµ
- âœ… `APPWRITE_WITHDRAWALS_SETUP.md` - Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯

**Collection:** âœ… `withdrawalRequests`
```
Attributes: 18/18 âœ…
Indexes: 4/4 âœ…
Bucket: payment-proofs âœ…
```

**Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**
```typescript
âœ… Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯ (Create Request)
âœ… Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (List All)
âœ… ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© (Filter by Status)
âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ (Process Request)
   â”œâ”€â”€ Ù…ÙˆØ§ÙÙ‚Ø© (Approve)
   â”œâ”€â”€ Ø±ÙØ¶ (Reject)
   â””â”€â”€ Ø±ÙØ¹ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ (Upload Proof)
âœ… Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Transaction ID)
âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Notes)
âœ… ØªØªØ¨Ø¹ Ù…Ù† Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø·Ù„Ø¨ (Audit Trail)
```

**Ø·Ø±Ù‚ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©:**
- âœ… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ (Vodafone Cash)
- âœ… Ø¥Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ (InstaPay)
- âœ… ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ (Bank Transfer)
- âœ… ÙÙˆØ±ÙŠ (Fawry)

**Ø§Ù„Ø­Ø§Ù„Ø§Øª:**
```
pending â†’ processing â†’ completed
                    â†“
                 rejected
```

**Ø§Ù„Ù†Ø§Ù‚Øµ:**
```
âš ï¸ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
âš ï¸ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
```

---

### **3ï¸âƒ£ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù„Ù„ØªØ¬Ø§Ø± (Merchant Payments)**

**Ø§Ù„Ø­Ø§Ù„Ø©:** âš ï¸ **Ù…ÙƒØªÙ…Ù„ 70%**

**Ø§Ù„Ù…Ù„ÙØ§Øª:**
- âœ… `client/pages/AdminMerchantPaymentsManager.tsx`
- âš ï¸ Collection Ù‚Ø¯ ØªÙƒÙˆÙ† Ù†Ø§Ù‚ØµØ©

**Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**
```typescript
âœ… Ø¹Ø±Ø¶ Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„ØªØ¬Ø§Ø±
âœ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ù†ØµØ©
âœ… Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹
âš ï¸ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
```

**Ø§Ù„Ù†Ø§Ù‚Øµ:**
```
âŒ Collection 'merchantPayments' Ù‚Ø¯ ØªÙƒÙˆÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
âŒ Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª
âŒ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„
```

---

### **4ï¸âƒ£ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Financial Reports)**

**Ø§Ù„Ø­Ø§Ù„Ø©:** âœ… **Ù…ÙƒØªÙ…Ù„ 80%**

**Ø§Ù„Ù…Ù„ÙØ§Øª:**
- âœ… `client/pages/AdminFinancialDashboard.tsx` - Ù„ÙˆØ­Ø© Ù…Ø§Ù„ÙŠØ©
- âœ… `client/pages/AdminFinancialReports.tsx` - ØªÙ‚Ø§Ø±ÙŠØ± Ù…ÙØµÙ„Ø©
- âœ… `client/pages/MerchantFinancialHistory.tsx` - Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø¬Ø±
- âœ… `client/pages/FinancialReportsPage.tsx` - ØªÙ‚Ø§Ø±ÙŠØ± Ø¹Ø§Ù…Ø©

**Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**
```typescript
âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª
âœ… Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØªØ¬Ø§Ø±
âœ… Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ù†ØµØ©
âœ… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©/Ø§Ù„Ø´Ù‡Ø±ÙŠØ©/Ø§Ù„Ø³Ù†ÙˆÙŠØ©
âœ… ØªØµØ¯ÙŠØ± PDF/Excel
```

**Ø§Ù„Ù†Ø§Ù‚Øµ:**
```
âš ï¸ Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© ØªÙØ§Ø¹Ù„ÙŠØ© (Charts)
âš ï¸ Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„ÙØªØ±Ø§Øª
âš ï¸ ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
```

---

## âŒ **Ù…Ø§ Ù‡Ùˆ Ù†Ø§Ù‚Øµ ÙˆØ­Ø±Ø¬**

### **1ï¸âƒ£ Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ (Payment Gateways)** ðŸ”´

**Ø§Ù„Ø­Ø§Ù„Ø©:** âŒ **0% - ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹**

**Ø§Ù„Ø£Ù‡Ù…ÙŠØ©:** ðŸ”´ðŸ”´ðŸ”´ **Ø­Ø±Ø¬Ø© Ø¬Ø¯Ø§Ù‹ - Ø¨Ø¯ÙˆÙ†Ù‡Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø§ ÙŠØ¹Ù…Ù„!**

**Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**

#### **Ø£) Paymob Integration**
```typescript
// client/lib/payment/paymob.ts

export async function initiatePaymobPayment(params: {
  amount: number;
  orderId: string;
  customerEmail: string;
  customerPhone: string;
}) {
  // 1. Get auth token
  const authToken = await getPaymobAuthToken();
  
  // 2. Register order
  const order = await registerPaymobOrder({
    authToken,
    amount: params.amount * 100, // Convert to cents
    orderId: params.orderId
  });
  
  // 3. Get payment key
  const paymentKey = await getPaymobPaymentKey({
    authToken,
    orderId: order.id,
    amount: params.amount,
    billingData: {
      email: params.customerEmail,
      phone: params.customerPhone
    }
  });
  
  // 4. Return iframe URL
  return `https://accept.paymob.com/api/acceptance/iframes/YOUR_IFRAME_ID?payment_token=${paymentKey}`;
}

// Webhook handler
export async function handlePaymobWebhook(payload: any) {
  // Verify HMAC signature
  const isValid = verifyPaymobHMAC(payload);
  if (!isValid) throw new Error('Invalid signature');
  
  // Update order status
  if (payload.success) {
    await updateOrderStatus(payload.order_id, 'paid');
    await createCommissionRecords(payload.order_id);
  }
}
```

#### **Ø¨) Fawry Integration**
```typescript
// client/lib/payment/fawry.ts

export async function createFawryPayment(params: {
  amount: number;
  orderId: string;
  customerEmail: string;
  customerPhone: string;
}) {
  const referenceNumber = `EGYGO-${params.orderId}`;
  
  const payload = {
    merchantCode: process.env.FAWRY_MERCHANT_CODE,
    merchantRefNum: referenceNumber,
    customerProfileId: params.customerEmail,
    customerMobile: params.customerPhone,
    paymentMethod: 'CARD',
    amount: params.amount,
    currencyCode: 'EGP',
    chargeItems: [{
      itemId: params.orderId,
      description: 'Order payment',
      price: params.amount,
      quantity: 1
    }],
    returnUrl: `${window.location.origin}/payment/callback`,
    signature: generateFawrySignature(/* ... */)
  };
  
  const response = await fetch('https://atfawry.fawrystaging.com/ECommerceWeb/Fawry/payments/charge', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  
  return response.json();
}
```

#### **Ø¬) Cash on Delivery**
```typescript
// client/lib/payment/cod.ts

export async function processCODOrder(orderId: string) {
  // 1. Update order with COD method
  await databases.updateDocument(
    appwriteConfig.databaseId,
    'orders',
    orderId,
    {
      paymentMethod: 'cod',
      paymentStatus: 'pending',
      orderStatus: 'confirmed'
    }
  );
  
  // 2. Create commission records (pending)
  // Will be approved after delivery confirmation
  await createCommissionRecord({
    orderId,
    status: 'pending',
    paymentCollected: false
  });
  
  // 3. Send notification to merchant
  await notifyMerchant(orderId, 'new_cod_order');
}
```

**Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±:** 3-4 Ø£ÙŠØ§Ù…  
**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ðŸ”´ðŸ”´ðŸ”´ **Ø§Ù„Ø£Ø¹Ù„Ù‰**

---

### **2ï¸âƒ£ Collections Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù†Ø§Ù‚ØµØ©**

**Ø§Ù„Ø­Ø§Ù„Ø©:** âŒ **Collections ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©**

**Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**

#### **Ø£) affiliate_commissions Collection**
```javascript
{
  collectionId: 'affiliate_commissions',
  attributes: [
    { key: 'affiliateId', type: 'string', required: true },
    { key: 'orderId', type: 'string', required: true },
    { key: 'productId', type: 'string', required: true },
    { key: 'productName', type: 'string', required: true },
    { key: 'orderTotal', type: 'float', required: true },
    { key: 'commissionAmount', type: 'float', required: true },
    { key: 'commissionRate', type: 'float', required: true },
    { key: 'status', type: 'enum', values: ['pending', 'approved', 'paid', 'rejected'] },
    { key: 'paymentCollected', type: 'boolean', default: false },
    { key: 'deliveryConfirmed', type: 'boolean', default: false },
    { key: 'approvedAt', type: 'datetime' },
    { key: 'paidAt', type: 'datetime' },
    { key: 'approvedBy', type: 'string' }
  ],
  indexes: [
    { key: 'affiliateId_idx', attributes: ['affiliateId'] },
    { key: 'status_idx', attributes: ['status'] },
    { key: 'orderId_idx', attributes: ['orderId'] }
  ]
}
```

#### **Ø¨) merchant_earnings Collection**
```javascript
{
  collectionId: 'merchant_earnings',
  attributes: [
    { key: 'merchantId', type: 'string', required: true },
    { key: 'orderId', type: 'string', required: true },
    { key: 'productId', type: 'string', required: true },
    { key: 'productName', type: 'string', required: true },
    { key: 'saleAmount', type: 'float', required: true },
    { key: 'merchantEarning', type: 'float', required: true },
    { key: 'platformFee', type: 'float', required: true },
    { key: 'status', type: 'enum', values: ['pending', 'approved', 'paid'] },
    { key: 'deliveryConfirmed', type: 'boolean', default: false },
    { key: 'approvedAt', type: 'datetime' },
    { key: 'paidAt', type: 'datetime' }
  ],
  indexes: [
    { key: 'merchantId_idx', attributes: ['merchantId'] },
    { key: 'status_idx', attributes: ['status'] },
    { key: 'orderId_idx', attributes: ['orderId'] }
  ]
}
```

#### **Ø¬) platform_revenue Collection**
```javascript
{
  collectionId: 'platform_revenue',
  attributes: [
    { key: 'orderId', type: 'string', required: true },
    { key: 'revenueType', type: 'enum', values: ['platform_fee', 'ad_revenue', 'subscription'] },
    { key: 'amount', type: 'float', required: true },
    { key: 'date', type: 'datetime', required: true },
    { key: 'source', type: 'string' }, // 'merchant_fee', 'ad_payment', etc.
  ],
  indexes: [
    { key: 'date_idx', attributes: ['date'] },
    { key: 'type_idx', attributes: ['revenueType'] }
  ]
}
```

**Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**
```bash
npm run create-commission-collections
```

**Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±:** 1-2 ÙŠÙˆÙ…

---

### **3ï¸âƒ£ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª**

**Ø§Ù„Ø­Ø§Ù„Ø©:** âš ï¸ **ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†**

**Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:**

```typescript
// ÙÙŠ checkout Ø£Ùˆ order creation
export async function createOrder(orderData: OrderData) {
  // 1. Create order
  const order = await databases.createDocument(
    appwriteConfig.databaseId,
    'orders',
    ID.unique(),
    orderData
  );
  
  // 2. Process payment
  if (orderData.paymentMethod === 'paymob') {
    const paymentUrl = await initiatePaymobPayment({
      amount: orderData.total,
      orderId: order.$id,
      customerEmail: orderData.customerEmail,
      customerPhone: orderData.customerPhone
    });
    return { order, paymentUrl };
  }
  
  // 3. Create commission records (after payment confirmation)
  // This happens in webhook handler
}

// ÙÙŠ payment webhook
export async function handlePaymentConfirmation(orderId: string) {
  const order = await getOrder(orderId);
  
  // 1. Create commission for affiliate (if exists)
  if (order.affiliateId) {
    await createCommissionRecord({
      affiliateId: order.affiliateId,
      orderId: order.$id,
      productId: order.productId,
      productName: order.productName,
      orderTotal: order.total,
      commissionRate: order.commissionRate || 0.15
    });
  }
  
  // 2. Create merchant earning
  await createMerchantEarning({
    merchantId: order.merchantId,
    orderId: order.$id,
    productId: order.productId,
    productName: order.productName,
    saleAmount: order.total,
    platformFeeRate: 0.10
  });
  
  // 3. Record platform revenue
  await recordPlatformRevenue({
    orderId: order.$id,
    revenueType: 'platform_fee',
    amount: order.total * 0.10,
    source: 'merchant_fee'
  });
  
  // 4. Send notifications
  await notifyMerchant(order.merchantId, 'new_order');
  if (order.affiliateId) {
    await notifyAffiliate(order.affiliateId, 'new_commission');
  }
}
```

---

## ðŸ“‹ **Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©**

### **1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Collections Ø§Ù„Ù…Ø§Ù„ÙŠØ©**

```bash
# Create the script
cat > scripts/create-commission-collections.js << 'EOF'
import { Client, Databases } from 'node-appwrite';
import { config } from 'dotenv';
config();

const client = new Client()
    .setEndpoint(process.env.VITE_APPWRITE_ENDPOINT)
    .setProject(process.env.VITE_APPWRITE_PROJECT_ID)
    .setKey(process.env.APPWRITE_API_KEY);

const databases = new Databases(client);
const DATABASE_ID = process.env.VITE_APPWRITE_DATABASE_ID;

async function createCommissionCollections() {
  // Create affiliate_commissions
  await databases.createCollection(/*...*/);
  
  // Create merchant_earnings
  await databases.createCollection(/*...*/);
  
  // Create platform_revenue
  await databases.createCollection(/*...*/);
}

createCommissionCollections();
EOF

# Run it
npm run create-commission-collections
```

### **2ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ**

```bash
# Create test script
cat > scripts/test-financial-flow.js << 'EOF'
// 1. Create test order
const order = await createTestOrder();

// 2. Simulate payment
await simulatePayment(order.$id);

// 3. Verify commission created
const commission = await getCommissionByOrderId(order.$id);
assert(commission.status === 'pending');

// 4. Approve commission
await approveCommissionAfterPayment(commission.$id);

// 5. Create withdrawal request
const withdrawal = await createWithdrawalRequest({
  userId: commission.affiliateId,
  amount: commission.commissionAmount
});

// 6. Process withdrawal
await processWithdrawal(withdrawal.$id, 'completed');

console.log('âœ… Financial flow test passed!');
EOF

npm run test-financial-flow
```

---

## ðŸŽ¯ **Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©**

### **Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 1: Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©**

#### **Ø§Ù„ÙŠÙˆÙ… 1-2: Collections Ø§Ù„Ù…Ø§Ù„ÙŠØ©**
```bash
âœ… Create affiliate_commissions collection
âœ… Create merchant_earnings collection  
âœ… Create platform_revenue collection
âœ… Test collections creation
```

#### **Ø§Ù„ÙŠÙˆÙ… 3-4: Ø¨ÙˆØ§Ø¨Ø© Ø¯ÙØ¹ ÙˆØ§Ø­Ø¯Ø©**
```bash
âœ… Paymob integration (Ø£Ùˆ)
âœ… Cash on Delivery setup
âœ… Payment webhook handler
âœ… Test payment flow
```

#### **Ø§Ù„ÙŠÙˆÙ… 5-6: Ø§Ù„ØªÙƒØ§Ù…Ù„**
```bash
âœ… Link orders with commissions
âœ… Auto-create commission records
âœ… Test complete flow: Order â†’ Payment â†’ Commission
```

#### **Ø§Ù„ÙŠÙˆÙ… 7: Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±**
```bash
âœ… End-to-end testing
âœ… Fix bugs
âœ… Documentation
```

---

### **Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 2: Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª**

#### **Ø§Ù„ÙŠÙˆÙ… 8-9: Ø¨ÙˆØ§Ø¨Ø© Ø¯ÙØ¹ Ø«Ø§Ù†ÙŠØ©**
```bash
âœ… Fawry integration (Ø£Ùˆ Paymob Ø¥Ø°Ø§ Ø¨Ø¯Ø£Øª Ø¨Ù€ COD)
âœ… Test both payment methods
```

#### **Ø§Ù„ÙŠÙˆÙ… 10-11: Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª**
```bash
âœ… Email notifications (order, payment, commission)
âœ… SMS notifications (optional)
âœ… Push notifications
```

#### **Ø§Ù„ÙŠÙˆÙ… 12-14: Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª**
```bash
âœ… Financial reports improvements
âœ… Charts and graphs
âœ… Export functionality
âœ… Final testing
```

---

## âœ… **Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©**

### **Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ©:**
```
âœ… withdrawalRequests collection
âŒ affiliate_commissions collection
âŒ merchant_earnings collection
âŒ platform_revenue collection
âœ… payment-proofs bucket
```

### **Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹:**
```
âŒ Paymob integration
âŒ Fawry integration
âŒ Cash on Delivery
âŒ Payment webhooks
```

### **Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ:**
```
âœ… Commission calculation logic
âœ… Merchant earning calculation
âš ï¸ Auto commission creation (needs collections)
âš ï¸ Auto merchant earning creation (needs collections)
âœ… Withdrawal system
âš ï¸ Automatic approval workflow
```

### **Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±:**
```
âœ… Financial dashboard
âœ… Commission reports
âœ… Merchant earnings reports
âœ… Withdrawal reports
âš ï¸ Platform revenue reports
```

### **Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:**
```
âš ï¸ Order confirmation emails
âš ï¸ Payment confirmation
âš ï¸ Commission earned notification
âš ï¸ Withdrawal status updates
```

---

## ðŸ“Š **Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‡Ù…ÙŠØ©**

### **ðŸ”´ Ø­Ø±Ø¬ (ÙŠØ¬Ø¨ Ø¥Ù†Ø¬Ø§Ø²Ù‡ ÙÙˆØ±Ø§Ù‹):**
```
1ï¸âƒ£ Ø¨ÙˆØ§Ø¨Ø© Ø¯ÙØ¹ ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (Paymob Ø£Ùˆ COD)
2ï¸âƒ£ affiliate_commissions collection
3ï¸âƒ£ merchant_earnings collection  
4ï¸âƒ£ Ø±Ø¨Ø· Orders Ù…Ø¹ Commissions
```

**Ø§Ù„ÙˆÙ‚Øª: Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ø­Ø¯**

### **ðŸŸ¡ Ù…Ù‡Ù… (Ø®Ù„Ø§Ù„ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†):**
```
5ï¸âƒ£ Ø¨ÙˆØ§Ø¨Ø© Ø¯ÙØ¹ Ø«Ø§Ù†ÙŠØ©
6ï¸âƒ£ platform_revenue collection
7ï¸âƒ£ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
8ï¸âƒ£ ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
```

**Ø§Ù„ÙˆÙ‚Øª: Ø£Ø³Ø¨ÙˆØ¹ Ø¥Ø¶Ø§ÙÙŠ**

### **ðŸŸ¢ Ø§Ø®ØªÙŠØ§Ø±ÙŠ (ÙŠÙ…ÙƒÙ† ØªØ£Ø¬ÙŠÙ„Ù‡):**
```
9ï¸âƒ£ ØªÙ‚Ø§Ø±ÙŠØ± Ù…ØªÙ‚Ø¯Ù…Ø©
ðŸ”Ÿ Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© ØªÙØ§Ø¹Ù„ÙŠØ©
1ï¸âƒ£1ï¸âƒ£ ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
1ï¸âƒ£2ï¸âƒ£ ØªØ­Ù„ÙŠÙ„Ø§Øª AI
```

---

## ðŸ’¡ **ØªÙˆØµÙŠØ§Øª**

### **1. Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ø§Ù„ÙŠ:**
```typescript
âœ… ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
âœ… ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Audit Trail)
âœ… Double-check Ù„Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
âœ… Two-factor authentication Ù„Ù„Ø³Ø­ÙˆØ¨Ø§Øª
âœ… Rate limiting Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
```

### **2. Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©:**
```typescript
âœ… Backup ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
âœ… Transaction logs
âœ… Rollback mechanism Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
âœ… Error notifications Ù„Ù„Ø£Ø¯Ù…Ù†
âœ… Manual override Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©
```

### **3. Ø§Ù„Ø£Ø¯Ø§Ø¡:**
```typescript
âœ… Caching Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©
âœ… Background jobs Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©
âœ… Pagination Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
âœ… Indexes Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠØ©
```

---

## ðŸŽ‰ **Ø§Ù„Ø®Ù„Ø§ØµØ©**

### **Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:**
```
âœ… Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© (75%)
âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª ÙƒØ§Ù…Ù„ (95%)
âœ… Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª Ø¬Ø§Ù‡Ø² (85%)
âœ… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¬ÙŠØ¯Ø© (80%)

âŒ Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ù…ÙÙ‚ÙˆØ¯Ø© (0%) ðŸ”´
âŒ Collections Ù…Ø§Ù„ÙŠØ© Ù†Ø§Ù‚ØµØ© ðŸ”´
âš ï¸ Ø§Ù„ØªÙƒØ§Ù…Ù„ ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†
```

### **Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„:**
```
Ø§Ù„Ù…Ø¯Ø©: 2-3 Ø£Ø³Ø§Ø¨ÙŠØ¹
Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ + Collections
Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ù†Ø¸Ø§Ù… Ù…Ø§Ù„ÙŠ ÙƒØ§Ù…Ù„ ÙˆÙ…ØªÙƒØ§Ù…Ù„
```

### **Ù„Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹ (MVP):**
```
Ø§Ù„Ù…Ø¯Ø©: Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ø­Ø¯
Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:
  1. COD ÙÙ‚Ø· (Ø£Ø³Ù‡Ù„)
  2. affiliate_commissions collection
  3. merchant_earnings collection
  4. Ø±Ø¨Ø· Ø¨Ø³ÙŠØ· Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª

Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„ØŒ Ù„ÙƒÙ† Ù…Ø­Ø¯ÙˆØ¯
```

---

## ðŸ“ž **Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©**

**Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø±:**

### **Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹ (Ø£Ø³Ø¨ÙˆØ¹):**
```bash
1. npm run create-commission-collections
2. ØªØ·Ø¨ÙŠÙ‚ COD ÙÙ‚Ø·
3. Ø±Ø¨Ø· Ø¨Ø³ÙŠØ· Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
4. Ø§Ø®ØªØ¨Ø§Ø± + Ø¥Ø·Ù„Ø§Ù‚
```

### **Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (2-3 Ø£Ø³Ø§Ø¨ÙŠØ¹):**
```bash
1. npm run create-commission-collections
2. ØªØ·Ø¨ÙŠÙ‚ Paymob + Fawry + COD
3. Ù†Ø¸Ø§Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒØ§Ù…Ù„
4. ØªÙ‚Ø§Ø±ÙŠØ± Ù…ØªÙ‚Ø¯Ù…Ø©
5. Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ + Ø¥Ø·Ù„Ø§Ù‚
```

---

**ðŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:** 24 Ø£ÙƒØªÙˆØ¨Ø± 2025  
**ðŸ“Š Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚:** Ø´Ø§Ù…Ù„ âœ…  
**ðŸŽ¯ Ø§Ù„Ø­Ø§Ù„Ø©:** Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ†ÙÙŠØ°

**ðŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†!**
