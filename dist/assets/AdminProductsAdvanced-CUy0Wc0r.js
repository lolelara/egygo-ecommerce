import{r as p,j as e,cn as he,bd as xe,c1 as me,_ as je,n as pe,co as fe,cp as ge,aZ as ve,cq as we,a0 as V}from"./vendor-react-CCFRLLzk.js";import{d as f,u as ye,C as T,x as H,h as $,D as K,N as Ne,f as g,z as q,A as G,E as Q,F as Z,y as be,I as L,S as J,i as W,j as X,k as Y,l as P,s as ee,B as se,L as ke,G as Ce}from"./index-CtsYZAzS.js";import{S as u}from"./skeleton-CNtgH3zu.js";import{P as Se}from"./progress-CYuOOZOb.js";import{T as te,a as ae,b as M,c as m,d as re,e as j}from"./table-DM4QjHXT.js";import{Q as le}from"./vendor-appwrite-CuqfvTq9.js";import"./vendor-ui-BA32w1ww.js";import"./vendor-query-j_rPqiug.js";import"./vendor-other-CzBBjgu5.js";import"./vendor-animations-CPHPqPXb.js";const v=void 0,w=void 0;async function De(i,a){const r={success:0,failed:0,total:i.length,errors:[]};for(const c of i)try{const t=await f.getDocument(v,w,c);let l;typeof a=="number"?l=t.price+a:a.type==="percentage"?l=t.price*(1+a.value/100):l=a.value,await f.updateDocument(v,w,c,{price:l}),r.success++}catch(t){r.failed++,r.errors.push({id:c,error:t.message||"Unknown error"})}return r}async function Ae(i,a){const r={success:0,failed:0,total:i.length,errors:[]};for(const c of i)try{await f.updateDocument(v,w,c,{isActive:a}),r.success++}catch(t){r.failed++,r.errors.push({id:c,error:t.message||"Unknown error"})}return r}async function Ee(i){const a={success:0,failed:0,total:i.length,errors:[]};for(const r of i)try{await f.deleteDocument(v,w,r),a.success++}catch(c){a.failed++,a.errors.push({id:r,error:c.message||"Unknown error"})}return a}async function Te(i,a){const r={success:0,failed:0,total:i.length,errors:[]};for(const c of i)try{await f.updateDocument(v,w,c,{categoryId:a}),r.success++}catch(t){r.failed++,r.errors.push({id:c,error:t.message||"Unknown error"})}return r}async function $e(i,a){const r={success:0,failed:0,total:i.length,errors:[]};for(const c of i)try{const t=await f.getDocument(v,w,c);let l;typeof a=="number"?l=t.stock+a:a.type==="add"?l=t.stock+a.value:l=a.value,l=Math.max(0,l),await f.updateDocument(v,w,c,{stock:l}),r.success++}catch(t){r.failed++,r.errors.push({id:c,error:t.message||"Unknown error"})}return r}async function Le(i){try{let a;i&&i.length>0?a=await Promise.all(i.map(l=>f.getDocument(v,w,l))):a=(await f.listDocuments(v,w,[le.limit(1e3)])).documents;const r=["ID","Name","Price","Stock","Category","Status","Created"],c=a.map(l=>[l.$id,l.name,l.price,l.stock,l.category||"",l.isActive?"Active":"Inactive",new Date(l.$createdAt).toLocaleDateString("ar-EG")]);return[r.join(","),...c.map(l=>l.map(d=>`"${d}"`).join(","))].join(`
`)}catch(a){throw console.error("Error exporting products:",a),a}}async function Pe(i){const a={success:0,failed:0,total:0,errors:[]};try{const r=i.trim().split(`
`),c=r[0].split(",").map(t=>t.trim().replace(/"/g,""));for(let t=1;t<r.length;t++){a.total++;try{const l=r[t].split(",").map(n=>n.trim().replace(/"/g,"")),d={};c.forEach((n,N)=>{d[n.toLowerCase()]=l[N]}),await f.createDocument(v,w,"unique()",{name:d.name,price:parseFloat(d.price)||0,stock:parseInt(d.stock)||0,category:d.category||"",isActive:d.status==="Active",description:d.description||"",merchantId:d.merchantid||""}),a.success++}catch(l){a.failed++,a.errors.push({id:`Line ${t+1}`,error:l.message||"Unknown error"})}}}catch(r){a.failed=a.total,a.errors.push({id:"CSV Parsing",error:r.message||"Failed to parse CSV"})}return a}function ze(i,a="products.csv"){const r=new Blob([i],{type:"text/csv;charset=utf-8;"}),c=document.createElement("a"),t=URL.createObjectURL(r);c.setAttribute("href",t),c.setAttribute("download",a),c.style.visibility="hidden",document.body.appendChild(c),c.click(),document.body.removeChild(c)}const Ie=void 0,Be=void 0;function Ge(){const[i,a]=p.useState(!0),[r,c]=p.useState([]),[t,l]=p.useState(new Set),{toast:d}=ye(),[n,N]=p.useState({search:"",category:"all",status:"all",priceMin:"",priceMax:"",stockMin:""}),[x,b]=p.useState({open:!1,action:null}),[U,z]=p.useState(!1),[E,I]=p.useState(null),[R,_]=p.useState(""),[B,F]=p.useState({current:0,total:0});p.useEffect(()=>{O()},[]);const O=async()=>{a(!0);try{const s=await f.listDocuments(Ie,Be,[le.limit(1e3)]);c(s.documents)}catch(s){console.error("Error loading products:",s)}finally{a(!1)}},k=r.filter(s=>!(n.search&&!s.name.toLowerCase().includes(n.search.toLowerCase())||n.category!=="all"&&s.category!==n.category||n.status==="active"&&!s.isActive||n.status==="inactive"&&s.isActive||n.priceMin&&s.price<parseFloat(n.priceMin)||n.priceMax&&s.price>parseFloat(n.priceMax)||n.stockMin&&s.stock<parseInt(n.stockMin)));p.useEffect(()=>{const s=o=>{if(o.ctrlKey&&o.key==="a"&&!o.shiftKey){o.preventDefault();const C=k.map(D=>D.$id);l(new Set(C)),d({title:"تم التحديد",description:`تم تحديد ${C.length} منتج`})}o.key==="Delete"&&t.size>0&&!x.open&&(o.preventDefault(),b({open:!0,action:"delete"})),o.key==="Escape"&&t.size>0&&!x.open&&(o.preventDefault(),l(new Set),d({title:"تم الإلغاء",description:"تم إلغاء التحديد"}))};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[k,t,x.open,d]);const ce=s=>{const o=new Set(t);o.has(s)?o.delete(s):o.add(s),l(o)},ne=()=>{t.size===k.length?l(new Set):l(new Set(k.map(s=>s.$id)))},ie=async()=>{if(t.size!==0){z(!0),I(null),F({current:0,total:t.size});try{const s=Array.from(t),o=50;let C=0,D=0;for(let A=0;A<s.length;A+=o){const S=s.slice(A,A+o);F({current:A,total:s.length});let h;switch(x.action){case"price":h=await De(S,x.value);break;case"stock":h=await $e(S,x.value);break;case"category":h=await Te(S,x.value);break;case"status":h=await Ae(S,x.value);break;case"delete":h=await Ee(S);break;default:return}C+=h.success,D+=h.failed}const y={success:C,failed:D,total:s.length,errors:[]};F({current:s.length,total:s.length}),I(y),y.success>0?(await O(),l(new Set),d({title:"نجح!",description:`تم ${x.action==="delete"?"حذف":"تحديث"} ${y.success} منتج بنجاح${y.failed>0?` (فشل ${y.failed})`:""}`,variant:"default"})):y.failed>0&&d({title:"فشل!",description:`فشل تحديث ${y.failed} منتج`,variant:"destructive"})}catch(s){console.error("Bulk action error:",s),d({title:"خطأ!",description:"حدث خطأ أثناء تنفيذ العملية",variant:"destructive"})}finally{z(!1)}}},oe=async()=>{try{const s=await Le(t.size>0?Array.from(t):void 0);ze(s,`products-${new Date().toISOString().split("T")[0]}.csv`),d({title:"تم التصدير!",description:`تم تصدير ${t.size>0?t.size:r.length} منتج بنجاح`,variant:"default"})}catch(s){console.error("Export error:",s),d({title:"خطأ!",description:"فشل تصدير المنتجات",variant:"destructive"})}},de=s=>{var D;const o=(D=s.target.files)==null?void 0:D[0];if(!o)return;const C=new FileReader;C.onload=async y=>{var S;const A=(S=y.target)==null?void 0:S.result;z(!0);try{const h=await Pe(A);I(h),await O(),h.success>0?d({title:"تم الاستيراد!",description:`تم استيراد ${h.success} منتج بنجاح${h.failed>0?` (فشل ${h.failed})`:""}`,variant:"default"}):d({title:"فشل الاستيراد!",description:"فشل استيراد جميع المنتجات",variant:"destructive"})}catch(h){console.error("Import error:",h),d({title:"خطأ!",description:"فشل استيراد الملف",variant:"destructive"})}finally{z(!1)}},C.readAsText(o)},ue=Array.from(new Set(r.map(s=>s.category).filter(Boolean)));return i?e.jsxs("div",{className:"container mx-auto p-6 space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{className:"h-9 w-64"}),e.jsx(u,{className:"h-4 w-48"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(u,{className:"h-10 w-24"}),e.jsx(u,{className:"h-10 w-24"})]})]}),e.jsxs(T,{children:[e.jsx(H,{children:e.jsx(u,{className:"h-6 w-32"})}),e.jsx($,{children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[...Array(6)].map((s,o)=>e.jsx(u,{className:"h-10"},o))})})]}),e.jsx(T,{children:e.jsx($,{className:"p-0",children:e.jsxs(te,{children:[e.jsx(ae,{children:e.jsxs(M,{children:[e.jsx(m,{className:"w-12",children:e.jsx(u,{className:"h-4 w-4"})}),e.jsx(m,{children:e.jsx(u,{className:"h-4 w-24"})}),e.jsx(m,{children:e.jsx(u,{className:"h-4 w-16"})}),e.jsx(m,{children:e.jsx(u,{className:"h-4 w-16"})}),e.jsx(m,{children:e.jsx(u,{className:"h-4 w-20"})}),e.jsx(m,{children:e.jsx(u,{className:"h-4 w-16"})}),e.jsx(m,{children:e.jsx(u,{className:"h-4 w-20"})})]})}),e.jsx(re,{children:[...Array(10)].map((s,o)=>e.jsxs(M,{children:[e.jsx(j,{children:e.jsx(u,{className:"h-4 w-4"})}),e.jsx(j,{children:e.jsx(u,{className:"h-4 w-32"})}),e.jsx(j,{children:e.jsx(u,{className:"h-4 w-16"})}),e.jsx(j,{children:e.jsx(u,{className:"h-6 w-12"})}),e.jsx(j,{children:e.jsx(u,{className:"h-4 w-20"})}),e.jsx(j,{children:e.jsx(u,{className:"h-6 w-16"})}),e.jsx(j,{children:e.jsx(u,{className:"h-4 w-20"})})]},o))})]})})})]}):e.jsxs("div",{className:"container mx-auto p-6 space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"إدارة المنتجات المتقدمة"}),e.jsxs("p",{className:"text-muted-foreground",children:[k.length," منتج • ",t.size," محدد"]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(K,{children:[e.jsx(Ne,{asChild:!0,children:e.jsx(g,{variant:"outline",size:"icon",title:"اختصارات لوحة المفاتيح",children:e.jsx(he,{className:"w-4 h-4"})})}),e.jsxs(q,{children:[e.jsxs(G,{children:[e.jsx(Q,{children:"اختصارات لوحة المفاتيح"}),e.jsx(Z,{children:"استخدم هذه الاختصارات لإدارة المنتجات بسرعة"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[e.jsx("span",{children:"تحديد الكل"}),e.jsx("kbd",{className:"px-2 py-1 text-xs font-semibold bg-background border rounded",children:"Ctrl + A"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[e.jsx("span",{children:"حذف المحدد"}),e.jsx("kbd",{className:"px-2 py-1 text-xs font-semibold bg-background border rounded",children:"Delete"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[e.jsx("span",{children:"إلغاء التحديد"}),e.jsx("kbd",{className:"px-2 py-1 text-xs font-semibold bg-background border rounded",children:"Escape"})]})]})]})]}),e.jsxs(g,{onClick:oe,variant:"outline",children:[e.jsx(xe,{className:"w-4 h-4 ml-2"}),"تصدير"]}),e.jsxs("label",{children:[e.jsx(g,{variant:"outline",asChild:!0,children:e.jsxs("span",{children:[e.jsx(me,{className:"w-4 h-4 ml-2"}),"استيراد"]})}),e.jsx("input",{type:"file",accept:".csv",onChange:de,className:"hidden"})]})]})]}),t.size>0&&e.jsx(T,{className:"bg-primary/5",children:e.jsx($,{className:"py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"font-medium",children:[t.size," منتج محدد"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>b({open:!0,action:"price"}),children:[e.jsx(je,{className:"w-4 h-4 ml-2"}),"تحديث السعر"]}),e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>b({open:!0,action:"stock"}),children:[e.jsx(pe,{className:"w-4 h-4 ml-2"}),"تحديث المخزون"]}),e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>b({open:!0,action:"status",value:!0}),children:[e.jsx(fe,{className:"w-4 h-4 ml-2"}),"تفعيل"]}),e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>b({open:!0,action:"status",value:!1}),children:[e.jsx(ge,{className:"w-4 h-4 ml-2"}),"إلغاء تفعيل"]}),e.jsxs(g,{size:"sm",variant:"destructive",onClick:()=>b({open:!0,action:"delete"}),children:[e.jsx(ve,{className:"w-4 h-4 ml-2"}),"حذف"]})]})]})})}),e.jsxs(T,{children:[e.jsx(H,{children:e.jsx(be,{children:"التصفية والبحث"})}),e.jsx($,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsx(L,{placeholder:"بحث بالاسم...",value:n.search,onChange:s=>N({...n,search:s.target.value})}),e.jsxs(J,{value:n.category,onValueChange:s=>N({...n,category:s}),children:[e.jsx(W,{children:e.jsx(X,{placeholder:"الفئة"})}),e.jsxs(Y,{children:[e.jsx(P,{value:"all",children:"كل الفئات"}),ue.map(s=>e.jsx(P,{value:s,children:s},s))]})]}),e.jsxs(J,{value:n.status,onValueChange:s=>N({...n,status:s}),children:[e.jsx(W,{children:e.jsx(X,{placeholder:"الحالة"})}),e.jsxs(Y,{children:[e.jsx(P,{value:"all",children:"الكل"}),e.jsx(P,{value:"active",children:"نشط"}),e.jsx(P,{value:"inactive",children:"غير نشط"})]})]}),e.jsx(L,{type:"number",placeholder:"السعر من",value:n.priceMin,onChange:s=>N({...n,priceMin:s.target.value})}),e.jsx(L,{type:"number",placeholder:"السعر إلى",value:n.priceMax,onChange:s=>N({...n,priceMax:s.target.value})}),e.jsx(L,{type:"number",placeholder:"مخزون أقل من",value:n.stockMin,onChange:s=>N({...n,stockMin:s.target.value})})]})})]}),e.jsx(T,{children:e.jsx($,{className:"p-0",children:e.jsxs(te,{children:[e.jsx(ae,{children:e.jsxs(M,{children:[e.jsx(m,{className:"w-12",children:e.jsx(ee,{checked:t.size===k.length&&k.length>0,onCheckedChange:ne})}),e.jsx(m,{children:"المنتج"}),e.jsx(m,{children:"السعر"}),e.jsx(m,{children:"المخزون"}),e.jsx(m,{children:"الفئة"}),e.jsx(m,{children:"الحالة"}),e.jsx(m,{children:"التاريخ"})]})}),e.jsx(re,{children:k.map(s=>e.jsxs(M,{children:[e.jsx(j,{children:e.jsx(ee,{checked:t.has(s.$id),onCheckedChange:()=>ce(s.$id)})}),e.jsx(j,{className:"font-medium",children:s.name}),e.jsxs(j,{children:[s.price.toFixed(2)," ج.م"]}),e.jsx(j,{children:e.jsx(se,{variant:s.stock>10?"default":"destructive",children:s.stock})}),e.jsx(j,{children:s.category||"-"}),e.jsx(j,{children:e.jsx(se,{variant:s.isActive?"default":"secondary",children:s.isActive?"نشط":"غير نشط"})}),e.jsx(j,{children:new Date(s.$createdAt).toLocaleDateString("ar-EG")})]},s.$id))})]})})}),e.jsx(K,{open:x.open,onOpenChange:s=>b({...x,open:s}),children:e.jsxs(q,{dir:"rtl",children:[e.jsxs(G,{children:[e.jsx(Q,{children:"عملية جماعية"}),e.jsxs(Z,{children:["سيتم تطبيق هذه العملية على ",t.size," منتج"]})]}),E?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-green-600",children:[e.jsx(we,{className:"w-5 h-5"}),e.jsxs("span",{children:["نجح: ",E.success," منتج"]})]}),E.failed>0&&e.jsxs("div",{className:"flex items-center gap-2 text-red-600",children:[e.jsx(V,{className:"w-5 h-5"}),e.jsxs("span",{children:["فشل: ",E.failed," منتج"]})]})]}):U?e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"جاري المعالجة..."}),e.jsxs("span",{children:[B.current," / ",B.total]})]}),e.jsx(Se,{value:B.current/B.total*100,className:"h-2"}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"يتم معالجة المنتجات في مجموعات من 50 منتج لضمان الأداء الأمثل"})]})}):x.action==="delete"?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(V,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"font-semibold text-red-900 dark:text-red-100",children:"⚠️ تحذير: عملية حذف نهائية"}),e.jsxs("p",{className:"text-sm text-red-700 dark:text-red-200",children:["سيتم حذف ",e.jsx("strong",{children:t.size})," منتج نهائياً. هذا الإجراء لا يمكن التراجع عنه!"]})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ke,{htmlFor:"confirm-delete",children:["للتأكيد، اكتب ",e.jsx("strong",{className:"text-red-600",children:"DELETE"})," في الحقل أدناه:"]}),e.jsx(L,{id:"confirm-delete",value:R,onChange:s=>_(s.target.value),placeholder:"اكتب DELETE",className:"text-center font-mono uppercase",autoFocus:!0})]})]}):null,e.jsxs(Ce,{children:[e.jsx(g,{variant:"outline",onClick:()=>{b({open:!1,action:null}),I(null),_("")},children:E?"إغلاق":"إلغاء"}),!E&&e.jsx(g,{onClick:ie,disabled:U||x.action==="delete"&&R!=="DELETE",variant:x.action==="delete"?"destructive":"default",children:U?e.jsx(u,{className:"w-20 h-6 ml-2 inline-block align-middle"}):"تأكيد"})]})]})})]})}export{Ge as default};
