import{r as c,j as e,a2 as H,a7 as K,aT as R,aq as U,ar as _,h as G,aU as W,f as B,e as J,aV as X,aW as Y}from"./vendor-react-BTCGZZAN.js";import{u as Z,a as ee,b as se,d as V,c as f,C as Q,g as ae,B as M,e as u,f as te,I as $,S as ie,h as re,i as le,j as ne,k as ce,l as oe,m as z,L as D,n as de,q as E,p as L}from"./index-DAwEpow4.js";import{S as me,a as xe,b as he,c as ue,d as k}from"./select-DcBOtlUf.js";import{P as ge}from"./LoadingSkeletons-Bxazgn_3.js";import{Q as O}from"./vendor-appwrite-BQhTxLk4.js";import"./vendor-ui-BA32w1ww.js";import"./vendor-query-GexG3wnZ.js";import"./vendor-other-ws_0vYaO.js";import"./vendor-animations-W1Z2cmit.js";import"./skeleton-DOUS7_WT.js";function fe({product:s}){var v;const{toast:o}=Z(),{addItem:y}=ee(),{addFavorite:C,removeFavorite:q,isFavorite:d}=se(),[j,l]=c.useState(!1),[N,m]=c.useState(0),[P,x]=c.useState(!0);c.useEffect(()=>{g()},[s.id]);const r=d(s.id),p=i=>{var t,h,b;i.preventDefault(),i.stopPropagation(),l(!0);try{const S=typeof((t=s.images)==null?void 0:t[0])=="string"?s.images[0]:((b=(h=s.images)==null?void 0:h[0])==null?void 0:b.url)||"";y({productId:s.id,name:s.name,image:S,quantity:1,price:s.price,inStock:!0,stockQuantity:s.stockQuantity||999})}catch{o({title:"خطأ",description:"فشل في إضافة المنتج للسلة",variant:"destructive"})}finally{l(!1)}},n=async i=>{i.preventDefault(),i.stopPropagation();try{r?(await q(s.id),o({title:"✅ تمت الإزالة من المفضلة",description:`تم إزالة ${s.name} من المفضلة`})):(await C(s.id),o({title:"✅ تمت الإضافة للمفضلة",description:`تم إضافة ${s.name} إلى المفضلة`}))}catch(t){console.error("Favorite error:",t),o({title:"❌ خطأ",description:"فشل في تحديث المفضلة. تحقق من تسجيل الدخول.",variant:"destructive"})}},w=async i=>{i.preventDefault(),i.stopPropagation();const t={title:s.name,text:`تحقق من ${s.name} على إيجي جو!`,url:`${window.location.origin}/#/product/${s.id}`};try{navigator.share?await navigator.share(t):(await navigator.clipboard.writeText(t.url),o({title:"✅ تم النسخ",description:"تم نسخ رابط المنتج"}))}catch(h){console.error("Error sharing:",h)}},g=async()=>{try{const i=await V.listDocuments(f.databaseId,f.collections.productViews,[O.equal("productId",s.id)]);if(i.documents.length>0){const t=i.documents[0];m(t.viewCount||0)}}catch(i){console.error("Error loading view count:",i)}finally{x(!1)}},A=async()=>{try{const i=await V.listDocuments(f.databaseId,f.collections.productViews,[O.equal("productId",s.id)]);if(i.documents.length>0){const t=i.documents[0];await V.updateDocument(f.databaseId,f.collections.productViews,t.$id,{viewCount:(t.viewCount||0)+1,lastViewedAt:new Date().toISOString()}),m((t.viewCount||0)+1)}else{const t=await V.createDocument(f.databaseId,f.collections.productViews,"unique()",{productId:s.id,viewCount:1,lastViewedAt:new Date().toISOString(),createdAt:new Date().toISOString()});m(1)}}catch(i){console.error("Error updating view count:",i),m(t=>t+1)}},F=s.originalPrice&&s.originalPrice>s.price?Math.round((s.originalPrice-s.price)/s.originalPrice*100):0;return e.jsx(H,{to:`/product/${s.id}`,className:"block",onClick:A,children:e.jsxs(Q,{className:"group overflow-hidden hover:shadow-xl transition-all duration-300 h-full border-2 hover:border-primary",children:[e.jsxs("div",{className:"relative overflow-hidden",children:[e.jsx("img",{src:ae((v=s.images)==null?void 0:v[0]),alt:s.name,className:"w-full h-56 object-cover group-hover:scale-110 transition-transform duration-500",loading:"lazy"}),e.jsxs("div",{className:"absolute top-3 left-3 flex flex-col gap-2",children:[F>0&&e.jsxs(M,{className:"bg-red-500 text-white shadow-lg",children:["خصم ",F,"%"]}),s.affiliateCommission&&s.affiliateCommission>0&&e.jsxs(M,{className:"bg-gradient-to-r from-orange-500 to-yellow-500 text-white shadow-lg",children:[s.affiliateCommission,"% عمولة"]})]}),e.jsxs("div",{className:"absolute top-3 right-3 flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300",children:[e.jsx(u,{size:"icon",variant:"secondary",className:"rounded-full shadow-lg hover:scale-110 transition-transform",onClick:n,children:e.jsx(K,{className:`h-4 w-4 ${r?"fill-red-500 text-red-500":""}`})}),e.jsx(u,{size:"icon",variant:"secondary",className:"rounded-full shadow-lg hover:scale-110 transition-transform",onClick:w,children:e.jsx(R,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"absolute bottom-3 left-3 bg-black/60 backdrop-blur-sm text-white text-xs px-3 py-1.5 rounded-full flex items-center gap-1",children:[e.jsx(U,{className:"h-3 w-3"}),N]})]}),e.jsxs(te,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex",children:[...Array(5)].map((i,t)=>e.jsx(_,{className:`h-4 w-4 ${t<Math.floor(s.rating)?"text-yellow-400 fill-current":"text-gray-300"}`},t))}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",s.reviewCount||0,")"]})]}),e.jsx("h3",{className:"font-bold text-lg line-clamp-2 group-hover:text-primary transition-colors",children:s.name}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.description}),e.jsxs("div",{className:"flex items-center justify-between pt-2",children:[e.jsx("div",{className:"space-y-1",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-2xl font-bold text-primary",children:[s.price.toFixed(2)," ج.م"]}),s.originalPrice&&s.originalPrice>s.price&&e.jsxs("span",{className:"text-sm text-muted-foreground line-through",children:[s.originalPrice.toFixed(2)," ج.م"]})]})}),e.jsx(u,{size:"sm",onClick:p,disabled:j,className:"group-hover:scale-105 transition-transform",children:j?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"}):e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"h-4 w-4 ml-1 rtl:ml-0 rtl:mr-1"}),"أضف"]})})]})]})]})})}function Pe(){const{slug:s}=W(),[o,y]=c.useState(""),[C,q]=c.useState("featured"),[d,j]=c.useState([]),[l,N]=c.useState({min:0,max:1e3}),[m,P]=c.useState(!1),[x,r]=c.useState(1),p=12,{data:n}=B({queryKey:E.categories,queryFn:de.getAll}),w=c.useMemo(()=>{const a={page:x,limit:p,sortBy:C};if(o&&(a.searchQuery=o),!s&&d.length>0&&d[0]){const I=n==null?void 0:n.categories.find(T=>T.id===d[0]);I&&(a.categoryId=I.id)}return l.min>0&&(a.minPrice=l.min),l.max<1e3&&(a.maxPrice=l.max),a},[s,o,C,d,l,m,x,n]),{data:g,isLoading:A,error:F}=B({queryKey:s?[...E.categoryProducts(s),w]:[...E.products,w],queryFn:()=>s?L.getByCategory(s,w):L.getAll(w)}),v=s?n==null?void 0:n.categories.find(a=>a.slug===s):null,i=(n==null?void 0:n.categories)||[],t=(g==null?void 0:g.products)||[],h=(g==null?void 0:g.total)||0,b=c.useMemo(()=>m?t.filter(a=>a.originalPrice&&a.originalPrice>a.price):t,[t,m]),S=()=>e.jsxs("div",{className:"space-y-6",children:[!s&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"الفئات"}),e.jsx("div",{className:"space-y-2",children:i.map(a=>e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx(z,{id:a.id,checked:d.includes(a.id),onCheckedChange:I=>{j(I?[...d,a.id]:d.filter(T=>T!==a.id)),r(1)}}),e.jsxs(D,{htmlFor:a.id,className:"text-sm cursor-pointer",children:[a.name," (",a.productCount,")"]})]},a.id))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"نطاق السعر"}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx($,{type:"number",placeholder:"الحد الأدنى",value:l.min,onChange:a=>{N({...l,min:Number(a.target.value)||0}),r(1)},className:"w-24"}),e.jsx("span",{className:"self-center",children:"-"}),e.jsx($,{type:"number",placeholder:"الحد الأقصى",value:l.max,onChange:a=>{N({...l,max:Number(a.target.value)||1e3}),r(1)},className:"w-24"})]})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-3",children:"العروض الخاصة"}),e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx(z,{id:"on-sale",checked:m,onCheckedChange:a=>{P(!!a),r(1)}}),e.jsx(D,{htmlFor:"on-sale",className:"text-sm cursor-pointer",children:"المنتجات المخفضة فقط"})]})]}),e.jsx(u,{variant:"outline",onClick:()=>{j([]),N({min:0,max:1e3}),P(!1),y(""),r(1)},className:"w-full",children:"مسح جميع المرشحات"})]});return A?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(ge,{count:p})}):F?e.jsxs("div",{className:"container mx-auto px-4 py-16 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"حدث خطأ"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"فشل في تحميل المنتجات"}),e.jsx(u,{onClick:()=>window.location.reload(),children:"إعادة المحاولة"})]}):e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl lg:text-4xl font-bold mb-2",children:v?v.name:"جميع المنتجات"}),e.jsx("p",{className:"text-muted-foreground",children:v?`اكتشف منتجات ${v.name} المذهلة`:"اكتشف مجموعتنا الكاملة من المنتجات عالية الجودة"})]}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4 mb-8",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(J,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4 rtl:right-3 rtl:left-auto"}),e.jsx($,{type:"search",placeholder:"البحث عن المنتجات...",className:"pr-10 rtl:pr-10 rtl:pl-4",value:o,onChange:a=>{y(a.target.value),r(1)}})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(me,{value:C,onValueChange:a=>{q(a),r(1)},children:[e.jsx(xe,{className:"w-48",children:e.jsx(he,{placeholder:"ترتيب حسب"})}),e.jsxs(ue,{children:[e.jsx(k,{value:"featured",children:"مميز"}),e.jsx(k,{value:"price_asc",children:"السعر: من الأقل إلى الأعلى"}),e.jsx(k,{value:"price_desc",children:"السعر: من الأعلى إلى الأقل"}),e.jsx(k,{value:"rating",children:"الأعلى تقييمًا"}),e.jsx(k,{value:"newest",children:"الأحدث"})]})]}),e.jsxs(ie,{children:[e.jsx(re,{asChild:!0,children:e.jsxs(u,{variant:"outline",className:"lg:hidden",children:[e.jsx(X,{className:"h-4 w-4 ml-2 rtl:ml-0 rtl:mr-2"}),"المرشحات"]})}),e.jsxs(le,{side:"right",className:"w-80",children:[e.jsx(ne,{children:e.jsx(ce,{children:"المرشحات"})}),e.jsx("div",{className:"mt-6",children:e.jsx(S,{})})]})]})]})]}),e.jsxs("div",{className:"grid lg:grid-cols-4 gap-8",children:[e.jsx("div",{className:"hidden lg:block",children:e.jsxs(Q,{className:"p-6 sticky top-24",children:[e.jsxs("h2",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(Y,{className:"h-4 w-4"}),"المرشحات"]}),e.jsx(oe,{className:"mb-4"}),e.jsx(S,{})]})}),e.jsxs("div",{className:"lg:col-span-3",children:[e.jsx("div",{className:"mb-4 flex justify-between items-center",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["عرض ",b.length," من ",h," منتج"]})}),b.length===0?e.jsxs(Q,{className:"p-12 text-center",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"لم يتم العثور على منتجات"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"جرب تعديل البحث أو معايير التصفية"}),e.jsx(u,{variant:"outline",onClick:()=>{j([]),N({min:0,max:1e3}),P(!1),y(""),r(1)},children:"مسح المرشحات"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6",children:b.map(a=>e.jsx(fe,{product:a},a.id))}),h>p&&e.jsxs("div",{className:"flex justify-center items-center gap-2 mt-8",children:[e.jsx(u,{variant:"outline",disabled:x===1,onClick:()=>r(x-1),children:"السابق"}),e.jsxs("span",{className:"px-4 py-2",children:["صفحة ",x," من ",Math.ceil(h/p)]}),e.jsx(u,{variant:"outline",disabled:x>=Math.ceil(h/p),onClick:()=>r(x+1),children:"التالي"})]})]})]})]})]})}export{Pe as default};
