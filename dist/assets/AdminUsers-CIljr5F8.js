import{w as _,b as G,r as t,a8 as h,a0 as D,j as e,C as K,e as V,f as W,aw as X,g as Y,aE as Z,I as u,B as l,T as ee,s as x,a9 as j,$ as R,a as se}from"./index-Ce-RwxJS.js";import{A as ae}from"./AdminLayout-DRAN_nM7.js";import{S as re}from"./square-pen-BvEjHzCI.js";import"./tag-BB9opunb.js";import"./settings-DdUeHZqS.js";const v=void 0;function de(){const{user:te}=_(),{toast:o}=G(),[T,U]=t.useState([]),[$,y]=t.useState(!1),[p,A]=t.useState(""),[g,M]=t.useState("all"),[F,N]=t.useState(!1),[n,b]=t.useState(null),[a,c]=t.useState({name:"",email:"",phone:"",role:"customer"}),[L,w]=t.useState(!1),[d,C]=t.useState(null),[I,S]=t.useState("20");t.useEffect(()=>{m()},[]);const m=async()=>{y(!0);try{const s=await h.listDocuments(v,"userPreferences",[D.limit(100),D.orderDesc("$createdAt")]);console.log("✅ Loaded users:",s.documents.length),U(s.documents)}catch(s){console.error("Error loading users:",s),o({title:"خطأ",description:"فشل تحميل المستخدمين",variant:"destructive"})}finally{y(!1)}},P=s=>{console.log("Opening edit modal for:",s.name),b(s),c({name:s.name||"",email:s.email||"",phone:s.phone||"",role:s.role||"customer"}),N(!0)},E=()=>{N(!1),b(null),c({name:"",email:"",phone:"",role:"customer"})},O=async()=>{if(n)try{if(a.role!==n.role){if(!(await fetch("/api/admin/update-user-role",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:n.userId,newRole:a.role})})).ok)throw new Error("Failed to update user role");console.log("✅ Role updated via server API")}const s={name:a.name,email:a.email,phone:a.phone||""};if(a.role===n.role&&(s.role=a.role),await h.updateDocument(v,"userPreferences",n.$id,s),a.role!==n.role){const r={customer:"عميل",merchant:"تاجر",affiliate:"مسوق",intermediary:"وسيط",admin:"مدير"},i=r[n.role]||n.role,f=r[a.role]||a.role;try{await h.createDocument(j.databaseId,j.collections.notifications,R.unique(),{userId:n.userId,title:"🎉 تم تحديث دورك بنجاح",message:`تم تغيير دورك من ${i} إلى ${f}. يمكنك الآن الوصول إلى المميزات الجديدة!`,type:"success",isRead:!1,link:a.role==="merchant"?"/merchant/dashboard":a.role==="affiliate"?"/affiliate/dashboard":a.role==="intermediary"?"/intermediary/dashboard":a.role==="admin"?"/admin/dashboard":"/"}),console.log("✅ Role change notification sent")}catch(Q){console.error("Error sending notification:",Q)}}o({title:"نجح",description:"تم تحديث بيانات المستخدم بنجاح"}),E(),m()}catch(s){console.error("Error updating user:",s),o({title:"خطأ",description:"فشل تحديث بيانات المستخدم",variant:"destructive"})}},z=s=>{console.log("Opening intermediary modal for:",s.name),C(s),w(!0)},k=()=>{w(!1),C(null),S("20")},B=async()=>{if(d)try{const s=await fetch("/api/admin/update-user-role",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:d.userId,newRole:"intermediary"})});if(!s.ok)throw new Error("Failed to activate intermediary");const i=(await s.json()).intermediaryCode||`INT${Date.now()}`;console.log("✅ Intermediary activated via server API");try{await h.createDocument(j.databaseId,j.collections.notifications,R.unique(),{userId:d.userId,title:"🎉 مبروك! تم تفعيلك كوسيط",message:`تم تفعيل حسابك كوسيط بنجاح! كود الوسيط الخاص بك: ${i}. نسبة الهامش الافتراضية: ${I}%. يمكنك الآن إنشاء روابط خاصة بك وإضافة هامش ربح على المنتجات.`,type:"success",isRead:!1,link:"/intermediary/dashboard"}),console.log("✅ Intermediary activation notification sent")}catch(f){console.error("Error sending notification:",f)}o({title:"نجح",description:`تم تفعيل ${d.name} كوسيط بنجاح`}),k(),m()}catch(s){console.error("Error activating intermediary:",s),o({title:"خطأ",description:"فشل تفعيل الوسيط",variant:"destructive"})}},q=async(s,r)=>{if(confirm(`هل أنت متأكد من حذف ${r}؟`))try{await h.deleteDocument(v,"userPreferences",s),o({title:"نجح",description:"تم حذف المستخدم بنجاح"}),m()}catch(i){console.error("Error deleting user:",i),o({title:"خطأ",description:"فشل حذف المستخدم",variant:"destructive"})}},J=s=>{const r={admin:"bg-red-100 text-red-800",intermediary:"bg-purple-100 text-purple-800",merchant:"bg-blue-100 text-blue-800",affiliate:"bg-green-100 text-green-800",customer:"bg-gray-100 text-gray-800"},i={admin:"مدير",intermediary:"وسيط",merchant:"تاجر",affiliate:"مسوق",customer:"عميل"};return e.jsx(se,{className:r[s]||r.customer,children:i[s]||s})},H=T.filter(s=>{const r=s.name?.toLowerCase().includes(p.toLowerCase())||s.email?.toLowerCase().includes(p.toLowerCase())||s.phone?.includes(p),i=g==="all"||s.role===g;return r&&i});return e.jsxs(ae,{children:[e.jsxs(K,{children:[e.jsx(V,{children:e.jsxs(W,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-6 w-6"}),"إدارة المستخدمين والشركاء"]})}),e.jsxs(Y,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(u,{placeholder:"بحث بالاسم أو البريد أو الهاتف...",value:p,onChange:s=>A(s.target.value),className:"pl-10"})]}),e.jsx("div",{children:e.jsxs("select",{className:"w-full p-2 border rounded-md",value:g,onChange:s=>M(s.target.value),children:[e.jsx("option",{value:"all",children:"جميع الأدوار"}),e.jsx("option",{value:"customer",children:"عملاء"}),e.jsx("option",{value:"merchant",children:"تجار"}),e.jsx("option",{value:"affiliate",children:"مسوقين"}),e.jsx("option",{value:"intermediary",children:"وسطاء"}),e.jsx("option",{value:"admin",children:"مدراء"})]})}),e.jsx(l,{onClick:()=>m(),variant:"outline",children:"تحديث القائمة"})]}),$?e.jsx("div",{className:"text-center py-8",children:"جاري التحميل..."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-right p-2",children:"الاسم"}),e.jsx("th",{className:"text-right p-2",children:"البريد"}),e.jsx("th",{className:"text-right p-2",children:"الهاتف"}),e.jsx("th",{className:"text-right p-2",children:"الدور"}),e.jsx("th",{className:"text-right p-2",children:"الكود"}),e.jsx("th",{className:"text-right p-2",children:"الإجراءات"})]})}),e.jsx("tbody",{children:H.map(s=>e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"p-2",children:s.name}),e.jsx("td",{className:"p-2",children:s.email}),e.jsx("td",{className:"p-2",children:s.phone||"-"}),e.jsx("td",{className:"p-2",children:J(s.role)}),e.jsx("td",{className:"p-2",children:e.jsx("code",{className:"text-xs bg-gray-100 px-2 py-1 rounded",children:s.affiliateCode||s.intermediaryCode||"-"})}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex gap-2",children:[s.role==="customer"&&!s.isIntermediary&&e.jsx(l,{size:"sm",className:"bg-purple-600 hover:bg-purple-700 text-white",onClick:()=>z(s),children:"تفعيل وسيط"}),e.jsx(l,{size:"sm",variant:"outline",onClick:()=>P(s),children:e.jsx(re,{className:"h-4 w-4"})}),e.jsx(l,{size:"sm",variant:"destructive",onClick:()=>q(s.$id,s.name),children:e.jsx(ee,{className:"h-4 w-4"})})]})})]},s.$id))})]})})]})]}),F&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"تعديل بيانات المستخدم"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(x,{children:"الاسم"}),e.jsx(u,{value:a.name,onChange:s=>c({...a,name:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(x,{children:"البريد الإلكتروني"}),e.jsx(u,{type:"email",value:a.email,onChange:s=>c({...a,email:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(x,{children:"رقم الهاتف"}),e.jsx(u,{value:a.phone,onChange:s=>c({...a,phone:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(x,{children:"الدور"}),e.jsxs("select",{className:"w-full p-2 border rounded-md",value:a.role,onChange:s=>c({...a,role:s.target.value}),children:[e.jsx("option",{value:"customer",children:"عميل"}),e.jsx("option",{value:"merchant",children:"تاجر"}),e.jsx("option",{value:"affiliate",children:"مسوق"}),e.jsx("option",{value:"intermediary",children:"وسيط"}),e.jsx("option",{value:"admin",children:"مدير"})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-6",children:[e.jsx(l,{onClick:E,variant:"outline",children:"إلغاء"}),e.jsx(l,{onClick:O,children:"حفظ التغييرات"})]})]})}),L&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"تفعيل دور الوسيط"}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg mb-4",children:[e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"العميل:"})," ",d?.name]}),e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"البريد:"})," ",d?.email]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx(x,{children:"نسبة الهامش الافتراضية (%)"}),e.jsx(u,{type:"number",min:"0",max:"100",value:I,onChange:s=>S(s.target.value),placeholder:"20"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"النسبة التي سيتم إضافتها على سعر المنتج الأصلي"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(l,{onClick:k,variant:"outline",children:"إلغاء"}),e.jsx(l,{onClick:B,className:"bg-purple-600 hover:bg-purple-700",children:"تفعيل الوسيط"})]})]})})]})}export{de as default};
