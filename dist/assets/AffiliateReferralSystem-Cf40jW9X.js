import{r as f,j as e,U as C,bZ as Q,_ as re,p as M,bl as H,bG as te,ba as V,bS as W,bC as z,a_ as I,aA as v,bz as ae}from"./vendor-react-CCFRLLzk.js";import{d as g,e as o,c as le,u as ne,C as j,h as p,x as O,y as q,I as Y,f as S,B as E}from"./index-D-h96Znd.js";import{T as ce,a as ie,b as B,c as F}from"./tabs-LmPLZOOP.js";import{Q as i,I as oe}from"./vendor-appwrite-CuqfvTq9.js";import{aI as de}from"./vendor-other-CzBBjgu5.js";import"./vendor-ui-BA32w1ww.js";import"./vendor-query-j_rPqiug.js";import"./vendor-animations-CPHPqPXb.js";const k={SIGNUP_BONUS:50,FIRST_PURCHASE_BONUS:100,COMMISSION_PERCENTAGE:10},G={PENDING:"pending",ACTIVE:"active",COMPLETED:"completed"};async function me(s,m,h){try{const n=await g.listDocuments(o.databaseId,o.collections.referrals,[i.equal("referredUserId",s),i.equal("status",G.PENDING),i.limit(1)]);if(n.documents.length===0)return console.log("No pending referral found for user:",s),null;const x=n.documents[0];return await g.updateDocument(o.databaseId,o.collections.referrals,x.$id,{status:G.ACTIVE,reward:k.FIRST_PURCHASE_BONUS,completedAt:new Date().toISOString()}),await Z({referrerId:x.referrerId,referredUserId:s,orderId:m,amount:k.FIRST_PURCHASE_BONUS,percentage:0,level:1,type:"first_purchase",status:"completed"}),console.log("✅ First purchase handled successfully"),x}catch(n){throw console.error("Error handling first purchase:",n),n}}async function xe(s,m,h){try{const n=await g.listDocuments(o.databaseId,o.collections.referrals,[i.equal("referredUserId",s),i.equal("status",G.ACTIVE),i.limit(1)]);if(n.documents.length===0)return console.log("No active referral found for user:",s),null;const x=n.documents[0],d=h*k.COMMISSION_PERCENTAGE/100;return await Z({referrerId:x.referrerId,referredUserId:s,orderId:m,amount:d,percentage:k.COMMISSION_PERCENTAGE,level:1,type:"commission",status:"pending"}),console.log("✅ Purchase commission handled successfully"),{referral:x,commission:d}}catch(n){throw console.error("Error handling purchase commission:",n),n}}async function Z(s){try{const m=await g.createDocument(o.databaseId,o.collections.referral_earnings||"referral_earnings",oe.unique(),{referrerId:s.referrerId,referredUserId:s.referredUserId,orderId:s.orderId||null,amount:s.amount,percentage:s.percentage,level:s.level,type:s.type,status:s.status,createdAt:new Date().toISOString()});return console.log("✅ Earning record created:",m.$id),m}catch(m){throw console.error("Error creating earning record:",m),m}}function ue(){const{user:s}=le(),[m,h]=f.useState(!0),[n,x]=f.useState([]),[d,w]=f.useState([]),[A,D]=f.useState({totalReferrals:0,activeReferrals:0,completedReferrals:0,totalEarnings:0,pendingEarnings:0,thisMonthReferrals:0,thisMonthEarnings:0}),[R,T]=f.useState(""),[P,U]=f.useState(""),N=async()=>{if(s){h(!0);try{const a=(await g.listDocuments(o.databaseId,o.collections.referrals,[i.equal("referrerId",s.$id),i.orderDesc("$createdAt"),i.limit(100)])).documents;x(a);const c=(await g.listDocuments(o.databaseId,o.collections.referral_earnings||"referral_earnings",[i.equal("referrerId",s.$id),i.orderDesc("$createdAt"),i.limit(100)])).documents;w(c),r(a,c),await _()}catch(t){console.error("Error loading referral data:",t)}finally{h(!1)}}},_=async()=>{if(s)try{const t=await g.listDocuments(o.databaseId,o.collections.userPreferences,[i.equal("userId",s.$id),i.limit(1)]);if(t.documents.length>0){const a=t.documents[0].affiliateCode;T(a),U(`${window.location.origin}/register?ref=${a}`)}}catch(t){console.error("Error loading affiliate code:",t)}},r=(t,a)=>{const u=new Date,c=new Date(u.getFullYear(),u.getMonth(),1),b={totalReferrals:t.length,activeReferrals:t.filter(l=>l.status==="active").length,completedReferrals:t.filter(l=>l.status==="completed").length,totalEarnings:a.filter(l=>l.status==="completed"||l.status==="paid").reduce((l,y)=>l+y.amount,0),pendingEarnings:a.filter(l=>l.status==="pending").reduce((l,y)=>l+y.amount,0),thisMonthReferrals:t.filter(l=>new Date(l.$createdAt)>=c).length,thisMonthEarnings:a.filter(l=>(l.status==="completed"||l.status==="paid")&&new Date(l.$createdAt)>=c).reduce((l,y)=>l+y.amount,0)};D(b)},$=async(t,a,u,c)=>{try{return console.log("registerWithReferral: Use Register.tsx directly"),{success:!0}}catch(b){throw console.error("Error registering with referral:",b),b}},L=async(t,a,u)=>{try{const c=await me(t,a,u);return await N(),c}catch(c){throw console.error("Error handling first purchase:",c),c}},J=async(t,a,u)=>{try{const c=await xe(t,a,u);return await N(),c}catch(c){throw console.error("Error handling purchase commission:",c),c}},K=async t=>{try{const a=await g.listDocuments(o.databaseId,o.collections.userPreferences,[i.equal("affiliateCode",t),i.limit(1)]);return a.documents.length>0?a.documents[0]:null}catch(a){return console.error("Error getting referral by code:",a),null}},X=t=>d.filter(a=>a.type===t),ee=t=>d.filter(a=>a.level===t),se=(t,a)=>{const u=new Date(t,a-1,1),c=new Date(t,a,0);return d.filter(b=>{const l=new Date(b.$createdAt);return l>=u&&l<=c})};return f.useEffect(()=>{s&&N()},[s]),{loading:m,referrals:n,earnings:d,stats:A,affiliateCode:R,referralLink:P,loadReferralData:N,registerWithReferral:$,handleFirstPurchase:L,handlePurchaseCommission:J,getReferralByCode:K,getEarningsByType:X,getEarningsByLevel:ee,getEarningsByMonth:se}}function ye(){const{toast:s}=ne(),{loading:m,referrals:h,stats:n,affiliateCode:x,referralLink:d}=ue(),[w,A]=f.useState("");f.useEffect(()=>{d&&D()},[d]);const D=async()=>{try{const r=await de.toDataURL(d,{width:300,margin:2,color:{dark:"#000000",light:"#ffffff"}});A(r)}catch(r){console.error("Error generating QR code:",r)}},R=()=>{navigator.clipboard.writeText(d),s({title:"✅ تم النسخ",description:"تم نسخ رابط الإحالة"})},T=()=>{navigator.clipboard.writeText(x),s({title:"✅ تم النسخ",description:"تم نسخ كود الإحالة"})},P=async()=>{if(navigator.share)try{await navigator.share({title:"انضم إلى EgyGo",text:`استخدم كود الإحالة الخاص بي: ${x}`,url:d})}catch(r){console.error("Error sharing:",r)}else R()},U=()=>{const r=document.createElement("a");r.download=`referral-qr-${x}.png`,r.href=w,r.click()},N=r=>{switch(r){case"pending":return e.jsxs(E,{variant:"outline",className:"bg-yellow-50",children:[e.jsx(ae,{className:"h-3 w-3 mr-1"}),"قيد الانتظار"]});case"active":return e.jsxs(E,{variant:"outline",className:"bg-blue-50",children:[e.jsx(Q,{className:"h-3 w-3 mr-1"}),"نشط"]});case"completed":return e.jsxs(E,{variant:"outline",className:"bg-green-50",children:[e.jsx(I,{className:"h-3 w-3 mr-1"}),"مكتمل"]});default:return e.jsx(E,{variant:"outline",children:r})}},_=r=>{const $=["bg-bronze","bg-silver","bg-gold","bg-platinum"],L=["المستوى 1","المستوى 2","المستوى 3","المستوى 4"];return e.jsx(E,{className:$[r-1]||"bg-gray-500",children:L[r-1]||`المستوى ${r}`})};return m?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):e.jsxs("div",{className:"container mx-auto p-6 space-y-6",dir:"rtl",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(C,{className:"h-8 w-8"}),"نظام الإحالة"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"احصل على مكافآت عند دعوة أصدقائك"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(j,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"إجمالي الإحالات"}),e.jsx("p",{className:"text-3xl font-bold",children:n.totalReferrals})]}),e.jsx(C,{className:"h-12 w-12 text-blue-500 opacity-20"})]})})}),e.jsx(j,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"إحالات نشطة"}),e.jsx("p",{className:"text-3xl font-bold text-blue-600",children:n.activeReferrals})]}),e.jsx(Q,{className:"h-12 w-12 text-blue-500 opacity-20"})]})})}),e.jsx(j,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"إجمالي الأرباح"}),e.jsxs("p",{className:"text-3xl font-bold text-green-600",children:[n.totalEarnings," ج.م"]})]}),e.jsx(re,{className:"h-12 w-12 text-green-500 opacity-20"})]})})}),e.jsx(j,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"أرباح هذا الشهر"}),e.jsxs("p",{className:"text-3xl font-bold text-purple-600",children:[n.thisMonthEarnings," ج.م"]})]}),e.jsx(M,{className:"h-12 w-12 text-purple-500 opacity-20"})]})})})]}),e.jsxs(j,{children:[e.jsx(O,{children:e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(H,{className:"h-5 w-5"}),"أدوات الإحالة"]})}),e.jsx(p,{children:e.jsxs(ce,{defaultValue:"link",className:"w-full",children:[e.jsxs(ie,{className:"grid w-full grid-cols-3",children:[e.jsxs(B,{value:"link",children:[e.jsx(te,{className:"h-4 w-4 mr-1"}),"الرابط"]}),e.jsxs(B,{value:"code",children:[e.jsx(V,{className:"h-4 w-4 mr-1"}),"الكود"]}),e.jsxs(B,{value:"qr",children:[e.jsx(W,{className:"h-4 w-4 mr-1"}),"QR Code"]})]}),e.jsxs(F,{value:"link",className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"رابط الإحالة الخاص بك"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Y,{value:d,readOnly:!0,className:"font-mono text-sm"}),e.jsx(S,{onClick:R,variant:"outline",children:e.jsx(z,{className:"h-4 w-4"})}),e.jsx(S,{onClick:P,children:e.jsx(H,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"شارك هذا الرابط مع أصدقائك للحصول على مكافآت"})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg",children:[e.jsxs("h3",{className:"font-semibold mb-2 flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 text-blue-600"}),"المكافآت"]}),e.jsxs("ul",{className:"space-y-2 text-sm",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{children:"50 ج.م عند تسجيل صديقك"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{children:"100 ج.م عند أول عملية شراء"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{children:"5% من مشتريات صديقك مدى الحياة"})]})]})]})]}),e.jsxs(F,{value:"code",className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"كود الإحالة الخاص بك"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Y,{value:x,readOnly:!0,className:"font-mono text-2xl font-bold text-center"}),e.jsx(S,{onClick:T,variant:"outline",children:e.jsx(z,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"يمكن لأصدقائك إدخال هذا الكود عند التسجيل"})]}),e.jsxs("div",{className:"bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"كيفية الاستخدام:"}),e.jsxs("ol",{className:"space-y-2 text-sm list-decimal list-inside",children:[e.jsx("li",{children:"شارك الكود مع أصدقائك"}),e.jsx("li",{children:"يقوم صديقك بالتسجيل في الموقع"}),e.jsx("li",{children:'يدخل الكود في حقل "كود الإحالة"'}),e.jsx("li",{children:"تحصل على المكافأة فوراً!"})]})]})]}),e.jsx(F,{value:"qr",className:"space-y-4",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[w&&e.jsx("img",{src:w,alt:"QR Code",className:"border-4 border-gray-200 rounded-lg"}),e.jsxs(S,{onClick:U,className:"w-full max-w-xs",children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"تحميل QR Code"]}),e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"اطبع هذا الكود أو شاركه على وسائل التواصل الاجتماعي"})]})})]})})]}),e.jsxs(j,{children:[e.jsx(O,{children:e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(v,{className:"h-5 w-5"}),"إحالاتي (",h.length,")"]})}),e.jsx(p,{children:h.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(C,{className:"h-16 w-16 mx-auto text-muted-foreground opacity-20 mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"لا توجد إحالات بعد"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"ابدأ بمشاركة رابط الإحالة مع أصدقائك"})]}):e.jsx("div",{className:"space-y-4",children:h.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-accent/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(C,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:r.referredUserName}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r.referredUserEmail}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:new Date(r.createdAt).toLocaleDateString("ar-EG")})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[_(r.level),N(r.status),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"المكافأة"}),e.jsxs("p",{className:"text-lg font-bold text-green-600",children:[r.reward," ج.م"]})]})]})]},r.$id))})})]}),e.jsxs(j,{children:[e.jsx(O,{children:e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"h-5 w-5"}),"مستويات الإحالة"]})}),e.jsxs(p,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"p-4 border rounded-lg bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/20 dark:to-orange-800/20",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(v,{className:"h-5 w-5 text-orange-600"}),e.jsx("h3",{className:"font-bold",children:"المستوى 1"})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"الإحالة المباشرة"}),e.jsx("p",{className:"text-2xl font-bold text-orange-600",children:"50 ج.م"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"+ 5% من المشتريات"})]}),e.jsxs("div",{className:"p-4 border rounded-lg bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900/20 dark:to-gray-800/20",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(v,{className:"h-5 w-5 text-gray-600"}),e.jsx("h3",{className:"font-bold",children:"المستوى 2"})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"إحالة الإحالة"}),e.jsx("p",{className:"text-2xl font-bold text-gray-600",children:"25 ج.م"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"+ 2.5% من المشتريات"})]}),e.jsxs("div",{className:"p-4 border rounded-lg bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-900/20 dark:to-yellow-800/20",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(v,{className:"h-5 w-5 text-yellow-600"}),e.jsx("h3",{className:"font-bold",children:"المستوى 3"})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"المستوى الثالث"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:"10 ج.م"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"+ 1% من المشتريات"})]}),e.jsxs("div",{className:"p-4 border rounded-lg bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(v,{className:"h-5 w-5 text-purple-600"}),e.jsx("h3",{className:"font-bold",children:"المستوى 4"})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"المستوى الرابع"}),e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:"5 ج.م"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"+ 0.5% من المشتريات"})]})]}),e.jsxs("div",{className:"mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg",children:[e.jsxs("h3",{className:"font-semibold mb-2 flex items-center gap-2",children:[e.jsx(M,{className:"h-5 w-5 text-blue-600"}),"كيف يعمل نظام المستويات؟"]}),e.jsxs("ul",{className:"space-y-2 text-sm",children:[e.jsxs("li",{children:["• ",e.jsx("strong",{children:"المستوى 1:"})," الأشخاص الذين تحيلهم مباشرة"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"المستوى 2:"})," الأشخاص الذين يحيلهم أصدقاؤك"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"المستوى 3:"})," الأشخاص الذين يحيلهم أصدقاء أصدقائك"]}),e.jsxs("li",{children:["• ",e.jsx("strong",{children:"المستوى 4:"})," المستوى الرابع من الإحالات"]})]})]})]})]})]})}export{ye as default};
