import{r as t,j as e,a0 as M,af as E,ax as F,bX as U,a_ as N,bA as b,bz as W}from"./vendor-react-CCFRLLzk.js";import{u as J,d as j,e as n,B as p,C as R,h as $,L as B,S as K,i as Y,j as Z,k as P,l as u,g as w,f as x,D as ee,z as se,A as ae,E as re,F as te,T as ne,G as ie}from"./index-CtsYZAzS.js";import{Q as y,I as le}from"./vendor-appwrite-CuqfvTq9.js";import{T as ce,a as de,b as L,c as i,d as oe,e as l}from"./table-DM4QjHXT.js";import"./vendor-ui-BA32w1ww.js";import"./vendor-query-j_rPqiug.js";import"./vendor-other-CzBBjgu5.js";import"./vendor-animations-CPHPqPXb.js";function fe(){const[g,V]=t.useState([]),[z,C]=t.useState(!0),[a,q]=t.useState(null),[O,h]=t.useState(!1),[r,H]=t.useState("approve"),[o,D]=t.useState(""),[v,S]=t.useState(!1),[c,G]=t.useState("pending"),{toast:m}=J();t.useEffect(()=>{I()},[c]);const I=async()=>{try{C(!0);const s=[y.orderDesc("$createdAt"),y.limit(100)];c!=="all"&&s.push(y.equal("status",c));const d=await j.listDocuments(n.databaseId,n.collections.products,s),_=await Promise.all(d.documents.map(async f=>{try{const A=await j.getDocument(n.databaseId,n.collections.users,f.merchantId);return{...f,merchantName:A.name||A.email}}catch{return{...f,merchantName:"غير معروف"}}}));V(_)}catch(s){console.error("Error loading products:",s),m({title:"خطأ",description:"فشل تحميل المنتجات",variant:"destructive"})}finally{C(!1)}},T=(s,d)=>{q(s),H(d),D(""),h(!0)},Q=async()=>{if(a){if(r==="reject"&&!o.trim()){m({title:"خطأ",description:"يجب إدخال سبب الرفض",variant:"destructive"});return}S(!0);try{await j.updateDocument(n.databaseId,n.collections.products,a.$id,{status:r==="approve"?"approved":"rejected",rejectionReason:r==="reject"?o:null,approvedAt:r==="approve"?new Date().toISOString():null});try{await j.createDocument(n.databaseId,n.collections.notifications,le.unique(),{userId:a.merchantId,type:r==="approve"?"info":"alert",title:r==="approve"?"تمت الموافقة على المنتج":"تم رفض المنتج",message:r==="approve"?`تمت الموافقة على منتج "${a.name}" وهو الآن متاح للعرض`:`تم رفض منتج "${a.name}". السبب: ${o}`,read:!1,relatedId:a.$id})}catch(s){console.error("Error sending notification:",s)}m({title:"✅ تم بنجاح",description:r==="approve"?"تمت الموافقة على المنتج وإرسال إشعار للتاجر":"تم رفض المنتج وإرسال إشعار للتاجر مع السبب"}),h(!1),I()}catch(s){console.error("Error processing approval:",s),m({title:"خطأ",description:"فشل معالجة الطلب",variant:"destructive"})}finally{S(!1)}}},X=s=>{switch(s){case"approved":return e.jsxs(p,{className:"bg-green-500",children:[e.jsx(N,{className:"h-3 w-3 ml-1"}),"موافق عليه"]});case"rejected":return e.jsxs(p,{variant:"destructive",children:[e.jsx(b,{className:"h-3 w-3 ml-1"}),"مرفوض"]});default:return e.jsxs(p,{variant:"secondary",children:[e.jsx(W,{className:"h-3 w-3 ml-1"}),"قيد المراجعة"]})}},k=g.filter(s=>s.status==="pending").length;return e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"مراجعة المنتجات"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"مراجعة والموافقة على المنتجات الجديدة من التجار"})]}),k>0&&e.jsxs(p,{variant:"destructive",className:"text-lg py-2 px-4",children:[e.jsx(M,{className:"h-5 w-5 ml-2"}),k," منتج بانتظار الموافقة"]})]}),e.jsx(R,{className:"mb-6",children:e.jsx($,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(B,{children:"تصفية حسب الحالة:"}),e.jsxs(K,{value:c,onValueChange:G,children:[e.jsx(Y,{className:"w-[200px]",children:e.jsx(Z,{})}),e.jsxs(P,{children:[e.jsx(u,{value:"all",children:"جميع المنتجات"}),e.jsx(u,{value:"pending",children:"قيد المراجعة"}),e.jsx(u,{value:"approved",children:"موافق عليها"}),e.jsx(u,{value:"rejected",children:"مرفوضة"})]})]})]})})}),e.jsx(R,{children:e.jsx($,{className:"p-6",children:z?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(E,{className:"h-8 w-8 animate-spin text-primary"})}):g.length===0?e.jsx("div",{className:"text-center py-12",children:e.jsxs("p",{className:"text-muted-foreground mb-4",children:["لا توجد منتجات ",c!=="all"&&`في حالة "${c}"`]})}):e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(L,{children:[e.jsx(i,{children:"المنتج"}),e.jsx(i,{children:"التاجر"}),e.jsx(i,{children:"السعر"}),e.jsx(i,{children:"الفيديو"}),e.jsx(i,{children:"الحالة"}),e.jsx(i,{children:"التاريخ"}),e.jsx(i,{className:"text-left",children:"الإجراءات"})]})}),e.jsx(oe,{children:g.map(s=>{var d;return e.jsxs(L,{children:[e.jsx(l,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[(d=s.images)!=null&&d[0]?e.jsx("img",{src:w(s.images[0]),alt:s.name,className:"w-12 h-12 object-cover rounded"}):e.jsx("div",{className:"w-12 h-12 bg-gray-200 rounded flex items-center justify-center",children:e.jsx(F,{className:"h-6 w-6 text-gray-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-muted-foreground truncate max-w-[200px]",children:s.description})]})]})}),e.jsx(l,{children:s.merchantName}),e.jsxs(l,{className:"font-bold",children:[s.price," ج.م"]}),e.jsx(l,{children:s.verificationVideo?e.jsxs("a",{href:w(s.verificationVideo),target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-1 text-blue-600 hover:underline",children:[e.jsx(U,{className:"h-4 w-4"}),"مشاهدة"]}):e.jsx("span",{className:"text-muted-foreground text-sm",children:"لا يوجد"})}),e.jsx(l,{children:X(s.status)}),e.jsx(l,{children:s.createdAt?new Date(s.createdAt).toLocaleDateString("ar-EG"):"-"}),e.jsx(l,{className:"text-left",children:e.jsxs("div",{className:"flex gap-2",children:[s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsxs(x,{variant:"default",size:"sm",onClick:()=>T(s,"approve"),className:"bg-green-600 hover:bg-green-700",children:[e.jsx(N,{className:"h-4 w-4 ml-1"}),"موافقة"]}),e.jsxs(x,{variant:"destructive",size:"sm",onClick:()=>T(s,"reject"),children:[e.jsx(b,{className:"h-4 w-4 ml-1"}),"رفض"]})]}),s.status==="rejected"&&s.rejectionReason&&e.jsxs(x,{variant:"outline",size:"sm",onClick:()=>{m({title:"سبب الرفض",description:s.rejectionReason})},children:[e.jsx(F,{className:"h-4 w-4 ml-1"}),"السبب"]})]})})]},s.$id)})})]})})}),e.jsx(ee,{open:O,onOpenChange:h,children:e.jsxs(se,{className:"max-w-2xl",children:[e.jsxs(ae,{children:[e.jsx(re,{children:r==="approve"?"الموافقة على المنتج":"رفض المنتج"}),e.jsx(te,{children:a==null?void 0:a.name})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"تفاصيل المنتج:"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"الاسم:"}),e.jsx("p",{className:"font-medium",children:a==null?void 0:a.name})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"السعر:"}),e.jsxs("p",{className:"font-medium",children:[a==null?void 0:a.price," ج.م"]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"الوصف:"}),e.jsx("p",{className:"text-sm mt-1",children:a==null?void 0:a.description})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"الكمية:"}),e.jsx("p",{className:"font-medium",children:a==null?void 0:a.stock})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"التاجر:"}),e.jsx("p",{className:"font-medium",children:a==null?void 0:a.merchantName})]})]})]}),(a==null?void 0:a.verificationVideo)&&e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"فيديو التحقق:"}),e.jsx("video",{controls:!0,className:"w-full rounded",src:w(a.verificationVideo),children:"المتصفح لا يدعم عرض الفيديو"})]}),r==="reject"&&e.jsxs("div",{children:[e.jsx(B,{htmlFor:"reason",children:"سبب الرفض *"}),e.jsx(ne,{id:"reason",value:o,onChange:s=>D(s.target.value),placeholder:"اكتب سبب رفض المنتج هنا... (سيتم إرساله للتاجر)",rows:4,required:!0})]}),r==="approve"&&e.jsx("div",{className:"bg-green-50 dark:bg-green-900/20 p-4 rounded-lg",children:e.jsx("p",{className:"text-sm text-green-800 dark:text-green-200",children:"✅ سيتم الموافقة على هذا المنتج وسيصبح متاحاً للعرض في الموقع"})})]}),e.jsxs(ie,{children:[e.jsx(x,{type:"button",variant:"outline",onClick:()=>h(!1),disabled:v,children:"إلغاء"}),e.jsx(x,{onClick:Q,disabled:v||r==="reject"&&!o.trim(),className:r==="approve"?"bg-green-600 hover:bg-green-700":"",variant:r==="reject"?"destructive":"default",children:v?e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"h-4 w-4 ml-2 animate-spin"}),"جاري المعالجة..."]}):e.jsx(e.Fragment,{children:r==="approve"?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"h-4 w-4 ml-2"}),"تأكيد الموافقة"]}):e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"h-4 w-4 ml-2"}),"تأكيد الرفض"]})})})]})]})})]})}export{fe as default};
