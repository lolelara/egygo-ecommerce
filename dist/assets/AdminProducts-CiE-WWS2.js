import{r as v,j as e,ae as ie,bF as re,X as te,bv as le,a_ as ne,n as ce,p as Q,bE as oe,k as de,bG as me,a$ as xe}from"./vendor-react-wP-gPk8e.js";import{A as H}from"./AdminLayout-Bi0XjebE.js";import{Q as L,u as he,e as F,C as k,A as ge,B as R,o as je,D as J,F as G,t as V,v as X,w as _,x as W,r as T,s as q,f as B,I as C,g as ue,p as fe,n as ve,L as N,y as ye}from"./index-BjwBfcA6.js";import{T as Ne}from"./textarea-DqtwzpPR.js";import{T as pe,a as be,b as K,c as S,d as Ce,e as I}from"./table-DjZxPEeY.js";import{S as Z,a as ee,b as se,c as ae,d as M}from"./select--uXl0eT9.js";import{P as we}from"./loading-screen-DVDSM9z_.js";import{b as U}from"./admin-api-DhN-ueGs.js";import"./vendor-ui-BA32w1ww.js";import"./vendor-query-GexG3wnZ.js";import"./vendor-other-DcnDEVts.js";import"./vendor-animations-W1Z2cmit.js";import"./avatar-DWfEzynm.js";import"./vendor-appwrite-BGb_FC-V.js";function Pe({value:s=[],onChange:f,maxFiles:j=5,disabled:b=!1}){const[t,h]=v.useState(!1),[o,w]=v.useState(s.map(d=>({url:d,fileId:L.extractFileId(d)||void 0}))),P=v.useRef(null),{toast:y}=he(),A=async d=>{const n=Array.from(d.target.files||[]);if(n.length===0)return;if(o.length+n.length>j){y({title:"تحذير",description:`يمكنك رفع ${j} صور كحد أقصى`,variant:"destructive"});return}const i=L.validateFiles(n);if(!i.valid){y({title:"خطأ في الملفات",description:i.errors.join(`
`),variant:"destructive"});return}h(!0);try{const r=await L.uploadFiles(n),m=r.map(x=>({url:x.url,fileId:x.fileId})),u=[...o,...m];w(u),f(u.map(x=>x.url)),y({title:"تم الرفع بنجاح",description:`تم رفع ${r.length} صورة بنجاح`})}catch(r){y({title:"فشل الرفع",description:r.message||"حدث خطأ أثناء رفع الصور",variant:"destructive"})}finally{h(!1),P.current&&(P.current.value="")}},z=async d=>{const n=o[d];if(n.fileId)try{await L.deleteFile(n.fileId)}catch(r){console.error("Failed to delete file:",r)}const i=o.filter((r,m)=>m!==d);w(i),f(i.map(r=>r.url)),y({title:"تم الحذف",description:"تم حذف الصورة بنجاح"})};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("input",{ref:P,type:"file",accept:"image/jpeg,image/jpg,image/png,image/webp",multiple:!0,onChange:A,disabled:b||t||o.length>=j,className:"hidden"}),e.jsx(F,{type:"button",variant:"outline",onClick:()=>{var d;return(d=P.current)==null?void 0:d.click()},disabled:b||t||o.length>=j,className:"w-full",children:t?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"ml-2 h-4 w-4 animate-spin"}),"جاري الرفع..."]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"ml-2 h-4 w-4"}),"رفع صور (",o.length,"/",j,")"]})}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["الحد الأقصى: ",j," صور، 5 ميجابايت لكل صورة (JPG, PNG, WEBP)"]})]}),o.length>0&&e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:o.map((d,n)=>e.jsx(k,{className:"relative group",children:e.jsxs("div",{className:"aspect-square",children:[e.jsx("img",{src:d.url,alt:`صورة ${n+1}`,className:"w-full h-full object-cover rounded-lg",onError:i=>{i.currentTarget.src=ge.product()}}),n===0&&e.jsx(R,{className:"absolute top-2 left-2 bg-primary",children:"رئيسية"}),e.jsx(F,{type:"button",variant:"destructive",size:"icon",className:"absolute top-2 right-2 h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>z(n),disabled:b||t,children:e.jsx(te,{className:"h-4 w-4"})})]})},n))}),o.length===0&&!t&&e.jsx(k,{className:"border-dashed",children:e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(le,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500",children:"لم يتم رفع صور بعد"})]})})]})}const Y=({product:s,categories:f,onSubmit:j,onCancel:b})=>{var z,d,n;const[t,h]=v.useState({name:(s==null?void 0:s.name)||"",description:(s==null?void 0:s.description)||"",price:(s==null?void 0:s.price)||0,originalPrice:(s==null?void 0:s.originalPrice)||0,basePrice:(s==null?void 0:s.basePrice)||(s==null?void 0:s.price)||0,minCommissionPrice:(s==null?void 0:s.minCommissionPrice)||(s==null?void 0:s.price)||0,categoryId:(s==null?void 0:s.category)||"",images:(s==null?void 0:s.images)||[],tags:((z=s==null?void 0:s.tags)==null?void 0:z.join(", "))||"",stockQuantity:100,affiliateCommission:(s==null?void 0:s.affiliateCommission)||8,colors:((d=s==null?void 0:s.colors)==null?void 0:d.join(", "))||"",sizes:((n=s==null?void 0:s.sizes)==null?void 0:n.join(", "))||""}),[o,w]=v.useState(()=>{try{const i=s==null?void 0:s.colorSizeInventory;return i?JSON.parse(i):[]}catch{return[]}}),P=i=>{i.preventDefault();const r=t.colors.split(",").map(l=>l.trim()).filter(Boolean),m=t.sizes.split(",").map(l=>l.trim()).filter(Boolean),u=[];r.length>0&&m.length>0&&u.push(...o);const x=u.reduce((l,c)=>l+c.quantity,0);console.log("📦 Inventory data being saved:",u),console.log("📊 Total stock calculated:",x);const p=x||t.stockQuantity||0,a={...t,images:t.images,tags:t.tags.split(",").map(l=>l.trim()).filter(Boolean),colors:r,sizes:m,colorSizeInventory:JSON.stringify(u),stock:p,stockQuantity:p,inStock:p>0,isActive:p>0};console.log("💾 Submit data:",a),j(s?{...a,id:s.id}:a)},y=()=>{const i=t.colors.split(",").map(m=>m.trim()).filter(Boolean),r=t.sizes.split(",").map(m=>m.trim()).filter(Boolean);if(i.length>0&&r.length>0){const m=[];i.forEach(u=>{r.forEach(x=>{const p=o.find(a=>a.color===u&&a.size===x);m.push({color:u,size:x,quantity:(p==null?void 0:p.quantity)||0})})}),w(m)}},A=(i,r,m)=>{w(u=>u.map(x=>x.color===i&&x.size===r?{...x,quantity:Math.max(0,m)}:x))};return e.jsxs("form",{onSubmit:P,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"name",children:"اسم المنتج"}),e.jsx(C,{id:"name",value:t.name,onChange:i=>h(r=>({...r,name:i.target.value})),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"category",children:"الفئة"}),e.jsxs(Z,{value:t.categoryId,onValueChange:i=>h(r=>({...r,categoryId:i})),children:[e.jsx(ee,{children:e.jsx(se,{placeholder:"اختر فئة"})}),e.jsx(ae,{children:f.map(i=>e.jsx(M,{value:i.id,children:i.name},i.id))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"description",children:"الوصف"}),e.jsx(Ne,{id:"description",value:t.description,onChange:i=>h(r=>({...r,description:i.target.value})),rows:3,required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"price",children:"السعر للعرض (ج.م)"}),e.jsx(C,{id:"price",type:"number",value:t.price,onChange:i=>h(r=>({...r,price:Number(i.target.value)})),min:"0",step:"0.01",required:!0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"السعر الذي سيظهر للعملاء"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"originalPrice",children:"السعر الأصلي (ج.م)"}),e.jsx(C,{id:"originalPrice",type:"number",value:t.originalPrice,onChange:i=>h(r=>({...r,originalPrice:Number(i.target.value)})),min:"0",step:"0.01"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"السعر قبل الخصم (اختياري)"})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h3",{className:"font-semibold mb-3 text-primary",children:"⚙️ إعدادات العمولة للمسوقين"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"basePrice",children:"السعر الأساسي (قبل العمولة)"}),e.jsx(C,{id:"basePrice",type:"number",value:t.basePrice,onChange:i=>h(r=>({...r,basePrice:Number(i.target.value)})),min:"0",step:"0.01",required:!0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"السعر الذي ستحصل عليه (بدون عمولة المسوق)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"minCommissionPrice",children:"الحد الأدنى للسعر (شامل العمولة)"}),e.jsx(C,{id:"minCommissionPrice",type:"number",value:t.minCommissionPrice,onChange:i=>h(r=>({...r,minCommissionPrice:Number(i.target.value)})),min:t.basePrice,step:"0.01",required:!0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"أقل سعر يمكن للمسوق بيع المنتج به"})]})]}),t.basePrice>0&&t.minCommissionPrice>0&&e.jsxs("div",{className:"mt-3 p-3 bg-muted rounded-lg",children:[e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"الحد الأدنى للعمولة:"})," ",(t.minCommissionPrice-t.basePrice).toFixed(2)," ج.م"," ","(",((t.minCommissionPrice-t.basePrice)/t.basePrice*100).toFixed(1),"%)"]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["المسوق يمكنه إضافة أي قيمة أعلى من ",t.minCommissionPrice.toFixed(2)," ج.م"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"صور المنتج"}),e.jsx(Pe,{value:t.images,onChange:i=>h(r=>({...r,images:i})),maxFiles:5})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"tags",children:"الكلمات المفتاحية (منفصلة بفواصل)"}),e.jsx(C,{id:"tags",value:t.tags,onChange:i=>h(r=>({...r,tags:i.target.value})),placeholder:"إلكترونيات, سماعات, بلوتوث"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"colors",children:"الألوان المتاحة (منفصلة بفواصل)"}),e.jsx(C,{id:"colors",value:t.colors,onChange:i=>{h(r=>({...r,colors:i.target.value}))},onBlur:y,placeholder:"أحمر, أزرق, أخضر"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"مثال: أحمر, أزرق, أسود أو Red, Blue, Black"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"sizes",children:"المقاسات المتاحة (منفصلة بفواصل)"}),e.jsx(C,{id:"sizes",value:t.sizes,onChange:i=>{h(r=>({...r,sizes:i.target.value}))},onBlur:y,placeholder:"S, M, L, XL"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"مثال: S, M, L, XL أو 38, 40, 42, 44"})]})]}),o.length>0&&e.jsxs("div",{className:"space-y-3 border rounded-lg p-4 bg-muted/20",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(N,{className:"text-base font-semibold",children:"المخزون لكل لون ومقاس"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["إجمالي المخزون: ",o.reduce((i,r)=>i+r.quantity,0)]})]}),e.jsx("div",{className:"grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 max-h-[300px] overflow-y-auto",children:o.map((i,r)=>e.jsxs("div",{className:"space-y-1 border rounded p-2 bg-background",children:[e.jsxs("div",{className:"text-xs font-medium text-center",children:[i.color," - ",i.size]}),e.jsx(C,{type:"number",min:"0",value:i.quantity,onChange:m=>A(i.color,i.size,Number(m.target.value)),className:"h-8 text-center",placeholder:"0"})]},r))}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"💡 أدخل الكمية المتاحة لكل تركيبة لون ومقاس. المخزون الإجمالي سيتم حسابه تلقائياً."})]}),e.jsxs(ye,{children:[e.jsx(F,{type:"button",variant:"outline",onClick:b,children:"إلغاء"}),e.jsx(F,{type:"submit",children:s?"تحديث المنتج":"إضافة المنتج"})]})]})};function Ue(){const{user:s}=je(),[f,j]=v.useState([]),[b,t]=v.useState([]),[h,o]=v.useState(!0),[w,P]=v.useState(""),[y,A]=v.useState("all"),[z,d]=v.useState(!1),[n,i]=v.useState(null);v.useEffect(()=>{(async()=>{o(!0);try{const[l,c]=await Promise.all([fe.getAll({}),ve.getAll()]);let g=l.products;s&&s.labels&&!s.labels.includes("admin")&&(console.log("Filtering products for merchant:",s.$id),g=l.products.filter(E=>E.merchantId===s.$id),console.log("Merchant products:",g.length)),j(g),t(c.categories)}catch(l){console.error("Error fetching data:",l)}o(!1)})()},[s]);const r=f.filter(a=>{const l=a.name.toLowerCase().includes(w.toLowerCase())||a.description.toLowerCase().includes(w.toLowerCase()),c=y==="all"||a.category===y;return l&&c}),m=async a=>{try{const l=await U.create(a,s==null?void 0:s.$id);j(c=>[l,...c]),d(!1)}catch(l){console.error("Error adding product:",l),alert("فشل في إضافة المنتج")}},u=async a=>{var l;try{const c=f.find(D=>D.id===a.id),g=s&&((l=s.labels)==null?void 0:l.includes("admin")),E=c&&c.merchantId===(s==null?void 0:s.$id);if(!g&&!E){alert("ليس لديك صلاحية لتعديل هذا المنتج");return}const O=await U.update(a);j(D=>D.map($=>$.id===a.id?{...O,category:a.categoryId||$.category}:$)),i(null)}catch(c){console.error("Error updating product:",c),alert("فشل في تحديث المنتج")}},x=async a=>{if(confirm("هل أنت متأكد من حذف هذا المنتج؟"))try{await U.delete(a),j(l=>l.filter(c=>c.id!==a)),alert("تم حذف المنتج بنجاح")}catch(l){console.error("Error deleting product:",l),alert("فشل في حذف المنتج: "+l.message)}},p=a=>{var l,c;if(a.colorSizeInventory)try{const g=JSON.parse(a.colorSizeInventory);if(Array.isArray(g)&&g.length>0)return g.reduce((O,D)=>O+(D.quantity||0),0)>0}catch(g){console.error("Error parsing inventory for product:",a.id,g)}return((l=a.colors)==null?void 0:l.length)>0||((c=a.sizes)==null?void 0:c.length)>0||a.stock!==void 0&&a.stock>0?!0:a.inStock!==void 0?a.inStock:!0};return h?e.jsx(H,{children:e.jsx(we,{message:"جاري تحميل المنتجات..."})}):e.jsx(H,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"إدارة المنتجات"}),e.jsxs(J,{open:z,onOpenChange:d,children:[e.jsx(G,{asChild:!0,children:e.jsxs(F,{children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"إضافة منتج جديد"]})}),e.jsxs(V,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(X,{children:[e.jsx(_,{children:"إضافة منتج جديد"}),e.jsx(W,{children:"أدخل تفاصيل المنتج الجديد"})]}),e.jsx(Y,{categories:b,onSubmit:m,onCancel:()=>d(!1)})]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(k,{children:[e.jsxs(T,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(q,{className:"text-sm font-medium",children:"إجمالي المنتجات"}),e.jsx(ce,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(B,{children:e.jsx("div",{className:"text-2xl font-bold",children:f.length})})]}),e.jsxs(k,{children:[e.jsxs(T,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(q,{className:"text-sm font-medium",children:"المنتجات المتاحة"}),e.jsx(Q,{className:"h-4 w-4 text-green-600"})]}),e.jsx(B,{children:e.jsx("div",{className:"text-2xl font-bold",children:f.filter(a=>p(a)).length})})]}),e.jsxs(k,{children:[e.jsxs(T,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(q,{className:"text-sm font-medium",children:"المنتجات غير المتاحة"}),e.jsx(oe,{className:"h-4 w-4 text-red-600"})]}),e.jsx(B,{children:e.jsx("div",{className:"text-2xl font-bold",children:f.filter(a=>!p(a)).length})})]}),e.jsxs(k,{children:[e.jsxs(T,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(q,{className:"text-sm font-medium",children:"متوسط التقييم"}),e.jsx(Q,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(B,{children:e.jsx("div",{className:"text-2xl font-bold",children:f.length>0?(f.reduce((a,l)=>a+l.rating,0)/f.length).toFixed(1):"0.0"})})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(de,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(C,{placeholder:"البحث في المنتجات...",value:w,onChange:a=>P(a.target.value),className:"pl-10"})]})}),e.jsxs(Z,{value:y,onValueChange:A,children:[e.jsx(ee,{className:"w-48",children:e.jsx(se,{})}),e.jsxs(ae,{children:[e.jsx(M,{value:"all",children:"جميع الفئات"}),b.map(a=>e.jsx(M,{value:a.id,children:a.name},a.id))]})]})]}),e.jsxs(k,{children:[e.jsx(T,{children:e.jsxs(q,{children:["المنتجات (",r.length,")"]})}),e.jsx(B,{children:e.jsxs(pe,{children:[e.jsx(be,{children:e.jsxs(K,{children:[e.jsx(S,{children:"المنتج"}),e.jsx(S,{children:"الفئة"}),e.jsx(S,{children:"السعر"}),e.jsx(S,{children:"التقييم"}),e.jsx(S,{children:"المخزون"}),e.jsx(S,{children:"العمولة"}),e.jsx(S,{className:"text-center",children:"الإجراءات"})]})}),e.jsx(Ce,{children:r.map(a=>{var c;const l=b.find(g=>g.id===a.category);return e.jsxs(K,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:ue((c=a.images)==null?void 0:c[0]),alt:a.name,className:"w-10 h-10 rounded object-cover"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:a.name}),e.jsx("div",{className:"text-sm text-muted-foreground truncate max-w-[200px]",children:a.description})]})]})}),e.jsx(I,{children:e.jsx(R,{variant:"outline",children:(l==null?void 0:l.name)||a.category})}),e.jsx(I,{children:e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[a.price," ج.م"]}),a.originalPrice&&e.jsxs("div",{className:"text-sm text-muted-foreground line-through",children:[a.originalPrice," ج.م"]})]})}),e.jsx(I,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{children:a.rating.toFixed(1)}),e.jsxs("span",{className:"text-muted-foreground",children:["(",a.reviewCount,")"]})]})}),e.jsx(I,{children:e.jsx(R,{variant:a.inStock?"default":"secondary",children:a.inStock?"متاح":"غير متاح"})}),e.jsxs(I,{children:[a.affiliateCommission,"%"]}),e.jsx(I,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(J,{open:(n==null?void 0:n.id)===a.id,onOpenChange:g=>!g&&i(null),children:[e.jsx(G,{asChild:!0,children:e.jsx(F,{variant:"outline",size:"sm",onClick:()=>i(a),children:e.jsx(me,{className:"h-4 w-4"})})}),e.jsxs(V,{className:"max-w-2xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(X,{children:[e.jsx(_,{children:"تعديل المنتج"}),e.jsx(W,{children:"تعديل تفاصيل المنتج"})]}),n&&e.jsx(Y,{product:n,categories:b,onSubmit:u,onCancel:()=>i(null)})]})]}),e.jsx(F,{variant:"outline",size:"sm",onClick:()=>{confirm("هل أنت متأكد من حذف هذا المنتج؟")&&x(a.id)},children:e.jsx(xe,{className:"h-4 w-4 text-red-600"})})]})})]},a.id)})})]})})]})]})})}export{Ue as default};
