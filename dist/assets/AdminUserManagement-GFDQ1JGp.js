import{r as n,j as e,U as fe,bC as ve,k as be,bG as ye,a$ as Ne,a0 as V}from"./vendor-react-BMq-IxHG.js";import{T as Ce}from"./LoadingSkeletons-DAs8Sw-3.js";import{o as ke,u as we,d as N,e as o,C as _,f as J,L as i,I as m,r as De,s as Se,D as A,t as M,v as I,w as $,x as O,y as T,B as G}from"./index-DuObFWLq.js";import{Q as K,I as Pe}from"./vendor-appwrite-BGb_FC-V.js";import{T as Fe,a as Ae,b as W,c as g,d as Me,e as f}from"./table--PfvcEZL.js";import{S as X,a as Y,b as Z,c as ee,d as x}from"./select-MBjfD9dX.js";import"./vendor-ui-BA32w1ww.js";import"./vendor-query-GexG3wnZ.js";import"./vendor-other-C5r3s8Py.js";import"./vendor-animations-W1Z2cmit.js";import"./skeleton-DMaUp_11.js";const C=void 0;function Ge(){const{user:Ie}=ke(),{toast:d}=we(),[se,ae]=n.useState([]),[le,Q]=n.useState(!1),[k,re]=n.useState(""),[R,te]=n.useState("all"),[ne,w]=n.useState(!1),[r,v]=n.useState({email:"",password:"",name:"",phone:"",role:"customer",defaultMarkupPercentage:"20"}),[ie,D]=n.useState(!1),[c,E]=n.useState(null),[L,B]=n.useState("20"),[S,P]=n.useState(!1),[a,H]=n.useState(null),[l,p]=n.useState({name:"",email:"",phone:"",role:"customer",defaultMarkupPercentage:"20"}),[ce,F]=n.useState(!1),[j,q]=n.useState(null);n.useEffect(()=>{b()},[]),n.useEffect(()=>{console.log("📊 Edit Dialog State Changed:",S),console.log("👤 Editing User:",a),S&&a&&(console.log("✅ Dialog should be visible now"),console.log("📝 Edit User Data:",l))},[S,a,l]);const b=async()=>{Q(!0);try{const s=await N.listDocuments(C,"userPreferences",[K.limit(100),K.orderDesc("$createdAt")]);console.log("📥 Loaded users:",s.documents.length),console.log("📋 First user sample:",s.documents[0]);const t=s.documents.reduce((h,y)=>(h[y.role]=(h[y.role]||0)+1,h),{});console.log("📊 Users by role:",t);const u=s.documents.filter(h=>h.role==="customer"&&!h.isIntermediary);console.log("🟣 Customers eligible for intermediary:",u.length),u.length>0&&console.log("📝 Sample eligible customer:",u[0]),ae(s.documents)}catch(s){console.error("❌ Error loading users:",s),d({title:"خطأ",description:"فشل تحميل المستخدمين",variant:"destructive"})}finally{Q(!1)}},oe=async()=>{if(!r.email||!r.password||!r.name){d({title:"تحذير",description:"الرجاء ملء جميع الحقول المطلوبة",variant:"destructive"});return}try{const s=Pe.unique();await N.createDocument(C,"userPreferences",s,{userId:s,email:r.email,name:r.name,phone:r.phone||"",role:r.role,isAdmin:r.role==="admin",isAffiliate:r.role==="affiliate",isMerchant:r.role==="merchant",isIntermediary:!1,affiliateCode:r.role==="affiliate"?`AFF${Date.now()}`:"",intermediaryCode:"",defaultMarkupPercentage:0,commissionRate:r.role==="affiliate"?10:0}),d({title:"نجح!",description:`تم إنشاء حساب ${r.name} بنجاح`}),w(!1),v({email:"",password:"",name:"",phone:"",role:"customer",defaultMarkupPercentage:"20"}),b()}catch(s){d({title:"خطأ",description:s.message||"فشل إنشاء الحساب",variant:"destructive"})}},de=async()=>{if(!(!c||!L))try{const s=`INT${Date.now()}`;await N.updateDocument(C,"userPreferences",c.$id,{role:"intermediary",isIntermediary:!0,intermediaryCode:s,defaultMarkupPercentage:parseFloat(L)}),d({title:"تم التفعيل!",description:`تم تفعيل دور الوسيط لـ ${c.name}`}),D(!1),E(null),B("20"),b()}catch(s){d({title:"خطأ",description:s.message||"فشل تفعيل دور الوسيط",variant:"destructive"})}},me=s=>{E(s),D(!0)},xe=s=>{var t;console.log("🔍 Opening edit dialog for user:",s),H(s),p({name:s.name||"",email:s.email||"",phone:s.phone||"",role:s.role||"customer",defaultMarkupPercentage:((t=s.defaultMarkupPercentage)==null?void 0:t.toString())||"20"}),P(!0),console.log("✅ Edit dialog state set to true")},he=s=>{s!==(a==null?void 0:a.role)?(q(s),F(!0)):p({...l,role:s})},ue=()=>{j&&(p({...l,role:j}),F(!1),q(null))},pe=async()=>{if(!a||!l.name||!l.email){d({title:"تحذير",description:"الرجاء ملء جميع الحقول المطلوبة",variant:"destructive"});return}try{const s={name:l.name,email:l.email,phone:l.phone||"",role:l.role,isAdmin:l.role==="admin",isAffiliate:l.role==="affiliate",isMerchant:l.role==="merchant",isIntermediary:l.role==="intermediary",accountStatus:"approved"};l.role!==a.role?(s.affiliateCode=l.role==="affiliate"?`AFF${Date.now()}`:"",s.intermediaryCode=l.role==="intermediary"?`INT${Date.now()}`:"",s.defaultMarkupPercentage=l.role==="intermediary"?parseFloat(l.defaultMarkupPercentage):0,s.commissionRate=l.role==="affiliate"?10:0):s.defaultMarkupPercentage=a.isIntermediary?parseFloat(l.defaultMarkupPercentage):a.defaultMarkupPercentage||0,await N.updateDocument(C,"userPreferences",a.$id,s),d({title:"نجح!",description:`تم تحديث ${l.name} بنجاح`}),P(!1),H(null),b()}catch(s){d({title:"خطأ",description:s.message||"فشل تحديث المستخدم",variant:"destructive"})}},je=async(s,t)=>{if(confirm(`هل أنت متأكد من حذف ${t}؟`))try{await N.deleteDocument(C,"userPreferences",s),d({title:"تم الحذف",description:`تم حذف ${t}`}),b()}catch{d({title:"خطأ",description:"فشل حذف المستخدم",variant:"destructive"})}},ge=s=>{const t={admin:"bg-red-100 text-red-800",intermediary:"bg-purple-100 text-purple-800",merchant:"bg-blue-100 text-blue-800",affiliate:"bg-green-100 text-green-800",customer:"bg-gray-100 text-gray-800"},u={admin:"مدير",intermediary:"وسيط",merchant:"تاجر",affiliate:"مسوق",customer:"عميل"};return e.jsx(G,{className:t[s]||t.customer,children:u[s]||s})},z=se.filter(s=>{var h,y,U;const t=((h=s.name)==null?void 0:h.toLowerCase().includes(k.toLowerCase()))||((y=s.email)==null?void 0:y.toLowerCase().includes(k.toLowerCase()))||((U=s.phone)==null?void 0:U.includes(k)),u=R==="all"||s.role===R;return t&&u});return e.jsx("div",{className:"container mx-auto p-6",dir:"rtl",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(fe,{className:"h-8 w-8"}),"إدارة المستخدمين"]}),e.jsx("p",{className:"text-muted-foreground",children:"إدارة حسابات المستخدمين والوسطاء"})]}),e.jsxs(o,{onClick:()=>w(!0),children:[e.jsx(ve,{className:"h-4 w-4 ml-2"}),"إضافة مستخدم"]})]}),e.jsx(_,{children:e.jsx(J,{className:"pt-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(i,{children:"بحث"}),e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"absolute right-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(m,{placeholder:"ابحث بالاسم، البريد، أو الهاتف...",value:k,onChange:s=>re(s.target.value),className:"pr-10"})]})]}),e.jsxs("div",{children:[e.jsx(i,{children:"تصفية حسب الدور"}),e.jsxs(X,{value:R,onValueChange:te,children:[e.jsx(Y,{children:e.jsx(Z,{})}),e.jsxs(ee,{children:[e.jsx(x,{value:"all",children:"الكل"}),e.jsx(x,{value:"admin",children:"مدير"}),e.jsx(x,{value:"intermediary",children:"وسيط"}),e.jsx(x,{value:"merchant",children:"تاجر"}),e.jsx(x,{value:"affiliate",children:"مسوق"}),e.jsx(x,{value:"customer",children:"عميل"})]})]})]})]})})}),e.jsxs(_,{children:[e.jsx(De,{children:e.jsxs(Se,{children:["المستخدمون (",z.length,")"]})}),e.jsx(J,{children:le?e.jsx(Ce,{rows:8,cols:7}):z.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"لا توجد نتائج"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Fe,{children:[e.jsx(Ae,{children:e.jsxs(W,{children:[e.jsx(g,{children:"الاسم"}),e.jsx(g,{children:"البريد الإلكتروني"}),e.jsx(g,{children:"الهاتف"}),e.jsx(g,{children:"الدور"}),e.jsx(g,{children:"الكود"}),e.jsx(g,{children:"تاريخ الإنشاء"}),e.jsx(g,{children:"إجراءات"})]})}),e.jsx(Me,{children:z.map(s=>e.jsxs(W,{children:[e.jsx(f,{className:"font-medium",children:s.name}),e.jsx(f,{children:s.email}),e.jsx(f,{children:s.phone||"-"}),e.jsx(f,{children:ge(s.role)}),e.jsx(f,{children:e.jsx("code",{className:"text-xs bg-muted px-2 py-1 rounded",children:s.affiliateCode||s.intermediaryCode||"-"})}),e.jsx(f,{children:new Date(s.$createdAt).toLocaleDateString("ar-EG")}),e.jsx(f,{children:e.jsxs("div",{className:"flex gap-2 items-center",children:[s.role==="customer"&&!s.isIntermediary&&e.jsx(o,{size:"sm",variant:"default",className:"bg-purple-600 hover:bg-purple-700 text-white",onClick:t=>{t.preventDefault(),t.stopPropagation(),console.log("🟣 Activating intermediary for:",s.name),me(s)},children:"تفعيل وسيط"}),e.jsx(o,{size:"sm",variant:"outline",onClick:t=>{t.preventDefault(),t.stopPropagation(),console.log("✏️ Edit button clicked for:",s.name),console.log("User data:",s),xe(s)},title:"تعديل المستخدم",children:e.jsx(ye,{className:"h-4 w-4"})}),e.jsx(o,{size:"sm",variant:"destructive",onClick:t=>{t.preventDefault(),t.stopPropagation(),je(s.$id,s.name)},title:"حذف المستخدم",children:e.jsx(Ne,{className:"h-4 w-4"})})]})})]},s.$id))})]})})})]}),e.jsx(A,{open:ne,onOpenChange:w,children:e.jsxs(M,{className:"sm:max-w-[500px]",dir:"rtl",children:[e.jsxs(I,{children:[e.jsx($,{children:"إضافة مستخدم جديد"}),e.jsx(O,{children:"أدخل بيانات المستخدم الجديد"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"name",children:"الاسم *"}),e.jsx(m,{id:"name",value:r.name,onChange:s=>v({...r,name:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"email",children:"البريد الإلكتروني *"}),e.jsx(m,{id:"email",type:"email",value:r.email,onChange:s=>v({...r,email:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"password",children:"كلمة المرور *"}),e.jsx(m,{id:"password",type:"password",value:r.password,onChange:s=>v({...r,password:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"phone",children:"الهاتف"}),e.jsx(m,{id:"phone",type:"tel",value:r.phone,onChange:s=>v({...r,phone:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"role",children:"الدور *"}),e.jsxs(X,{value:r.role,onValueChange:s=>v({...r,role:s}),children:[e.jsx(Y,{children:e.jsx(Z,{})}),e.jsxs(ee,{children:[e.jsx(x,{value:"customer",children:"عميل"}),e.jsx(x,{value:"affiliate",children:"مسوق"}),e.jsx(x,{value:"merchant",children:"تاجر"}),e.jsx(x,{value:"admin",children:"مدير"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"ملاحظة: دور الوسيط يمكن تفعيله للعملاء من خلال الجدول"})]})]}),e.jsxs(T,{children:[e.jsx(o,{variant:"outline",onClick:()=>w(!1),children:"إلغاء"}),e.jsx(o,{onClick:oe,children:"إنشاء الحساب"})]})]})}),e.jsx(A,{open:ie,onOpenChange:D,children:e.jsxs(M,{className:"sm:max-w-[500px]",dir:"rtl",children:[e.jsxs(I,{children:[e.jsx($,{children:"تفعيل دور الوسيط"}),e.jsxs(O,{children:["تفعيل دور الوسيط لـ ",c==null?void 0:c.name]})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-purple-900 dark:text-purple-100",children:[e.jsx("strong",{children:"العميل:"})," ",c==null?void 0:c.name]}),e.jsxs("p",{className:"text-sm text-purple-900 dark:text-purple-100",children:[e.jsx("strong",{children:"البريد:"})," ",c==null?void 0:c.email]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"intermediary-markup",children:"نسبة الترميز الافتراضية (%)"}),e.jsx(m,{id:"intermediary-markup",type:"number",min:"0",max:"100",value:L,onChange:s=>B(s.target.value),placeholder:"مثال: 20"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"النسبة التي سيتم إضافتها على سعر المنتج الأصلي"})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-blue-900 dark:text-blue-100",children:"ℹ️ سيتم توليد كود وسيط فريد تلقائياً"}),e.jsx("p",{className:"text-sm text-blue-900 dark:text-blue-100",children:"ℹ️ سيتمكن الوسيط من إضافة المنتجات من روابط خارجية"})]})]}),e.jsxs(T,{children:[e.jsx(o,{variant:"outline",onClick:()=>{D(!1),E(null),B("20")},children:"إلغاء"}),e.jsx(o,{onClick:de,className:"bg-purple-600 hover:bg-purple-700",children:"تفعيل الوسيط"})]})]})}),e.jsx(A,{open:S,onOpenChange:s=>{console.log("🔄 Dialog onOpenChange called:",s),P(s)},children:e.jsxs(M,{className:"max-w-md",onOpenAutoFocus:()=>{console.log("🎯 Dialog content rendered and focused")},children:[e.jsxs(I,{children:[e.jsx($,{children:"تعديل بيانات المستخدم"}),e.jsx(O,{children:"قم بتعديل بيانات المستخدم وحفظ التغييرات"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-name",children:"الاسم"}),e.jsx(m,{id:"edit-name",value:l.name,onChange:s=>p({...l,name:s.target.value}),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-email",children:"البريد الإلكتروني"}),e.jsx(m,{id:"edit-email",type:"email",value:l.email,onChange:s=>p({...l,email:s.target.value}),placeholder:"user@example.com"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-phone",children:"رقم الهاتف"}),e.jsx(m,{id:"edit-phone",value:l.phone,onChange:s=>p({...l,phone:s.target.value}),placeholder:"+20 123 456 7890"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-role",children:"الدور"}),e.jsxs("select",{id:"edit-role",className:"w-full p-2 border rounded-md bg-background",value:l.role,onChange:s=>he(s.target.value),children:[e.jsx("option",{value:"customer",children:"عميل"}),e.jsx("option",{value:"affiliate",children:"مسوق بالعمولة"}),e.jsx("option",{value:"merchant",children:"تاجر"}),e.jsx("option",{value:"intermediary",children:"وسيط"}),e.jsx("option",{value:"admin",children:"مدير"})]}),l.role!==(a==null?void 0:a.role)&&e.jsxs("p",{className:"text-xs text-orange-600 dark:text-orange-400 flex items-center gap-1",children:[e.jsx(V,{className:"h-3 w-3"}),"سيتم تطبيق الدور الجديد فوراً بدون مراجعة"]})]}),(a==null?void 0:a.isIntermediary)&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-markup",children:"نسبة الهامش الربحي الافتراضية (%)"}),e.jsx(m,{id:"edit-markup",type:"number",min:"0",max:"100",value:l.defaultMarkupPercentage,onChange:s=>p({...l,defaultMarkupPercentage:s.target.value}),placeholder:"20"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"النسبة التي سيتم إضافتها على سعر المنتج الأصلي"})]})]}),e.jsxs(T,{children:[e.jsx(o,{variant:"outline",onClick:()=>{P(!1),H(null)},children:"إلغاء"}),e.jsx(o,{onClick:pe,className:"bg-blue-600 hover:bg-blue-700",children:"حفظ التعديلات"})]})]})}),e.jsx(A,{open:ce,onOpenChange:F,children:e.jsxs(M,{className:"sm:max-w-[500px]",dir:"rtl",children:[e.jsxs(I,{children:[e.jsxs($,{className:"flex items-center gap-2 text-orange-600",children:[e.jsx(V,{className:"h-6 w-6"}),"تحذير: تغيير الدور"]}),e.jsx(O,{children:"يرجى قراءة التحذير التالي بعناية قبل المتابعة"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 p-4 rounded-lg",children:[e.jsxs("h3",{className:"font-bold text-red-800 dark:text-red-200 mb-2 flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5"}),"تحذير هام"]}),e.jsxs("ul",{className:"space-y-2 text-sm text-red-700 dark:text-red-300",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-red-600 font-bold",children:"•"}),e.jsx("span",{children:"سيفقد المستخدم جميع البيانات المرتبطة بالدور القديم"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-red-600 font-bold",children:"•"}),e.jsx("span",{children:"سيتم حذف المنتجات، الطلبات، والإحصائيات القديمة"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-red-600 font-bold",children:"•"}),e.jsx("span",{children:"لا يمكن التراجع عن هذا الإجراء"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-red-600 font-bold",children:"•"}),e.jsx("span",{children:"سيتم تطبيق الدور الجديد فوراً بدون مراجعة"})]})]})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-bold text-blue-800 dark:text-blue-200 mb-2",children:"التغيير المطلوب:"}),e.jsxs("div",{className:"flex items-center justify-center gap-4 text-sm",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-1",children:"الدور الحالي"}),e.jsxs(G,{className:"text-base px-4 py-1",children:[(a==null?void 0:a.role)==="customer"&&"عميل",(a==null?void 0:a.role)==="affiliate"&&"مسوق",(a==null?void 0:a.role)==="merchant"&&"تاجر",(a==null?void 0:a.role)==="intermediary"&&"وسيط",(a==null?void 0:a.role)==="admin"&&"مدير"]})]}),e.jsx("div",{className:"text-2xl text-muted-foreground",children:"→"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-1",children:"الدور الجديد"}),e.jsxs(G,{className:"text-base px-4 py-1 bg-green-100 text-green-800",children:[j==="customer"&&"عميل",j==="affiliate"&&"مسوق",j==="merchant"&&"تاجر",j==="intermediary"&&"وسيط",j==="admin"&&"مدير"]})]})]})]}),e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-200 dark:border-yellow-800 p-4 rounded-lg",children:e.jsxs("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:["ℹ️ ",e.jsx("strong",{children:"ملاحظة:"})," سيتم تفعيل الحساب تلقائياً بالدور الجديد دون الحاجة لمراجعة الأدمن"]})})]}),e.jsxs(T,{children:[e.jsx(o,{variant:"outline",onClick:()=>{F(!1),q(null)},children:"إلغاء"}),e.jsx(o,{onClick:ue,className:"bg-red-600 hover:bg-red-700",children:"تأكيد التغيير"})]})]})})]})})}export{Ge as default};
