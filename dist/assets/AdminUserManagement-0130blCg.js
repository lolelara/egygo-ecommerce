import{w as ge,b as fe,r as n,a8 as y,a0 as Q,j as e,aw as ve,B as d,C as _,g as J,s as i,aE as be,I as o,ap as K,aq as W,ar as X,as as Y,at as m,e as ye,f as Ne,b9 as Ce,T as ke,D as P,i as U,k as I,l as A,b5 as M,m as $,a1 as H,a as z,$ as we}from"./index-Ce-RwxJS.js";import{T as De,a as Se,b as Z,c as p,d as Fe,e as j}from"./table-DhT4s9qg.js";import{U as Pe}from"./user-plus-BPi6Sh3A.js";import{S as Ue}from"./square-pen-BvEjHzCI.js";const N=void 0;function Te(){const{user:Ie}=ge(),{toast:c}=fe(),[ee,se]=n.useState([]),[ae,V]=n.useState(!1),[C,re]=n.useState(""),[O,le]=n.useState("all"),[te,k]=n.useState(!1),[r,g]=n.useState({email:"",password:"",name:"",phone:"",role:"customer",defaultMarkupPercentage:"20"}),[ne,w]=n.useState(!1),[f,T]=n.useState(null),[E,R]=n.useState("20"),[D,S]=n.useState(!1),[t,L]=n.useState(null),[a,h]=n.useState({name:"",email:"",phone:"",role:"customer",defaultMarkupPercentage:"20"}),[ie,F]=n.useState(!1),[u,B]=n.useState(null);n.useEffect(()=>{b()},[]),n.useEffect(()=>{console.log("📊 Edit Dialog State Changed:",D),console.log("👤 Editing User:",t),D&&t&&(console.log("✅ Dialog should be visible now"),console.log("📝 Edit User Data:",a))},[D,t,a]);const b=async()=>{V(!0);try{const s=await y.listDocuments(N,"userPreferences",[Q.limit(100),Q.orderDesc("$createdAt")]);console.log("📥 Loaded users:",s.documents.length),console.log("📋 First user sample:",s.documents[0]);const l=s.documents.reduce((v,G)=>(v[G.role]=(v[G.role]||0)+1,v),{});console.log("📊 Users by role:",l);const x=s.documents.filter(v=>v.role==="customer"&&!v.isIntermediary);console.log("🟣 Customers eligible for intermediary:",x.length),x.length>0&&console.log("📝 Sample eligible customer:",x[0]),se(s.documents)}catch(s){console.error("❌ Error loading users:",s),c({title:"خطأ",description:"فشل تحميل المستخدمين",variant:"destructive"})}finally{V(!1)}},de=async()=>{if(!r.email||!r.password||!r.name){c({title:"تحذير",description:"الرجاء ملء جميع الحقول المطلوبة",variant:"destructive"});return}try{const s=we.unique();await y.createDocument(N,"userPreferences",s,{userId:s,email:r.email,name:r.name,phone:r.phone||"",role:r.role,isAdmin:r.role==="admin",isAffiliate:r.role==="affiliate",isMerchant:r.role==="merchant",isIntermediary:!1,affiliateCode:r.role==="affiliate"?`AFF${Date.now()}`:"",intermediaryCode:"",defaultMarkupPercentage:0,commissionRate:r.role==="affiliate"?10:0}),c({title:"نجح!",description:`تم إنشاء حساب ${r.name} بنجاح`}),k(!1),g({email:"",password:"",name:"",phone:"",role:"customer",defaultMarkupPercentage:"20"}),b()}catch(s){c({title:"خطأ",description:s.message||"فشل إنشاء الحساب",variant:"destructive"})}},ce=async()=>{if(!(!f||!E))try{const s=`INT${Date.now()}`;await y.updateDocument(N,"userPreferences",f.$id,{role:"intermediary",isIntermediary:!0,intermediaryCode:s,defaultMarkupPercentage:parseFloat(E)}),c({title:"تم التفعيل!",description:`تم تفعيل دور الوسيط لـ ${f.name}`}),w(!1),T(null),R("20"),b()}catch(s){c({title:"خطأ",description:s.message||"فشل تفعيل دور الوسيط",variant:"destructive"})}},oe=s=>{T(s),w(!0)},me=s=>{console.log("🔍 Opening edit dialog for user:",s),L(s),h({name:s.name||"",email:s.email||"",phone:s.phone||"",role:s.role||"customer",defaultMarkupPercentage:s.defaultMarkupPercentage?.toString()||"20"}),S(!0),console.log("✅ Edit dialog state set to true")},xe=s=>{s!==t?.role?(B(s),F(!0)):h({...a,role:s})},he=()=>{u&&(h({...a,role:u}),F(!1),B(null))},ue=async()=>{if(!t||!a.name||!a.email){c({title:"تحذير",description:"الرجاء ملء جميع الحقول المطلوبة",variant:"destructive"});return}try{const s={name:a.name,email:a.email,phone:a.phone||"",role:a.role,isAdmin:a.role==="admin",isAffiliate:a.role==="affiliate",isMerchant:a.role==="merchant",isIntermediary:a.role==="intermediary",accountStatus:"approved"};a.role!==t.role?(s.affiliateCode=a.role==="affiliate"?`AFF${Date.now()}`:"",s.intermediaryCode=a.role==="intermediary"?`INT${Date.now()}`:"",s.defaultMarkupPercentage=a.role==="intermediary"?parseFloat(a.defaultMarkupPercentage):0,s.commissionRate=a.role==="affiliate"?10:0):s.defaultMarkupPercentage=t.isIntermediary?parseFloat(a.defaultMarkupPercentage):t.defaultMarkupPercentage||0,await y.updateDocument(N,"userPreferences",t.$id,s),c({title:"نجح!",description:`تم تحديث ${a.name} بنجاح`}),S(!1),L(null),b()}catch(s){c({title:"خطأ",description:s.message||"فشل تحديث المستخدم",variant:"destructive"})}},pe=async(s,l)=>{if(confirm(`هل أنت متأكد من حذف ${l}؟`))try{await y.deleteDocument(N,"userPreferences",s),c({title:"تم الحذف",description:`تم حذف ${l}`}),b()}catch{c({title:"خطأ",description:"فشل حذف المستخدم",variant:"destructive"})}},je=s=>{const l={admin:"bg-red-100 text-red-800",intermediary:"bg-purple-100 text-purple-800",merchant:"bg-blue-100 text-blue-800",affiliate:"bg-green-100 text-green-800",customer:"bg-gray-100 text-gray-800"},x={admin:"مدير",intermediary:"وسيط",merchant:"تاجر",affiliate:"مسوق",customer:"عميل"};return e.jsx(z,{className:l[s]||l.customer,children:x[s]||s})},q=ee.filter(s=>{const l=s.name?.toLowerCase().includes(C.toLowerCase())||s.email?.toLowerCase().includes(C.toLowerCase())||s.phone?.includes(C),x=O==="all"||s.role===O;return l&&x});return e.jsx("div",{className:"container mx-auto p-6",dir:"rtl",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(ve,{className:"h-8 w-8"}),"إدارة المستخدمين"]}),e.jsx("p",{className:"text-muted-foreground",children:"إدارة حسابات المستخدمين والوسطاء"})]}),e.jsxs(d,{onClick:()=>k(!0),children:[e.jsx(Pe,{className:"h-4 w-4 ml-2"}),"إضافة مستخدم"]})]}),e.jsx(_,{children:e.jsx(J,{className:"pt-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(i,{children:"بحث"}),e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"absolute right-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(o,{placeholder:"ابحث بالاسم، البريد، أو الهاتف...",value:C,onChange:s=>re(s.target.value),className:"pr-10"})]})]}),e.jsxs("div",{children:[e.jsx(i,{children:"تصفية حسب الدور"}),e.jsxs(K,{value:O,onValueChange:le,children:[e.jsx(W,{children:e.jsx(X,{})}),e.jsxs(Y,{children:[e.jsx(m,{value:"all",children:"الكل"}),e.jsx(m,{value:"admin",children:"مدير"}),e.jsx(m,{value:"intermediary",children:"وسيط"}),e.jsx(m,{value:"merchant",children:"تاجر"}),e.jsx(m,{value:"affiliate",children:"مسوق"}),e.jsx(m,{value:"customer",children:"عميل"})]})]})]})]})})}),e.jsxs(_,{children:[e.jsx(ye,{children:e.jsxs(Ne,{children:["المستخدمون (",q.length,")"]})}),e.jsx(J,{children:ae?e.jsx(Ce,{rows:8,cols:7}):q.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"لا توجد نتائج"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(De,{children:[e.jsx(Se,{children:e.jsxs(Z,{children:[e.jsx(p,{children:"الاسم"}),e.jsx(p,{children:"البريد الإلكتروني"}),e.jsx(p,{children:"الهاتف"}),e.jsx(p,{children:"الدور"}),e.jsx(p,{children:"الكود"}),e.jsx(p,{children:"تاريخ الإنشاء"}),e.jsx(p,{children:"إجراءات"})]})}),e.jsx(Fe,{children:q.map(s=>e.jsxs(Z,{children:[e.jsx(j,{className:"font-medium",children:s.name}),e.jsx(j,{children:s.email}),e.jsx(j,{children:s.phone||"-"}),e.jsx(j,{children:je(s.role)}),e.jsx(j,{children:e.jsx("code",{className:"text-xs bg-muted px-2 py-1 rounded",children:s.affiliateCode||s.intermediaryCode||"-"})}),e.jsx(j,{children:new Date(s.$createdAt).toLocaleDateString("ar-EG")}),e.jsx(j,{children:e.jsxs("div",{className:"flex gap-2 items-center",children:[s.role==="customer"&&!s.isIntermediary&&e.jsx(d,{size:"sm",variant:"default",className:"bg-purple-600 hover:bg-purple-700 text-white",onClick:l=>{l.preventDefault(),l.stopPropagation(),console.log("🟣 Activating intermediary for:",s.name),oe(s)},children:"تفعيل وسيط"}),e.jsx(d,{size:"sm",variant:"outline",onClick:l=>{l.preventDefault(),l.stopPropagation(),console.log("✏️ Edit button clicked for:",s.name),console.log("User data:",s),me(s)},title:"تعديل المستخدم",children:e.jsx(Ue,{className:"h-4 w-4"})}),e.jsx(d,{size:"sm",variant:"destructive",onClick:l=>{l.preventDefault(),l.stopPropagation(),pe(s.$id,s.name)},title:"حذف المستخدم",children:e.jsx(ke,{className:"h-4 w-4"})})]})})]},s.$id))})]})})})]}),e.jsx(P,{open:te,onOpenChange:k,children:e.jsxs(U,{className:"sm:max-w-[500px]",dir:"rtl",children:[e.jsxs(I,{children:[e.jsx(A,{children:"إضافة مستخدم جديد"}),e.jsx(M,{children:"أدخل بيانات المستخدم الجديد"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"name",children:"الاسم *"}),e.jsx(o,{id:"name",value:r.name,onChange:s=>g({...r,name:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"email",children:"البريد الإلكتروني *"}),e.jsx(o,{id:"email",type:"email",value:r.email,onChange:s=>g({...r,email:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"password",children:"كلمة المرور *"}),e.jsx(o,{id:"password",type:"password",value:r.password,onChange:s=>g({...r,password:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"phone",children:"الهاتف"}),e.jsx(o,{id:"phone",type:"tel",value:r.phone,onChange:s=>g({...r,phone:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"role",children:"الدور *"}),e.jsxs(K,{value:r.role,onValueChange:s=>g({...r,role:s}),children:[e.jsx(W,{children:e.jsx(X,{})}),e.jsxs(Y,{children:[e.jsx(m,{value:"customer",children:"عميل"}),e.jsx(m,{value:"affiliate",children:"مسوق"}),e.jsx(m,{value:"merchant",children:"تاجر"}),e.jsx(m,{value:"admin",children:"مدير"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"ملاحظة: دور الوسيط يمكن تفعيله للعملاء من خلال الجدول"})]})]}),e.jsxs($,{children:[e.jsx(d,{variant:"outline",onClick:()=>k(!1),children:"إلغاء"}),e.jsx(d,{onClick:de,children:"إنشاء الحساب"})]})]})}),e.jsx(P,{open:ne,onOpenChange:w,children:e.jsxs(U,{className:"sm:max-w-[500px]",dir:"rtl",children:[e.jsxs(I,{children:[e.jsx(A,{children:"تفعيل دور الوسيط"}),e.jsxs(M,{children:["تفعيل دور الوسيط لـ ",f?.name]})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-purple-900 dark:text-purple-100",children:[e.jsx("strong",{children:"العميل:"})," ",f?.name]}),e.jsxs("p",{className:"text-sm text-purple-900 dark:text-purple-100",children:[e.jsx("strong",{children:"البريد:"})," ",f?.email]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"intermediary-markup",children:"نسبة الترميز الافتراضية (%)"}),e.jsx(o,{id:"intermediary-markup",type:"number",min:"0",max:"100",value:E,onChange:s=>R(s.target.value),placeholder:"مثال: 20"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"النسبة التي سيتم إضافتها على سعر المنتج الأصلي"})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-blue-900 dark:text-blue-100",children:"ℹ️ سيتم توليد كود وسيط فريد تلقائياً"}),e.jsx("p",{className:"text-sm text-blue-900 dark:text-blue-100",children:"ℹ️ سيتمكن الوسيط من إضافة المنتجات من روابط خارجية"})]})]}),e.jsxs($,{children:[e.jsx(d,{variant:"outline",onClick:()=>{w(!1),T(null),R("20")},children:"إلغاء"}),e.jsx(d,{onClick:ce,className:"bg-purple-600 hover:bg-purple-700",children:"تفعيل الوسيط"})]})]})}),e.jsx(P,{open:D,onOpenChange:s=>{console.log("🔄 Dialog onOpenChange called:",s),S(s)},children:e.jsxs(U,{className:"max-w-md",onOpenAutoFocus:()=>{console.log("🎯 Dialog content rendered and focused")},children:[e.jsxs(I,{children:[e.jsx(A,{children:"تعديل بيانات المستخدم"}),e.jsx(M,{children:"قم بتعديل بيانات المستخدم وحفظ التغييرات"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-name",children:"الاسم"}),e.jsx(o,{id:"edit-name",value:a.name,onChange:s=>h({...a,name:s.target.value}),placeholder:"أدخل اسم المستخدم"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-email",children:"البريد الإلكتروني"}),e.jsx(o,{id:"edit-email",type:"email",value:a.email,onChange:s=>h({...a,email:s.target.value}),placeholder:"user@example.com"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-phone",children:"رقم الهاتف"}),e.jsx(o,{id:"edit-phone",value:a.phone,onChange:s=>h({...a,phone:s.target.value}),placeholder:"+20 123 456 7890"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-role",children:"الدور"}),e.jsxs("select",{id:"edit-role",className:"w-full p-2 border rounded-md bg-background",value:a.role,onChange:s=>xe(s.target.value),children:[e.jsx("option",{value:"customer",children:"عميل"}),e.jsx("option",{value:"affiliate",children:"مسوق بالعمولة"}),e.jsx("option",{value:"merchant",children:"تاجر"}),e.jsx("option",{value:"intermediary",children:"وسيط"}),e.jsx("option",{value:"admin",children:"مدير"})]}),a.role!==t?.role&&e.jsxs("p",{className:"text-xs text-orange-600 dark:text-orange-400 flex items-center gap-1",children:[e.jsx(H,{className:"h-3 w-3"}),"سيتم تطبيق الدور الجديد فوراً بدون مراجعة"]})]}),t?.isIntermediary&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(i,{htmlFor:"edit-markup",children:"نسبة الهامش الربحي الافتراضية (%)"}),e.jsx(o,{id:"edit-markup",type:"number",min:"0",max:"100",value:a.defaultMarkupPercentage,onChange:s=>h({...a,defaultMarkupPercentage:s.target.value}),placeholder:"20"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"النسبة التي سيتم إضافتها على سعر المنتج الأصلي"})]})]}),e.jsxs($,{children:[e.jsx(d,{variant:"outline",onClick:()=>{S(!1),L(null)},children:"إلغاء"}),e.jsx(d,{onClick:ue,className:"bg-blue-600 hover:bg-blue-700",children:"حفظ التعديلات"})]})]})}),e.jsx(P,{open:ie,onOpenChange:F,children:e.jsxs(U,{className:"sm:max-w-[500px]",dir:"rtl",children:[e.jsxs(I,{children:[e.jsxs(A,{className:"flex items-center gap-2 text-orange-600",children:[e.jsx(H,{className:"h-6 w-6"}),"تحذير: تغيير الدور"]}),e.jsx(M,{children:"يرجى قراءة التحذير التالي بعناية قبل المتابعة"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 p-4 rounded-lg",children:[e.jsxs("h3",{className:"font-bold text-red-800 dark:text-red-200 mb-2 flex items-center gap-2",children:[e.jsx(H,{className:"h-5 w-5"}),"تحذير هام"]}),e.jsxs("ul",{className:"space-y-2 text-sm text-red-700 dark:text-red-300",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-red-600 font-bold",children:"•"}),e.jsx("span",{children:"سيفقد المستخدم جميع البيانات المرتبطة بالدور القديم"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-red-600 font-bold",children:"•"}),e.jsx("span",{children:"سيتم حذف المنتجات، الطلبات، والإحصائيات القديمة"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-red-600 font-bold",children:"•"}),e.jsx("span",{children:"لا يمكن التراجع عن هذا الإجراء"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-red-600 font-bold",children:"•"}),e.jsx("span",{children:"سيتم تطبيق الدور الجديد فوراً بدون مراجعة"})]})]})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 border-2 border-blue-200 dark:border-blue-800 p-4 rounded-lg",children:[e.jsx("h3",{className:"font-bold text-blue-800 dark:text-blue-200 mb-2",children:"التغيير المطلوب:"}),e.jsxs("div",{className:"flex items-center justify-center gap-4 text-sm",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-1",children:"الدور الحالي"}),e.jsxs(z,{className:"text-base px-4 py-1",children:[t?.role==="customer"&&"عميل",t?.role==="affiliate"&&"مسوق",t?.role==="merchant"&&"تاجر",t?.role==="intermediary"&&"وسيط",t?.role==="admin"&&"مدير"]})]}),e.jsx("div",{className:"text-2xl text-muted-foreground",children:"→"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-1",children:"الدور الجديد"}),e.jsxs(z,{className:"text-base px-4 py-1 bg-green-100 text-green-800",children:[u==="customer"&&"عميل",u==="affiliate"&&"مسوق",u==="merchant"&&"تاجر",u==="intermediary"&&"وسيط",u==="admin"&&"مدير"]})]})]})]}),e.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-200 dark:border-yellow-800 p-4 rounded-lg",children:e.jsxs("p",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:["ℹ️ ",e.jsx("strong",{children:"ملاحظة:"})," سيتم تفعيل الحساب تلقائياً بالدور الجديد دون الحاجة لمراجعة الأدمن"]})})]}),e.jsxs($,{children:[e.jsx(d,{variant:"outline",onClick:()=>{F(!1),B(null)},children:"إلغاء"}),e.jsx(d,{onClick:he,className:"bg-red-600 hover:bg-red-700",children:"تأكيد التغيير"})]})]})})]})})}export{Te as default};
