import{w as te,b as re,r,a8 as d,a9 as n,a0 as S,j as e,b7 as ne,b8 as le,b9 as ie,C as x,e as k,f as A,g as h,U as B,s as l,I as ce,ap as oe,aq as de,ar as me,as as xe,at as P,B as c,D as F,i as _,k as q,l as H,b5 as he,v as je,m as fe,$ as ue,a as T}from"./index-Ce-RwxJS.js";import{T as pe,a as ge,b as z,c as j,d as ve,e as f}from"./table-DhT4s9qg.js";import{C as M}from"./clock-D_TAAEO_.js";import{P as w}from"./phone-D4T1FDJZ.js";import{C as Q}from"./circle-check-big-DrIPWHSB.js";import{C as V}from"./circle-x-Dru5y_zv.js";import{f as Ne}from"./formatDistanceToNow-BbsxV4jN.js";import{a as be}from"./ar-tf8aslgS.js";import"./en-US-BI35v3bL.js";import"./endOfMonth-L50Q6j7v.js";function Ee(){const{user:y}=te(),{toast:o}=re(),[m,G]=r.useState([]),[$,W]=r.useState([]),[X,E]=r.useState(!0),[u,J]=r.useState("all"),[p,K]=r.useState(""),[Y,g]=r.useState(!1),[a,C]=r.useState(null),[v,I]=r.useState(""),[Z,N]=r.useState(!1);r.useEffect(()=>{y&&D()},[y]),r.useEffect(()=>{ee()},[m,u,p]);const D=async()=>{try{E(!0);const s=await d.listDocuments(n.databaseId,n.collections.users,[S.equal("accountStatus","pending"),S.orderDesc("$createdAt"),S.limit(100)]);console.log("Pending users fetched:",s.documents),G(s.documents)}catch(s){console.error("Error fetching pending users:",s),o({title:"خطأ",description:"فشل في تحميل الحسابات المعلقة",variant:"destructive"})}finally{E(!1)}},ee=()=>{let s=[...m];if(u==="merchant"?s=s.filter(t=>t.isMerchant):u==="affiliate"&&(s=s.filter(t=>t.isAffiliate)),p){const t=p.toLowerCase();s=s.filter(i=>i.name.toLowerCase().includes(t)||i.email.toLowerCase().includes(t)||i.phone.includes(t))}W(s)},R=async(s,t)=>{try{const i={accountStatus:"approved",approvedAt:new Date().toISOString(),approvedBy:y?.$id,isActive:!0};await d.updateDocument(n.databaseId,n.collections.users,s,i);try{await d.createDocument(n.databaseId,"user_updates",ue.unique(),{userId:s,...i,timestamp:new Date().toISOString()})}catch{console.log("Sync collection not available, user will see update on next refresh")}try{await d.createDocument(n.databaseId,n.collections.notifications||"notifications","unique()",{userId:s,title:"🎉 تمت الموافقة على حسابك",message:"مرحباً بك! تم قبول حسابك ويمكنك الآن الاستفادة من جميع المميزات",type:"info",isRead:!1,link:"/dashboard"})}catch(O){console.error("Error creating notification:",O)}o({title:"✅ تمت الموافقة",description:`تم قبول حساب ${t} بنجاح. سيتم تحديث حالته تلقائياً.`}),D()}catch(i){console.error("Error approving account:",i),o({title:"خطأ",description:"فشل في الموافقة على الحساب",variant:"destructive"})}},se=async()=>{if(!a||!v.trim()){o({title:"خطأ",description:"يجب إدخال سبب الرفض",variant:"destructive"});return}try{await d.updateDocument(n.databaseId,n.collections.users,a.$id,{accountStatus:"rejected",rejectionReason:v,isActive:!1});try{await d.createDocument(n.databaseId,n.collections.notifications,"unique()",{userId:a.$id,title:"تحديث حول طلب حسابك",message:`عذراً، لم يتم قبول حسابك. السبب: ${v}`,type:"account_rejected",isRead:!1})}catch(s){console.error("Error creating notification:",s)}o({title:"تم الرفض",description:`تم رفض حساب ${a.name}`}),g(!1),C(null),I(""),D()}catch(s){console.error("Error rejecting account:",s),o({title:"خطأ",description:"فشل في رفض الحساب",variant:"destructive"})}},U=s=>{C(s),g(!0)},ae=s=>{C(s),N(!0)},L=s=>s.isMerchant?e.jsx(T,{className:"bg-brand-purple",children:"🏪 تاجر"}):s.isAffiliate?e.jsx(T,{className:"bg-brand-orange",children:"💰 مسوق"}):e.jsx(T,{variant:"secondary",children:"عميل"}),b=s=>`https://wa.me/${s.replace(/\D/g,"")}`;return X?e.jsxs(ne,{children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[...Array(3)].map((s,t)=>e.jsx(le,{},t))}),e.jsx("div",{className:"overflow-x-auto",children:e.jsx("table",{className:"min-w-full",children:e.jsx("tbody",{children:e.jsx(ie,{rows:8,cols:7})})})})]}):e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"الحسابات المعلقة"}),e.jsx("p",{className:"text-muted-foreground",children:"مراجعة والموافقة على حسابات التجار والمسوقين الجدد"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[e.jsxs(x,{children:[e.jsxs(k,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(A,{className:"text-sm font-medium",children:"إجمالي المعلقة"}),e.jsx(M,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(h,{children:e.jsx("div",{className:"text-2xl font-bold",children:m.length})})]}),e.jsxs(x,{children:[e.jsxs(k,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(A,{className:"text-sm font-medium",children:"التجار"}),e.jsx(B,{className:"h-4 w-4 text-brand-purple"})]}),e.jsx(h,{children:e.jsx("div",{className:"text-2xl font-bold",children:m.filter(s=>s.isMerchant).length})})]}),e.jsxs(x,{children:[e.jsxs(k,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(A,{className:"text-sm font-medium",children:"المسوقون"}),e.jsx(B,{className:"h-4 w-4 text-brand-orange"})]}),e.jsx(h,{children:e.jsx("div",{className:"text-2xl font-bold",children:m.filter(s=>s.isAffiliate).length})})]})]}),e.jsx(x,{className:"mb-6",children:e.jsx(h,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(l,{htmlFor:"search",children:"بحث"}),e.jsx(ce,{id:"search",placeholder:"ابحث بالاسم، البريد الإلكتروني، أو رقم الهاتف...",value:p,onChange:s=>K(s.target.value)})]}),e.jsxs("div",{className:"w-full md:w-48",children:[e.jsx(l,{htmlFor:"filter",children:"الفلتر"}),e.jsxs(oe,{value:u,onValueChange:s=>J(s),children:[e.jsx(de,{id:"filter",children:e.jsx(me,{})}),e.jsxs(xe,{children:[e.jsx(P,{value:"all",children:"الكل"}),e.jsx(P,{value:"merchant",children:"التجار فقط"}),e.jsx(P,{value:"affiliate",children:"المسوقون فقط"})]})]})]})]})})}),e.jsx(x,{children:e.jsx(h,{className:"pt-6",children:$.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(M,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"لا توجد حسابات معلقة"}),e.jsx("p",{className:"text-muted-foreground",children:"جميع الحسابات الجديدة تمت مراجعتها"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(pe,{children:[e.jsx(ge,{children:e.jsxs(z,{children:[e.jsx(j,{children:"المستخدم"}),e.jsx(j,{children:"النوع"}),e.jsx(j,{children:"التواصل"}),e.jsx(j,{children:"تاريخ التسجيل"}),e.jsx(j,{className:"text-left",children:"الإجراءات"})]})}),e.jsx(ve,{children:$.map(s=>e.jsxs(z,{children:[e.jsx(f,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.email})]})}),e.jsx(f,{children:L(s)}),e.jsx(f,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("a",{href:b(s.phone),target:"_blank",rel:"noopener noreferrer",className:"text-sm text-green-600 hover:underline flex items-center gap-1",children:[e.jsx(w,{className:"h-3 w-3"}),s.phone]}),s.alternativePhone&&e.jsxs("a",{href:b(s.alternativePhone),target:"_blank",rel:"noopener noreferrer",className:"text-xs text-muted-foreground hover:underline flex items-center gap-1",children:[e.jsx(w,{className:"h-3 w-3"}),s.alternativePhone]})]})}),e.jsx(f,{children:e.jsx("div",{className:"text-sm",children:Ne(new Date(s.$createdAt),{addSuffix:!0,locale:be})})}),e.jsx(f,{children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(c,{size:"sm",variant:"outline",onClick:()=>ae(s),children:"عرض"}),e.jsxs(c,{size:"sm",variant:"default",className:"bg-green-600 hover:bg-green-700",onClick:()=>R(s.$id,s.name),children:[e.jsx(Q,{className:"h-4 w-4 mr-1"}),"موافقة"]}),e.jsxs(c,{size:"sm",variant:"destructive",onClick:()=>U(s),children:[e.jsx(V,{className:"h-4 w-4 mr-1"}),"رفض"]})]})})]},s.$id))})]})})})}),e.jsx(F,{open:Y,onOpenChange:g,children:e.jsxs(_,{children:[e.jsxs(q,{children:[e.jsx(H,{children:"رفض الحساب"}),e.jsxs(he,{children:["يرجى توضيح سبب رفض حساب ",a?.name]})]}),e.jsxs("div",{className:"py-4",children:[e.jsx(l,{htmlFor:"reason",children:"سبب الرفض"}),e.jsx(je,{id:"reason",placeholder:"اكتب السبب بوضوح...",value:v,onChange:s=>I(s.target.value),rows:4,className:"mt-2"})]}),e.jsxs(fe,{children:[e.jsx(c,{variant:"outline",onClick:()=>g(!1),children:"إلغاء"}),e.jsx(c,{variant:"destructive",onClick:se,children:"تأكيد الرفض"})]})]})}),e.jsx(F,{open:Z,onOpenChange:N,children:e.jsxs(_,{className:"max-w-2xl",children:[e.jsx(q,{children:e.jsx(H,{children:"تفاصيل الحساب"})}),a&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"الاسم"}),e.jsx("p",{className:"font-medium",children:a.name})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"نوع الحساب"}),e.jsx("div",{className:"mt-1",children:L(a)})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"البريد الإلكتروني"}),e.jsx("p",{className:"font-medium",children:a.email})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"رقم الهاتف"}),e.jsxs("a",{href:b(a.phone),target:"_blank",rel:"noopener noreferrer",className:"font-medium text-green-600 hover:underline flex items-center gap-1",children:[e.jsx(w,{className:"h-4 w-4"}),a.phone]})]}),a.alternativePhone&&e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"رقم بديل"}),e.jsxs("a",{href:b(a.alternativePhone),target:"_blank",rel:"noopener noreferrer",className:"font-medium text-green-600 hover:underline flex items-center gap-1",children:[e.jsx(w,{className:"h-4 w-4"}),a.alternativePhone]})]}),a.affiliateCode&&e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"كود المسوق"}),e.jsx("p",{className:"font-medium font-mono",children:a.affiliateCode})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"تاريخ التسجيل"}),e.jsx("p",{className:"font-medium",children:new Date(a.$createdAt).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(c,{className:"flex-1 bg-green-600 hover:bg-green-700",onClick:()=>{R(a.$id,a.name),N(!1)},children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"موافقة"]}),e.jsxs(c,{className:"flex-1",variant:"destructive",onClick:()=>{N(!1),U(a)},children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"رفض"]})]})]})]})})]})}export{Ee as default};
