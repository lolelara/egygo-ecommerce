import{r,j as e,U as be,k as Ne,bG as ye,a$ as Ce,s as we,bK as Se,bL as ke}from"./vendor-react-BMq-IxHG.js";import{A as Ie}from"./AdminLayout-CiOyboKW.js";import{o as Ee,u as Me,d as h,C as Ae,r as $e,s as De,f as Re,I as k,e as i,m as K,L as N,c as A,B as ze}from"./index-C03DQAFm.js";import{Q as U,I as J}from"./vendor-appwrite-BGb_FC-V.js";import{S as W,a as X,b as Y,c as Z,d as f}from"./select-DviCdAOP.js";import"./vendor-ui-BA32w1ww.js";import"./vendor-query-GexG3wnZ.js";import"./vendor-other-C5r3s8Py.js";import"./vendor-animations-W1Z2cmit.js";import"./avatar-DgllixpV.js";const y=void 0;function Qe(){const{user:Ue}=Ee(),{toast:n}=Me(),[B,ee]=r.useState([]),[se,L]=r.useState(!1),[$,te]=r.useState(""),[p,ae]=r.useState(""),[j,le]=r.useState("all"),[c,I]=r.useState(1),[D,re]=r.useState(0),C=25,[o,g]=r.useState(new Set),[w,T]=r.useState(""),[ie,R]=r.useState(!1),[E,ne]=r.useState("customer"),[ce,P]=r.useState(!1),[v,_]=r.useState(null),[l,b]=r.useState({name:"",email:"",phone:"",role:"customer"}),[oe,q]=r.useState(!1),[d,F]=r.useState(null),[z,V]=r.useState("20");r.useEffect(()=>{const s=setTimeout(()=>{ae($),I(1)},300);return()=>clearTimeout(s)},[$]),r.useEffect(()=>{u()},[c,p,j]);const u=r.useCallback(async()=>{L(!0);try{const s=[U.limit(C),U.offset((c-1)*C),U.orderDesc("$createdAt")],t=await h.listDocuments(y,"users",s);console.log("✅ Loaded users:",t.documents.length),ee(t.documents),re(t.total)}catch(s){console.error("Error loading users:",s),n({title:"خطأ",description:"فشل تحميل المستخدمين",variant:"destructive"})}finally{L(!1)}},[c,p,j]),de=s=>{console.log("Opening edit modal for:",s.name),_(s),b({name:s.name||"",email:s.email||"",phone:s.phone||"",role:s.role||"customer"}),P(!0)},G=()=>{P(!1),_(null),b({name:"",email:"",phone:"",role:"customer"})},me=async()=>{if(v)try{const s={name:l.name,email:l.email,phone:l.phone||""};if(s.isAffiliate=l.role==="affiliate",s.isMerchant=l.role==="merchant",s.isIntermediary=l.role==="intermediary",await h.updateDocument(y,"users",v.$id,s),l.role!==v.role){const t={customer:"عميل",merchant:"تاجر",affiliate:"مسوق",intermediary:"وسيط",admin:"مدير"},a=t[v.role]||v.role,m=t[l.role]||l.role;try{await h.createDocument(A.databaseId,A.collections.notifications,J.unique(),{userId:v.userId,title:"🎉 تم تحديث دورك بنجاح",message:`تم تغيير دورك من ${a} إلى ${m}. يمكنك الآن الوصول إلى المميزات الجديدة!`,type:"success",isRead:!1,link:l.role==="merchant"?"/merchant/dashboard":l.role==="affiliate"?"/affiliate/dashboard":l.role==="intermediary"?"/intermediary/dashboard":l.role==="admin"?"/admin/dashboard":"/"}),console.log("✅ Role change notification sent")}catch(M){console.error("Error sending notification:",M)}}n({title:"نجح",description:"تم تحديث بيانات المستخدم بنجاح"}),G(),u()}catch(s){console.error("Error updating user:",s),n({title:"خطأ",description:"فشل تحديث بيانات المستخدم",variant:"destructive"})}},he=s=>{console.log("Opening intermediary modal for:",s.name),F(s),q(!0)},O=()=>{q(!1),F(null),V("20")},ue=async()=>{if(d)try{const s=`INT${Date.now()}`;await h.updateDocument(y,"users",d.$id,{isIntermediary:!0,affiliateCode:s,commissionRate:parseFloat(z)/100}),console.log("✅ Intermediary activated");try{await h.createDocument(A.databaseId,A.collections.notifications,J.unique(),{userId:d.userId,title:"🎉 مبروك! تم تفعيلك كوسيط",message:`تم تفعيل حسابك كوسيط بنجاح! كود الوسيط الخاص بك: ${s}. نسبة الهامش الافتراضية: ${z}%. يمكنك الآن إنشاء روابط خاصة بك وإضافة هامش ربح على المنتجات.`,type:"success",isRead:!1,link:"/intermediary/dashboard"}),console.log("✅ Intermediary activation notification sent")}catch(t){console.error("Error sending notification:",t)}n({title:"نجح",description:`تم تفعيل ${d.name} كوسيط بنجاح`}),O(),u()}catch(s){console.error("Error activating intermediary:",s),n({title:"خطأ",description:"فشل تفعيل الوسيط",variant:"destructive"})}},xe=async(s,t)=>{if(confirm(`هل أنت متأكد من حذف ${t}؟`))try{await h.deleteDocument(y,"users",s),n({title:"نجح",description:"تم حذف المستخدم بنجاح"}),u()}catch(a){console.error("Error deleting user:",a),n({title:"خطأ",description:"فشل حذف المستخدم",variant:"destructive"})}},fe=s=>{const t=new Set(o);t.has(s)?t.delete(s):t.add(s),g(t)},pe=()=>{o.size===S.length?g(new Set):g(new Set(S.map(s=>s.$id)))},je=async()=>{if(o.size===0){n({title:"تنبيه",description:"الرجاء اختيار مستخدم واحد على الأقل",variant:"destructive"});return}if(!w){n({title:"تنبيه",description:"الرجاء اختيار إجراء",variant:"destructive"});return}if(w==="delete"){if(!confirm(`هل أنت متأكد من حذف ${o.size} مستخدم؟`))return;let s=0,t=0;for(const a of o)try{await h.deleteDocument(y,"users",a),s++}catch(m){console.error("Error deleting user:",a,m),t++}n({title:"تم",description:`تم حذف ${s} مستخدم، فشل ${t}`}),g(new Set),u()}else w==="change_role"&&R(!0)},ge=async()=>{let s=0,t=0;for(const a of o)try{const m={isAffiliate:E==="affiliate",isMerchant:E==="merchant",isIntermediary:E==="intermediary"};await h.updateDocument(y,"users",a,m),s++}catch(m){console.error("Error updating user role:",a,m),t++}n({title:"تم",description:`تم تحديث ${s} مستخدم، فشل ${t}`}),g(new Set),R(!1),T(""),u()},ve=s=>{let t="عميل",a="bg-gray-100 text-gray-800";return s.isAffiliate&&(t="مسوق",a="bg-green-100 text-green-800"),s.isMerchant&&(t="تاجر",a="bg-blue-100 text-blue-800"),s.isIntermediary&&(t="وسيط",a="bg-purple-100 text-purple-800"),(s.email==="admin@egygo.com"||s.role==="admin")&&(t="مدير",a="bg-red-100 text-red-800"),e.jsx(ze,{className:a,children:t})},S=r.useMemo(()=>B.filter(s=>{var M,Q,H;const t=((M=s.name)==null?void 0:M.toLowerCase().includes(p.toLowerCase()))||((Q=s.email)==null?void 0:Q.toLowerCase().includes(p.toLowerCase()))||((H=s.phone)==null?void 0:H.includes(p));let a="customer";return s.isAffiliate&&(a="affiliate"),s.isMerchant&&(a="merchant"),s.isIntermediary&&(a="intermediary"),s.email==="admin@egygo.com"&&(a="admin"),t&&(j==="all"||a===j)}),[B,p,j]),x=Math.ceil(D/C);return e.jsxs(Ie,{children:[e.jsxs(Ae,{children:[e.jsx($e,{children:e.jsxs(De,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-6 w-6"}),"إدارة المستخدمين والشركاء"]})}),e.jsxs(Re,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(k,{placeholder:"بحث بالاسم أو البريد أو الهاتف...",value:$,onChange:s=>te(s.target.value),className:"pl-10"})]}),e.jsx("div",{children:e.jsxs("select",{className:"w-full p-2 border rounded-md",value:j,onChange:s=>le(s.target.value),children:[e.jsx("option",{value:"all",children:"جميع الأدوار"}),e.jsx("option",{value:"customer",children:"عملاء"}),e.jsx("option",{value:"merchant",children:"تجار"}),e.jsx("option",{value:"affiliate",children:"مسوقين"}),e.jsx("option",{value:"intermediary",children:"وسطاء"}),e.jsx("option",{value:"admin",children:"مدراء"})]})}),e.jsx(i,{onClick:()=>u(),variant:"outline",children:"تحديث القائمة"})]}),o.size>0&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"font-semibold text-blue-900",children:["تم اختيار ",o.size," مستخدم"]}),e.jsx(i,{variant:"outline",size:"sm",onClick:()=>g(new Set),children:"إلغاء الاختيار"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(W,{value:w,onValueChange:T,children:[e.jsx(X,{className:"w-[200px]",children:e.jsx(Y,{placeholder:"اختر إجراء..."})}),e.jsxs(Z,{children:[e.jsx(f,{value:"change_role",children:"تغيير الدور"}),e.jsx(f,{value:"delete",children:"حذف المستخدمين"})]})]}),e.jsx(i,{onClick:je,disabled:!w,className:"bg-blue-600 hover:bg-blue-700",children:"تطبيق"})]})]})}),se?e.jsx("div",{className:"text-center py-8",children:"جاري التحميل..."}):e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-center p-2 w-12",children:e.jsx(K,{checked:o.size===S.length&&S.length>0,onCheckedChange:pe})}),e.jsx("th",{className:"text-right p-2",children:"الاسم"}),e.jsx("th",{className:"text-right p-2",children:"البريد"}),e.jsx("th",{className:"text-right p-2",children:"الهاتف"}),e.jsx("th",{className:"text-right p-2",children:"الدور"}),e.jsx("th",{className:"text-right p-2",children:"الكود"}),e.jsx("th",{className:"text-right p-2",children:"الإجراءات"})]})}),e.jsx("tbody",{children:S.map(s=>e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"p-2 text-center",children:e.jsx(K,{checked:o.has(s.$id),onCheckedChange:()=>fe(s.$id)})}),e.jsx("td",{className:"p-2",children:s.name}),e.jsx("td",{className:"p-2",children:s.email}),e.jsx("td",{className:"p-2",children:s.phone||"-"}),e.jsx("td",{className:"p-2",children:ve(s)}),e.jsx("td",{className:"p-2",children:e.jsx("code",{className:"text-xs bg-gray-100 px-2 py-1 rounded",children:s.affiliateCode||"-"})}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex gap-2",children:[!s.isIntermediary&&!s.isMerchant&&!s.isAffiliate&&e.jsx(i,{size:"sm",className:"bg-purple-600 hover:bg-purple-700 text-white",onClick:()=>he(s),children:"تفعيل وسيط"}),e.jsx(i,{size:"sm",variant:"outline",onClick:()=>de(s),children:e.jsx(ye,{className:"h-4 w-4"})}),e.jsx(i,{size:"sm",variant:"destructive",onClick:()=>xe(s.$id,s.name),children:e.jsx(Ce,{className:"h-4 w-4"})})]})})]},s.$id))})]}),x>1&&e.jsxs("div",{className:"flex items-center justify-between mt-6 pt-4 border-t",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["عرض ",(c-1)*C+1," إلى ",Math.min(c*C,D)," من ",D," مستخدم"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>I(s=>Math.max(1,s-1)),disabled:c===1,children:[e.jsx(we,{className:"h-4 w-4"}),"السابق"]}),e.jsx("div",{className:"flex items-center gap-1",children:Array.from({length:Math.min(5,x)},(s,t)=>{let a;return x<=5||c<=3?a=t+1:c>=x-2?a=x-4+t:a=c-2+t,e.jsx(i,{variant:c===a?"default":"outline",size:"sm",onClick:()=>I(a),className:"w-8 h-8 p-0",children:a},a)})}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>I(s=>Math.min(x,s+1)),disabled:c===x,children:["التالي",e.jsx(Se,{className:"h-4 w-4"})]})]})]})]})]})]}),ce&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"تعديل بيانات المستخدم"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(N,{children:"الاسم"}),e.jsx(k,{value:l.name,onChange:s=>b({...l,name:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(N,{children:"البريد الإلكتروني"}),e.jsx(k,{type:"email",value:l.email,onChange:s=>b({...l,email:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(N,{children:"رقم الهاتف"}),e.jsx(k,{value:l.phone,onChange:s=>b({...l,phone:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(N,{children:"الدور"}),e.jsxs("select",{className:"w-full p-2 border rounded-md",value:l.role,onChange:s=>b({...l,role:s.target.value}),children:[e.jsx("option",{value:"customer",children:"عميل"}),e.jsx("option",{value:"merchant",children:"تاجر"}),e.jsx("option",{value:"affiliate",children:"مسوق"}),e.jsx("option",{value:"intermediary",children:"وسيط"}),e.jsx("option",{value:"admin",children:"مدير"})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-6",children:[e.jsx(i,{onClick:G,variant:"outline",children:"إلغاء"}),e.jsx(i,{onClick:me,children:"حفظ التغييرات"})]})]})}),oe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"تفعيل دور الوسيط"}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg mb-4",children:[e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"العميل:"})," ",d==null?void 0:d.name]}),e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"البريد:"})," ",d==null?void 0:d.email]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx(N,{children:"نسبة الهامش الافتراضية (%)"}),e.jsx(k,{type:"number",min:"0",max:"100",value:z,onChange:s=>V(s.target.value),placeholder:"20"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"النسبة التي سيتم إضافتها على سعر المنتج الأصلي"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(i,{onClick:O,variant:"outline",children:"إلغاء"}),e.jsx(i,{onClick:ue,className:"bg-purple-600 hover:bg-purple-700",children:"تفعيل الوسيط"})]})]})}),ie&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsxs("h2",{className:"text-xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(ke,{className:"h-6 w-6"}),"تغيير الدور لـ ",o.size," مستخدم"]}),e.jsx("div",{className:"bg-blue-50 p-4 rounded-lg mb-4",children:e.jsx("p",{className:"text-sm text-blue-900",children:"سيتم تغيير دور جميع المستخدمين المحددين إلى الدور الجديد"})}),e.jsxs("div",{className:"mb-4",children:[e.jsx(N,{children:"الدور الجديد"}),e.jsxs(W,{value:E,onValueChange:ne,children:[e.jsx(X,{children:e.jsx(Y,{})}),e.jsxs(Z,{children:[e.jsx(f,{value:"customer",children:"عميل"}),e.jsx(f,{value:"merchant",children:"تاجر"}),e.jsx(f,{value:"affiliate",children:"مسوق"}),e.jsx(f,{value:"intermediary",children:"وسيط"}),e.jsx(f,{value:"admin",children:"مدير"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(i,{onClick:()=>R(!1),variant:"outline",children:"إلغاء"}),e.jsx(i,{onClick:ge,className:"bg-blue-600 hover:bg-blue-700",children:"تطبيق التغيير"})]})]})})]})}export{Qe as default};
