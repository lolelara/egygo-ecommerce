import{r as h,j as e,bd as z,U as J,p as K,c0 as B,o as X,n as Y,_ as Z}from"./vendor-react-CCFRLLzk.js";import{d as y,e as C,f as $,C as m,x as j,y as f,h as g,P as A,B as ee}from"./index-D-h96Znd.js";import{a as te,D as se}from"./LoadingSkeletons-DwEzCxyX.js";import{Q as i}from"./vendor-appwrite-CuqfvTq9.js";import{U as D,Z as M,av as O,aw as re,ax as U,ay as L,az as E,aA as R,aB as I,aC as F,aD as ae,aE as ne,aF as oe,aG as ce,aH as le,aJ as ie,aK as de}from"./vendor-other-CzBBjgu5.js";import"./vendor-ui-BA32w1ww.js";import"./vendor-query-j_rPqiug.js";import"./vendor-animations-CPHPqPXb.js";import"./skeleton-udMvYfU3.js";const p=C.databaseId,T=C.collections.orders,ue=C.collections.products,q=C.collections.users,xe=C.collections.orderItems;async function he(a=30){try{const r=new Date,l=D(r,a),u=await y.listDocuments(p,T,[i.greaterThanEqual("$createdAt",l.toISOString()),i.lessThanEqual("$createdAt",r.toISOString()),i.limit(1e3)]),s=new Map;u.documents.forEach(t=>{const c=M(new Date(t.$createdAt),"yyyy-MM-dd"),o=s.get(c)||{sales:0,orders:0,revenue:0};o.orders+=1,o.revenue+=t.totalAmount||0,o.sales+=t.totalAmount||0,s.set(c,o)});const n=[];for(let t=0;t<a;t++){const c=M(D(r,a-t-1),"yyyy-MM-dd"),o=s.get(c)||{sales:0,orders:0,revenue:0};n.push({date:c,...o})}return n}catch(r){throw console.error("Error fetching daily sales:",r),r}}async function me(a=10){try{const r=await y.listDocuments(p,xe,[i.limit(1e3)]),l=new Map;return r.documents.forEach(s=>{const n=s.productId,t=l.get(n)||{productId:n,productName:s.productName||"Unknown Product",totalSales:0,totalRevenue:0,totalOrders:0};t.totalSales+=s.quantity||0,t.totalRevenue+=(s.price||0)*(s.quantity||0),t.totalOrders+=1,l.set(n,t)}),Array.from(l.values()).sort((s,n)=>n.totalRevenue-s.totalRevenue).slice(0,a)}catch(r){throw console.error("Error fetching product performance:",r),r}}async function je(){try{const a=await y.listDocuments(p,T,[i.limit(1e3)]),r=new Map;let l=0;return a.documents.forEach(s=>{const n=s.status||"pending";r.set(n,(r.get(n)||0)+1),l+=1}),Array.from(r.entries()).map(([s,n])=>({status:s,count:n,percentage:l>0?n/l*100:0}))}catch(a){throw console.error("Error fetching order status distribution:",a),a}}async function fe(a=30){try{const r=new Date,l=D(r,a),u=await y.listDocuments(p,q,[i.limit(1e3)]),s=new Map;let n=0;u.documents.forEach(c=>{const o=new Date(c.$createdAt);if(o>=l){const d=M(o,"yyyy-MM-dd");s.set(d,(s.get(d)||0)+1)}});const t=[];for(let c=0;c<a;c++){const o=M(D(r,a-c-1),"yyyy-MM-dd"),d=s.get(o)||0;n+=d,t.push({date:o,totalUsers:n,newUsers:d})}return t}catch(r){throw console.error("Error fetching user growth:",r),r}}async function ge(){try{const a=new Date,r=D(a,30),l=D(a,60),[u,s,n,t]=await Promise.all([y.listDocuments(p,T,[i.greaterThanEqual("$createdAt",r.toISOString()),i.limit(1e3)]),y.listDocuments(p,T,[i.greaterThanEqual("$createdAt",l.toISOString()),i.lessThan("$createdAt",r.toISOString()),i.limit(1e3)]),y.listDocuments(p,ue,[i.limit(1e3)]),y.listDocuments(p,q,[i.limit(1e3)])]),c=u.documents.reduce((b,S)=>b+(S.totalAmount||0),0),o=s.documents.reduce((b,S)=>b+(S.totalAmount||0),0),d=u.documents.length,v=s.documents.length,k=o>0?(c-o)/o*100:0,N=v>0?(d-v)/v*100:0,G=d>0?c/d:0;return{totalRevenue:c,totalOrders:d,totalProducts:n.total,totalUsers:t.total,revenueGrowth:k,ordersGrowth:N,avgOrderValue:G}}catch(a){throw console.error("Error fetching analytics summary:",a),a}}const P=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#ec4899"];function Ee(){const[a,r]=h.useState(!0),[l,u]=h.useState(null),[s,n]=h.useState(30),[t,c]=h.useState(null),[o,d]=h.useState([]),[v,k]=h.useState([]),[N,G]=h.useState([]),[b,S]=h.useState([]),[ye,pe]=h.useState([]);h.useEffect(()=>{_()},[s]);async function _(){r(!0),u(null);try{const[x,w,Q,V,W]=await Promise.all([ge(),he(s),me(s),je(),fe(s)]);c(x),d(w),k(Q),G(V),S(W)}catch(x){u(x.message||"حدث خطأ أثناء تحميل البيانات")}finally{r(!1)}}const H=()=>{alert("سيتم إضافة تصدير PDF قريباً")};return a?e.jsx(te,{children:e.jsx(se,{count:4})}):l?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen",children:[e.jsx("div",{className:"text-red-500 text-xl mb-4",children:l}),e.jsx($,{onClick:_,children:"إعادة المحاولة"})]}):e.jsxs("div",{className:"container mx-auto p-6 space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"لوحة التحليلات المتقدمة"}),e.jsx("p",{className:"text-muted-foreground",children:"نظرة شاملة على أداء المتجر"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("select",{value:s,onChange:x=>n(Number(x.target.value)),className:"px-4 py-2 border rounded-lg",children:[e.jsx("option",{value:7,children:"آخر 7 أيام"}),e.jsx("option",{value:30,children:"آخر 30 يوم"}),e.jsx("option",{value:90,children:"آخر 90 يوم"})]}),e.jsxs($,{onClick:H,variant:"outline",children:[e.jsx(z,{className:"w-4 h-4 ml-2"}),"تصدير PDF"]})]})]}),t&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(m,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(f,{className:"text-sm font-medium",children:"إجمالي المستخدمين"}),e.jsx(J,{className:"w-4 h-4 text-muted-foreground"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.totalUsers}),t.revenueGrowth!==void 0&&e.jsxs("div",{className:"flex items-center text-sm",children:[t.revenueGrowth>=0?e.jsx(K,{className:"w-4 h-4 text-green-500 ml-1"}):e.jsx(B,{className:"w-4 h-4 text-red-500 ml-1"}),e.jsxs("span",{className:t.revenueGrowth>=0?"text-green-500":"text-red-500",children:[Math.abs(t.revenueGrowth).toFixed(1),"%"]}),e.jsx("span",{className:"text-muted-foreground mr-1",children:"عن الفترة السابقة"})]})]})]}),e.jsxs(m,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(f,{className:"text-sm font-medium",children:"إجمالي الطلبات"}),e.jsx(X,{className:"w-4 h-4 text-muted-foreground"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.totalOrders}),t.ordersGrowth!==void 0&&e.jsxs("div",{className:"flex items-center text-sm",children:[t.ordersGrowth>=0?e.jsx(K,{className:"w-4 h-4 text-green-500 ml-1"}):e.jsx(B,{className:"w-4 h-4 text-red-500 ml-1"}),e.jsxs("span",{className:t.ordersGrowth>=0?"text-green-500":"text-red-500",children:[Math.abs(t.ordersGrowth).toFixed(1),"%"]}),e.jsx("span",{className:"text-muted-foreground mr-1",children:"عن الفترة السابقة"})]})]})]}),e.jsxs(m,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(f,{className:"text-sm font-medium",children:"إجمالي المنتجات"}),e.jsx(Y,{className:"w-4 h-4 text-muted-foreground"})]}),e.jsxs(g,{children:[e.jsx("div",{className:"text-2xl font-bold",children:t.totalProducts}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"منتج متاح"})]})]}),e.jsxs(m,{children:[e.jsxs(j,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(f,{className:"text-sm font-medium",children:"متوسط قيمة الطلب"}),e.jsx(Z,{className:"w-4 h-4 text-muted-foreground"})]}),e.jsxs(g,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[t.avgOrderValue.toFixed(2)," ج.م"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"لكل طلب"})]})]})]}),e.jsxs(m,{children:[e.jsxs(j,{children:[e.jsx(f,{children:"المبيعات اليومية"}),e.jsx(A,{children:"تتبع الإيرادات والطلبات بمرور الوقت"})]}),e.jsx(g,{children:e.jsx(O,{width:"100%",height:350,children:e.jsxs(re,{data:o,children:[e.jsx(U,{strokeDasharray:"3 3"}),e.jsx(L,{dataKey:"date"}),e.jsx(E,{yAxisId:"left"}),e.jsx(E,{yAxisId:"right",orientation:"left"}),e.jsx(R,{}),e.jsx(I,{}),e.jsx(F,{yAxisId:"left",type:"monotone",dataKey:"revenue",stroke:"#3b82f6",name:"الإيرادات (ج.م)",strokeWidth:2}),e.jsx(F,{yAxisId:"right",type:"monotone",dataKey:"orders",stroke:"#10b981",name:"عدد الطلبات",strokeWidth:2})]})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(m,{children:[e.jsxs(j,{children:[e.jsx(f,{children:"أداء المنتجات"}),e.jsx(A,{children:"أفضل 10 منتجات مبيعاً"})]}),e.jsx(g,{children:e.jsx(O,{width:"100%",height:300,children:e.jsxs(ae,{data:v,children:[e.jsx(U,{strokeDasharray:"3 3"}),e.jsx(L,{dataKey:"productName",angle:-45,textAnchor:"end",height:100}),e.jsx(E,{}),e.jsx(R,{}),e.jsx(I,{}),e.jsx(ne,{dataKey:"totalRevenue",fill:"#3b82f6",name:"الإيرادات (ج.م)"})]})})})]}),e.jsxs(m,{children:[e.jsxs(j,{children:[e.jsx(f,{children:"توزيع حالة الطلبات"}),e.jsx(A,{children:"نظرة عامة على حالات الطلبات"})]}),e.jsxs(g,{children:[e.jsx(O,{width:"100%",height:300,children:e.jsxs(oe,{children:[e.jsx(ce,{data:N,dataKey:"count",nameKey:"status",cx:"50%",cy:"50%",outerRadius:80,label:!0,children:N.map((x,w)=>e.jsx(le,{fill:P[w%P.length]},`cell-${w}`))}),e.jsx(R,{}),e.jsx(I,{})]})}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-4",children:N.map((x,w)=>e.jsxs(ee,{style:{backgroundColor:P[w%P.length]},children:[x.status,": ",x.count]},x.status))})]})]})]}),e.jsxs(m,{children:[e.jsxs(j,{children:[e.jsx(f,{children:"نمو المستخدمين"}),e.jsx(A,{children:"عدد المستخدمين الجدد بمرور الوقت"})]}),e.jsx(g,{children:e.jsx(O,{width:"100%",height:300,children:e.jsxs(ie,{data:b,children:[e.jsx(U,{strokeDasharray:"3 3"}),e.jsx(L,{dataKey:"date"}),e.jsx(E,{}),e.jsx(R,{}),e.jsx(I,{}),e.jsx(de,{type:"monotone",dataKey:"users",stroke:"#3b82f6",fill:"#3b82f6",name:"المستخدمون الجدد"})]})})})]})]})}export{Ee as default};
