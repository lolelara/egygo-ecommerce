import{d as o,c as d}from"./index-C03DQAFm.js";import{Q as u,I as p}from"./vendor-appwrite-BGb_FC-V.js";const n=d.databaseId,s="coupons";class g{async getAllCoupons(){try{return(await o.listDocuments(n,s,[u.orderDesc("$createdAt")])).documents}catch(t){return console.error("Error fetching coupons:",t),[]}}async getActiveCoupons(){try{return(await o.listDocuments(n,s,[u.equal("isActive",!0),u.greaterThan("validUntil",new Date().toISOString()),u.orderDesc("$createdAt")])).documents}catch(t){return console.error("Error fetching active coupons:",t),[]}}async createCoupon(t){try{return await o.createDocument(n,s,p.unique(),{...t,code:t.code.toUpperCase(),usedCount:0,isActive:!0})}catch(e){return console.error("Error creating coupon:",e),null}}async updateCoupon(t,e){try{return await o.updateDocument(n,s,t,e),!0}catch(a){return console.error("Error updating coupon:",a),!1}}async deleteCoupon(t){try{return await o.deleteDocument(n,s,t),!0}catch(e){return console.error("Error deleting coupon:",e),!1}}async validateCoupon(t,e){try{const a=await o.listDocuments(n,s,[u.equal("code",t.toUpperCase()),u.equal("isActive",!0)]);if(a.documents.length===0)return{valid:!1,message:"الكوبون غير موجود أو غير نشط"};const r=a.documents[0],i=new Date,l=new Date(r.validFrom),m=new Date(r.validUntil);if(i<l)return{valid:!1,message:"الكوبون لم يبدأ بعد"};if(i>m)return{valid:!1,message:"انتهت صلاحية الكوبون"};if(r.maxUses&&r.usedCount>=r.maxUses)return{valid:!1,message:"تم استخدام الكوبون بالكامل"};if(r.minAmount&&e<r.minAmount)return{valid:!1,message:`الحد الأدنى للطلب ${r.minAmount} ج.م`};let c=0;return r.type==="percentage"?c=e*r.value/100:c=r.value,c=Math.min(c,e),{valid:!0,coupon:r,discount:c,message:`تم تطبيق خصم ${c.toFixed(2)} ج.م`}}catch(a){return console.error("Error validating coupon:",a),{valid:!1,message:"حدث خطأ في التحقق من الكوبون"}}}async incrementUsage(t){try{const e=await o.getDocument(n,s,t);return await o.updateDocument(n,s,t,{usedCount:(e.usedCount||0)+1}),!0}catch(e){return console.error("Error incrementing coupon usage:",e),!1}}async getCouponStats(t){try{const e=await o.getDocument(n,s,t),a=e.maxUses?e.maxUses-e.usedCount:1/0;return{totalUses:e.usedCount,remainingUses:a===1/0?-1:a,totalDiscount:0}}catch(e){return console.error("Error fetching coupon stats:",e),{totalUses:0,remainingUses:0,totalDiscount:0}}}async toggleActive(t){try{const e=await o.getDocument(n,s,t);return await o.updateDocument(n,s,t,{isActive:!e.isActive}),!0}catch(e){return console.error("Error toggling coupon status:",e),!1}}}const D=new g;export{D as c};
