import{a8 as c,a9 as ae,a0 as d,$ as G,w as se,r as x,j as e,C as D,e as F,f as O,a6 as V,g as E,a2 as re,a3 as ne,a4 as J,a5 as W,s as T,I as H,B as h,az as ie,am as le,a as A,u as N,b as ce,p as oe,x as de,y as X,E as Y,P as xe,ap as ue,aq as me,ar as he,as as pe,at as fe,N as ge,J as je,aa as Ne,ab as ke,T as ve,aA as ye}from"./index-Ce-RwxJS.js";import{T as we,a as be,b as Z,c as v,d as Ce,e as y}from"./table-DhT4s9qg.js";import{Q as Le}from"./browser-JDKD6dIQ.js";import{L as I}from"./link-eq3syxrq.js";import{C as te}from"./copy-CCGvNwUs.js";import{D as Se}from"./download-UgG-gTV9.js";import{E as De}from"./external-link-BlE5MYZK.js";const m=ae.databaseId,L="affiliate_links",z="affiliate_clicks",Ee="affiliate_conversions";class Ae{async getAffiliateLinks(a){try{return(await c.listDocuments(m,L,[d.equal("affiliateId",a),d.orderDesc("$createdAt")])).documents}catch(t){return console.error("Error fetching affiliate links:",t),[]}}async createLink(a,t,i,o){try{return await c.createDocument(m,L,G.unique(),{affiliateId:a,linkCode:t,url:i,productId:o||null,clicks:0,conversions:0,earnings:0,createdAt:new Date().toISOString()})}catch(l){return console.error("Error creating affiliate link:",l),null}}async trackClick(a,t,i,o,l,f){try{await c.createDocument(m,z,G.unique(),{affiliateId:a,linkId:t,productId:i||null,ipAddress:o||null,userAgent:l||null,referrer:f||null,clickedAt:new Date().toISOString()});const u=await c.getDocument(m,L,t);await c.updateDocument(m,L,t,{clicks:(u.clicks||0)+1})}catch(u){console.error("Error tracking click:",u)}}async getLinkStats(a){try{const t=await c.getDocument(m,L,a),i=t.clicks||0,o=t.conversions||0,l=t.earnings||0,f=i>0?o/i*100:0;return{clicks:i,conversions:o,earnings:l,conversionRate:f}}catch(t){return console.error("Error fetching link stats:",t),{clicks:0,conversions:0,earnings:0,conversionRate:0}}}async deleteLink(a){try{return await c.deleteDocument(m,L,a),!0}catch(t){return console.error("Error deleting link:",t),!1}}async getLinkClicks(a,t=100){try{return(await c.listDocuments(m,z,[d.equal("linkId",a),d.orderDesc("clickedAt"),d.limit(t)])).documents}catch(i){return console.error("Error fetching link clicks:",i),[]}}async getTotalClicks(a){try{return(await c.listDocuments(m,z,[d.equal("affiliateId",a),d.limit(1)])).total}catch(t){return console.error("Error fetching total clicks:",t),0}}async getConversions(a){try{return(await c.listDocuments(m,Ee,[d.equal("affiliateId",a),d.orderDesc("convertedAt")])).documents}catch(t){return console.error("Error fetching conversions:",t),[]}}}const ee=new Ae;function Te({productId:n,productName:a}){const{user:t}=se(),[i,o]=x.useState(""),[l,f]=x.useState(""),[u,U]=x.useState(""),[$,w]=x.useState(!1),[R,q]=x.useState("general"),[k,P]=x.useState({clicks:0,conversions:0,conversionRate:0}),[b,Q]=x.useState(null);x.useEffect(()=>{b&&B(b)},[b]);const B=async r=>{try{const p=await ee.getLinkStats(r);P(p)}catch(p){console.error("Error loading link stats:",p)}},K=async()=>{if(!t?.affiliateCode||!t?.$id){N.error("كود المسوق غير متوفر");return}let r=i||window.location.origin;n&&R==="product"&&(r=`${window.location.origin}/product/${n}`);const p=M(),C=`${r}${r.includes("?")?"&":"?"}ref=${p}`;f(C);try{const j=await ee.createLink(t.$id,p,C,n);j&&(Q(j.$id),N.success("تم إنشاء الرابط وحفظه بنجاح!"))}catch(j){console.error("Error saving link:",j),N.warning("تم إنشاء الرابط ولكن فشل الحفظ")}try{const j=await Le.toDataURL(C,{width:300,margin:2,color:{dark:"#8b5cf6",light:"#ffffff"}});U(j)}catch(j){console.error("Error generating QR code:",j),N.error("فشل إنشاء رمز QR")}},M=()=>{const r="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let p="";for(let C=0;C<8;C++)p+=r.charAt(Math.floor(Math.random()*r.length));return p},s=async()=>{try{await navigator.clipboard.writeText(l),w(!0),N.success("تم نسخ الرابط!"),setTimeout(()=>w(!1),2e3)}catch{N.error("فشل نسخ الرابط")}},g=()=>{const r=document.createElement("a");r.download=`qr-code-${t?.affiliateCode}.png`,r.href=u,r.click(),N.success("تم تحميل رمز QR!")},S=async()=>{if(navigator.share)try{await navigator.share({title:a||"تسوق من EgyGo",text:"اكتشف هذا المنتج الرائع على EgyGo!",url:l}),N.success("تم المشاركة بنجاح!")}catch(r){console.error("Error sharing:",r)}else s()};return e.jsxs(D,{className:"shadow-lg",children:[e.jsxs(F,{className:"bg-gradient-to-r from-purple-50 to-pink-50",children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-6 h-6 text-purple-600"}),"مولد الروابط التسويقية"]}),e.jsx(V,{children:"أنشئ روابط تسويقية مخصصة مع رمز QR لمشاركتها مع عملائك"})]}),e.jsxs(E,{className:"pt-6",children:[e.jsxs(re,{value:R,onValueChange:r=>q(r),children:[e.jsxs(ne,{className:"grid w-full grid-cols-2 mb-6",children:[e.jsx(J,{value:"general",children:"رابط عام"}),e.jsx(J,{value:"product",disabled:!n,children:"رابط منتج"})]}),e.jsx(W,{value:"general",className:"space-y-4",children:e.jsxs("div",{children:[e.jsx(T,{htmlFor:"url",children:"رابط الصفحة (اختياري)"}),e.jsx(H,{id:"url",placeholder:"https://egygo.me/products",value:i,onChange:r=>o(r.target.value),className:"mt-2"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"اتركه فارغاً لإنشاء رابط للصفحة الرئيسية"})]})}),e.jsx(W,{value:"product",className:"space-y-4",children:a&&e.jsxs("div",{className:"p-4 bg-purple-50 rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium text-purple-900",children:"المنتج المحدد:"}),e.jsx("p",{className:"text-lg font-bold text-purple-700",children:a})]})})]}),e.jsx("div",{className:"mt-6",children:e.jsxs(h,{onClick:K,className:"w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700",size:"lg",children:[e.jsx(I,{className:"w-5 h-5 ml-2"}),"إنشاء الرابط"]})}),l&&e.jsxs("div",{className:"mt-6 space-y-4 animate-in fade-in slide-in-from-bottom-4",children:[e.jsxs("div",{className:"p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200",children:[e.jsx(T,{className:"text-green-900 font-semibold mb-2 block",children:"الرابط التسويقي الخاص بك:"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(H,{value:l,readOnly:!0,className:"bg-white font-mono text-sm"}),e.jsx(h,{onClick:s,variant:"outline",size:"icon",className:"shrink-0",children:$?e.jsx(ie,{className:"w-4 h-4 text-green-600"}):e.jsx(te,{className:"w-4 h-4"})}),e.jsx(h,{onClick:S,variant:"outline",size:"icon",className:"shrink-0",children:e.jsx(le,{className:"w-4 h-4"})})]})]}),u&&e.jsxs("div",{className:"p-6 bg-white rounded-lg border-2 border-purple-200 text-center",children:[e.jsx(T,{className:"text-purple-900 font-semibold mb-4 block",children:"رمز QR للمشاركة:"}),e.jsx("div",{className:"inline-block p-4 bg-white rounded-lg shadow-lg",children:e.jsx("img",{src:u,alt:"QR Code",className:"w-64 h-64 mx-auto"})}),e.jsxs(h,{onClick:g,variant:"outline",className:"mt-4",children:[e.jsx(Se,{className:"w-4 h-4 ml-2"}),"تحميل رمز QR"]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:k.clicks}),e.jsx("p",{className:"text-xs text-blue-900",children:"نقرات"})]}),e.jsxs("div",{className:"p-3 bg-green-50 rounded-lg text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-green-600",children:k.conversions}),e.jsx("p",{className:"text-xs text-green-900",children:"تحويلات"})]}),e.jsxs("div",{className:"p-3 bg-purple-50 rounded-lg text-center",children:[e.jsxs("p",{className:"text-2xl font-bold text-purple-600",children:[k.conversionRate.toFixed(1),"%"]}),e.jsx("p",{className:"text-xs text-purple-900",children:"معدل التحويل"})]})]}),e.jsxs("div",{className:"p-4 bg-yellow-50 rounded-lg border border-yellow-200",children:[e.jsx("p",{className:"text-sm font-semibold text-yellow-900 mb-2",children:"💡 نصائح للنجاح:"}),e.jsxs("ul",{className:"text-xs text-yellow-800 space-y-1",children:[e.jsx("li",{children:"• شارك الرابط على وسائل التواصل الاجتماعي"}),e.jsx("li",{children:"• استخدم رمز QR في المطبوعات والإعلانات"}),e.jsx("li",{children:"• أضف وصف جذاب عند المشاركة"}),e.jsx("li",{children:"• تابع الإحصائيات لتحسين أدائك"})]})]})]}),e.jsxs("div",{className:"mt-6 flex items-center justify-between p-3 bg-purple-50 rounded-lg",children:[e.jsx("span",{className:"text-sm text-purple-900",children:"كود المسوق الخاص بك:"}),e.jsx(A,{variant:"secondary",className:"bg-purple-600 text-white text-lg px-4 py-1",children:t?.affiliateCode||"غير متوفر"})]})]})]})}const _="",Ie=()=>{const n="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let a="";for(let t=0;t<8;t++)a+=n.charAt(Math.floor(Math.random()*n.length));return a};function Ue(){const{user:n}=se(),{toast:a}=ce(),t=oe(),i=de(),[o,l]=x.useState(""),[f,u]=x.useState(""),[U,$]=x.useState(null),{data:w,isLoading:R}=X({queryKey:["products"],queryFn:()=>ye.getAll()}),q=Array.isArray(w)?w:w?.products||[],{data:k=[],isLoading:P}=X({queryKey:["affiliate-links",n?.$id],queryFn:async()=>n?.$id?(await c.listDocuments(_,"affiliate_links",[d.equal("affiliateId",n.$id),d.orderDesc("$createdAt")])).documents:[],enabled:!!n?.$id}),b=Y({mutationFn:async({productId:s,linkCode:g})=>{if(!n?.$id)throw new Error("User not authenticated");if((await c.listDocuments(_,"affiliate_links",[d.equal("linkCode",g)])).documents.length>0)throw new Error("رمز الرابط مستخدم بالفعل. جرب رمز آخر.");return await c.createDocument(_,"affiliate_links",G.unique(),{affiliateId:n.$id,productId:s,linkCode:g,clicks:0,conversions:0,revenue:0,createdAt:new Date().toISOString(),lastClickAt:null})},onSuccess:()=>{i.invalidateQueries({queryKey:["affiliate-links"]}),a({title:"تم إنشاء الرابط! 🎉",description:"يمكنك الآن مشاركة الرابط مع عملائك"}),l(""),u("")},onError:s=>{a({title:"خطأ",description:s.message,variant:"destructive"})}}),Q=Y({mutationFn:async s=>{await c.deleteDocument(_,"affiliate_links",s)},onSuccess:()=>{i.invalidateQueries({queryKey:["affiliate-links"]}),a({title:"تم حذف الرابط",description:"تم حذف الرابط بنجاح"})}}),B=()=>{if(!o){a({title:"تنبيه",description:"الرجاء اختيار منتج",variant:"destructive"});return}const s=f.trim()||Ie();b.mutate({productId:o,linkCode:s})},K=s=>{const g=`${window.location.origin}/l/${s}`;navigator.clipboard.writeText(g),$(s),a({title:"تم النسخ! ✓",description:"تم نسخ الرابط إلى الحافظة"}),setTimeout(()=>$(null),2e3)},M=s=>{window.open(`/l/${s}`,"_blank")};return n?.isAffiliate?e.jsxs("div",{className:"container mx-auto px-4 py-8 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"إدارة روابط التسويق"}),e.jsx("p",{className:"text-muted-foreground",children:"أنشئ روابط تتبع خاصة لكل منتج وتابع أداء حملاتك"})]}),e.jsx(Te,{}),e.jsxs(D,{children:[e.jsxs(F,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-5 w-5"}),"إنشاء رابط جديد"]}),e.jsx(V,{children:"اختر منتجاً وأنشئ رابط تسويقي خاص به"})]}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{children:"اختر المنتج"}),e.jsxs(ue,{value:o,onValueChange:l,disabled:R,children:[e.jsx(me,{children:e.jsx(he,{placeholder:"اختر منتج..."})}),e.jsx(pe,{children:q.map(s=>e.jsxs(fe,{value:s.id,children:[s.name," - ",s.price.toFixed(2)," جنيه"]},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{children:"رمز مخصص (اختياري)"}),e.jsx(H,{placeholder:"اتركه فارغاً للتوليد التلقائي",value:f,onChange:s=>u(s.target.value.toUpperCase().slice(0,12)),maxLength:12}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"سيتم توليد رمز عشوائي إذا تركت هذا الحقل فارغاً"})]})]}),e.jsxs(h,{onClick:B,disabled:!o||b.isPending,className:"w-full md:w-auto",children:[e.jsx(I,{className:"ml-2 h-4 w-4"}),"إنشاء الرابط"]})]})]}),e.jsxs(D,{children:[e.jsxs(F,{children:[e.jsxs(O,{children:["روابطك التسويقية (",k.length,")"]}),e.jsx(V,{children:"جميع الروابط التي أنشأتها مع إحصائيات الأداء"})]}),e.jsx(E,{children:P?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"جاري التحميل..."}):k.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(I,{className:"h-12 w-12 mx-auto text-muted-foreground mb-3"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"لم تنشئ أي روابط بعد"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"ابدأ بإنشاء أول رابط تسويقي لك من الأعلى"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(we,{children:[e.jsx(be,{children:e.jsxs(Z,{children:[e.jsx(v,{children:"المنتج"}),e.jsx(v,{children:"رمز الرابط"}),e.jsxs(v,{className:"text-center",children:[e.jsx(ge,{className:"h-4 w-4 inline ml-1"}),"نقرات"]}),e.jsxs(v,{className:"text-center",children:[e.jsx(je,{className:"h-4 w-4 inline ml-1"}),"تحويلات"]}),e.jsxs(v,{className:"text-center",children:[e.jsx(Ne,{className:"h-4 w-4 inline ml-1"}),"معدل التحويل"]}),e.jsxs(v,{className:"text-center",children:[e.jsx(ke,{className:"h-4 w-4 inline ml-1"}),"العمولة"]}),e.jsx(v,{className:"text-left",children:"إجراءات"})]})}),e.jsx(Ce,{children:k.map(s=>{const g=q.find(r=>r.id===s.productId),S=s.clicks>0?(s.conversions/s.clicks*100).toFixed(1):"0.0";return e.jsxs(Z,{children:[e.jsx(y,{className:"font-medium",children:g?.name||"منتج غير معروف"}),e.jsx(y,{children:e.jsx("code",{className:"bg-muted px-2 py-1 rounded text-sm",children:s.linkCode})}),e.jsx(y,{className:"text-center",children:e.jsx(A,{variant:"outline",children:s.clicks||0})}),e.jsx(y,{className:"text-center",children:e.jsx(A,{variant:"outline",children:s.conversions||0})}),e.jsx(y,{className:"text-center",children:e.jsxs(A,{variant:parseFloat(S)>5?"default":"secondary",children:[S,"%"]})}),e.jsxs(y,{className:"text-center font-semibold text-green-600",children:[(s.revenue||0).toFixed(2)," جنيه"]}),e.jsx(y,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>K(s.linkCode),children:U===s.linkCode?e.jsx(A,{variant:"default",className:"h-4 w-4 p-0",children:"✓"}):e.jsx(te,{className:"h-4 w-4"})}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>M(s.linkCode),children:e.jsx(De,{className:"h-4 w-4"})}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>Q.mutate(s.$id),disabled:Q.isPending,children:e.jsx(ve,{className:"h-4 w-4 text-destructive"})})]})})]},s.$id)})})]})})})]}),e.jsxs(D,{className:"bg-gradient-to-r from-primary/10 to-orange-500/10 border-primary",children:[e.jsx(F,{children:e.jsx(O,{className:"flex items-center gap-2",children:"💡 نصائح لزيادة أرباحك"})}),e.jsxs(E,{className:"space-y-2",children:[e.jsx("p",{className:"text-sm",children:"• شارك الروابط على وسائل التواصل الاجتماعي للوصول لجمهور أكبر"}),e.jsx("p",{className:"text-sm",children:"• أنشئ محتوى قيم حول المنتجات التي تسوق لها"}),e.jsx("p",{className:"text-sm",children:"• استخدم الكوبونات الخاصة بك لتحفيز العملاء على الشراء"}),e.jsx("p",{className:"text-sm",children:"• راقب الإحصائيات بانتظام لمعرفة أي المنتجات تحقق أفضل أداء"})]})]})]}):e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(D,{children:e.jsxs(E,{className:"p-12 text-center space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(I,{className:"h-8 w-8 text-orange-600"})}),e.jsx("h2",{className:"text-2xl font-bold",children:"هذه الصفحة للمسوقين فقط"}),e.jsx("p",{className:"text-muted-foreground max-w-md mx-auto",children:"يجب أن يكون حسابك مفعّلاً كحساب مسوق للوصول إلى أدوات إنشاء الروابط التسويقية"}),e.jsxs("div",{className:"flex gap-3 justify-center pt-4",children:[e.jsx(h,{onClick:()=>t("/update-affiliate-prefs"),children:"تفعيل حساب المسوق"}),e.jsx(h,{variant:"outline",onClick:()=>t("/affiliate"),children:"معرفة المزيد عن التسويق بالعمولة"})]})]})})})}export{Ue as default};
