import{r as i,j as e,p as ie,a0 as I,_ as re,bJ as ce,bw as de,a_ as oe,bz as xe,c1 as $}from"./vendor-react-CCFRLLzk.js";import{c as me,u as he,d as g,C as d,x as o,y as x,h as m,B as N,P as k,f as b,D as je,z as ue,A as fe,E as pe,F as ge,L as E,I as Ne,T as be,G as ve,a0 as _}from"./index-D7NOjX7I.js";import{T as ye,a as Fe,b as B,c as H}from"./tabs-DYtgkDIe.js";import{T as L,a as U,b as h,c as l,d as q,e as n}from"./table-Z49QUUEs.js";import{Q as j,I as z}from"./vendor-appwrite-CuqfvTq9.js";import"./vendor-ui-BA32w1ww.js";import"./vendor-query-j_rPqiug.js";import"./vendor-other-CzBBjgu5.js";import"./vendor-animations-CPHPqPXb.js";function Ee(){const{user:c}=me(),{toast:f}=he(),[we,y]=i.useState(!0),[G,Q]=i.useState(0),[R,V]=i.useState(0),[J,M]=i.useState(0),[W,K]=i.useState(0),[F,X]=i.useState([]),[w,Y]=i.useState([]),[Z,p]=i.useState(!1),[t,O]=i.useState(null),[v,S]=i.useState(null),[D,C]=i.useState(""),[T,A]=i.useState(!1);i.useEffect(()=>{c&&P()},[c]);const P=async()=>{if(c){y(!0);try{const s=await g.listDocuments("68d8b9db00134c41e7c8","orders",[j.equal("merchantId",c.$id),j.orderDesc("$createdAt"),j.limit(100)]),u=await g.listDocuments("68d8b9db00134c41e7c8","merchantPayments",[j.equal("merchantId",c.$id),j.orderDesc("$createdAt"),j.limit(50)]);X(s.documents),Y(u.documents),ee(s.documents)}catch(s){console.error("Error fetching financial data:",s),f({title:"خطأ",description:"فشل تحميل البيانات المالية",variant:"destructive"})}finally{y(!1)}}},ee=s=>{const u=s.filter(a=>a.status==="delivered").reduce((a,r)=>a+r.totalAmount,0);Q(u);const ae=s.filter(a=>a.status==="delivered"&&a.paymentStatus==="unpaid").reduce((a,r)=>a+(r.commissionAmount+r.platformFee),0);V(ae);const ne=s.filter(a=>a.status==="delivered").reduce((a,r)=>a+r.commissionAmount,0);M(ne);const le=s.filter(a=>a.status==="delivered").reduce((a,r)=>a+r.platformFee,0);K(le)},se=s=>{s.target.files&&s.target.files[0]&&S(s.target.files[0])},te=async()=>{if(!t||!v){f({title:"خطأ",description:"الرجاء رفع صورة إثبات التحويل",variant:"destructive"});return}A(!0);try{const s=await _.createFile("payment-proofs",z.unique(),v),u=_.getFileView("payment-proofs",s.$id).toString();await g.createDocument("68d8b9db00134c41e7c8","merchantPayments",z.unique(),{merchantId:c.$id,merchantName:c.name,orderId:t.orderId,totalAmount:t.totalAmount,commissionAmount:t.commissionAmount,platformFee:t.platformFee,transferProof:u,notes:D,status:"pending",createdAt:new Date().toISOString()}),await g.updateDocument("68d8b9db00134c41e7c8","orders",t.$id,{paymentStatus:"pending_verification"}),f({title:"تم الإرسال",description:"تم إرسال إثبات الدفع بنجاح. سيتم المراجعة قريباً."}),p(!1),S(null),C(""),P()}catch(s){console.error("Error submitting payment:",s),f({title:"خطأ",description:"فشل إرسال إثبات الدفع",variant:"destructive"})}finally{A(!1)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"السجل المالي"}),e.jsx("p",{className:"text-muted-foreground",children:"إدارة المبيعات والمدفوعات"})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(d,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"إجمالي المبيعات"}),e.jsx(ie,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(m,{children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[G.toFixed(2)," ج.م"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"الطلبات المكتملة"})]})]}),e.jsxs(d,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"مدفوعات معلقة"}),e.jsx(I,{className:"h-4 w-4 text-orange-600"})]}),e.jsxs(m,{children:[e.jsxs("div",{className:"text-2xl font-bold text-orange-600",children:[R.toFixed(2)," ج.م"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"يجب دفعها للمنصة"})]})]}),e.jsxs(d,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"عمولات المسوقين"}),e.jsx(re,{className:"h-4 w-4 text-blue-600"})]}),e.jsxs(m,{children:[e.jsxs("div",{className:"text-2xl font-bold text-blue-600",children:[J.toFixed(2)," ج.م"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"إجمالي العمولات"})]})]}),e.jsxs(d,{children:[e.jsxs(o,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(x,{className:"text-sm font-medium",children:"رسوم المنصة"}),e.jsx(ce,{className:"h-4 w-4 text-purple-600"})]}),e.jsxs(m,{children:[e.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:[W.toFixed(2)," ج.م"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"إجمالي الرسوم"})]})]})]}),e.jsxs(d,{className:"bg-blue-50 border-blue-200",children:[e.jsx(o,{children:e.jsxs(x,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-5 w-5"}),"طرق الدفع المتاحة"]})}),e.jsxs(m,{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"بعد تسليم الطلب، قم بتحويل العمولات والرسوم إلى:"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"outline",children:"فودافون كاش"}),e.jsx("span",{className:"font-mono",children:"01034324551"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:"outline",children:"إنستا باي"}),e.jsx("span",{className:"font-mono",children:"ebank_hema@instapay"})]})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"⚠️ يجب رفع صورة إثبات التحويل بعد الدفع"})]})]}),e.jsxs(ye,{defaultValue:"orders",className:"space-y-4",children:[e.jsxs(Fe,{children:[e.jsx(B,{value:"orders",children:"الطلبات المكتملة"}),e.jsx(B,{value:"payments",children:"سجل المدفوعات"})]}),e.jsx(H,{value:"orders",className:"space-y-4",children:e.jsxs(d,{children:[e.jsxs(o,{children:[e.jsx(x,{children:"الطلبات المكتملة"}),e.jsx(k,{children:"الطلبات التي تم تسليمها وتحتاج لدفع العمولات"})]}),e.jsx(m,{children:e.jsxs(L,{children:[e.jsx(U,{children:e.jsxs(h,{children:[e.jsx(l,{children:"رقم الطلب"}),e.jsx(l,{children:"المبلغ الكلي"}),e.jsx(l,{children:"عمولة المسوق"}),e.jsx(l,{children:"رسوم المنصة"}),e.jsx(l,{children:"الإجمالي المستحق"}),e.jsx(l,{children:"حالة الدفع"}),e.jsx(l,{children:"الإجراءات"})]})}),e.jsx(q,{children:F.filter(s=>s.status==="delivered").length===0?e.jsx(h,{children:e.jsx(n,{colSpan:7,className:"text-center text-muted-foreground",children:"لا توجد طلبات مكتملة"})}):F.filter(s=>s.status==="delivered").map(s=>e.jsxs(h,{children:[e.jsx(n,{className:"font-mono",children:s.orderId}),e.jsxs(n,{className:"font-bold",children:[s.totalAmount.toFixed(2)," ج.م"]}),e.jsxs(n,{className:"text-blue-600",children:[s.commissionAmount.toFixed(2)," ج.م"]}),e.jsxs(n,{className:"text-purple-600",children:[s.platformFee.toFixed(2)," ج.م"]}),e.jsxs(n,{className:"font-bold text-orange-600",children:[(s.commissionAmount+s.platformFee).toFixed(2)," ج.م"]}),e.jsx(n,{children:e.jsx(N,{variant:s.paymentStatus==="verified"?"default":s.paymentStatus==="pending_verification"?"secondary":"destructive",children:s.paymentStatus==="verified"?e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"h-3 w-3 mr-1"})," تم التحقق"]}):s.paymentStatus==="pending_verification"?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"h-3 w-3 mr-1"})," قيد المراجعة"]}):e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"h-3 w-3 mr-1"})," لم يتم الدفع"]})})}),e.jsx(n,{children:s.paymentStatus==="unpaid"&&e.jsxs(b,{size:"sm",onClick:()=>{O(s),p(!0)},children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"رفع إثبات"]})})]},s.$id))})]})})]})}),e.jsx(H,{value:"payments",className:"space-y-4",children:e.jsxs(d,{children:[e.jsxs(o,{children:[e.jsx(x,{children:"سجل المدفوعات"}),e.jsx(k,{children:"جميع إثباتات الدفع المرسلة"})]}),e.jsx(m,{children:e.jsxs(L,{children:[e.jsx(U,{children:e.jsxs(h,{children:[e.jsx(l,{children:"رقم الطلب"}),e.jsx(l,{children:"المبلغ الكلي"}),e.jsx(l,{children:"عمولة المسوق"}),e.jsx(l,{children:"رسوم المنصة"}),e.jsx(l,{children:"إثبات التحويل"}),e.jsx(l,{children:"الحالة"}),e.jsx(l,{children:"التاريخ"})]})}),e.jsx(q,{children:w.length===0?e.jsx(h,{children:e.jsx(n,{colSpan:7,className:"text-center text-muted-foreground",children:"لا توجد مدفوعات مسجلة"})}):w.map(s=>e.jsxs(h,{children:[e.jsx(n,{className:"font-mono",children:s.orderId}),e.jsxs(n,{children:[s.totalAmount.toFixed(2)," ج.م"]}),e.jsxs(n,{className:"text-blue-600",children:[s.commissionAmount.toFixed(2)," ج.م"]}),e.jsxs(n,{className:"text-purple-600",children:[s.platformFee.toFixed(2)," ج.م"]}),e.jsx(n,{children:e.jsx(b,{variant:"outline",size:"sm",asChild:!0,children:e.jsx("a",{href:s.transferProof,target:"_blank",rel:"noopener noreferrer",children:"عرض الصورة"})})}),e.jsx(n,{children:e.jsx(N,{variant:s.status==="verified"?"default":s.status==="rejected"?"destructive":"secondary",children:s.status==="verified"?"تم التحقق":s.status==="rejected"?"مرفوض":"قيد المراجعة"})}),e.jsx(n,{children:new Date(s.createdAt).toLocaleDateString("ar-EG")})]},s.$id))})]})})]})})]}),e.jsx(je,{open:Z,onOpenChange:p,children:e.jsxs(ue,{children:[e.jsxs(fe,{children:[e.jsx(pe,{children:"رفع إثبات الدفع"}),e.jsx(ge,{children:"قم برفع صورة إثبات التحويل للعمولات ورسوم المنصة"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"تفاصيل الدفع:"}),e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"عمولة المسوق:"}),e.jsxs("span",{className:"font-bold text-blue-600",children:[t==null?void 0:t.commissionAmount.toFixed(2)," ج.م"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"رسوم المنصة:"}),e.jsxs("span",{className:"font-bold text-purple-600",children:[t==null?void 0:t.platformFee.toFixed(2)," ج.م"]})]}),e.jsxs("div",{className:"flex justify-between border-t pt-1",children:[e.jsx("span",{className:"font-bold",children:"الإجمالي:"}),e.jsxs("span",{className:"font-bold text-orange-600",children:[(((t==null?void 0:t.commissionAmount)||0)+((t==null?void 0:t.platformFee)||0)).toFixed(2)," ج.م"]})]})]})]}),e.jsxs("div",{children:[e.jsx(E,{children:"صورة إثبات التحويل *"}),e.jsx(Ne,{type:"file",accept:"image/*",onChange:se,className:"mt-1"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"صورة واضحة لإيصال التحويل"})]}),e.jsxs("div",{children:[e.jsx(E,{children:"ملاحظات (اختياري)"}),e.jsx(be,{placeholder:"أي ملاحظات إضافية...",value:D,onChange:s=>C(s.target.value)})]})]}),e.jsxs(ve,{children:[e.jsx(b,{variant:"outline",onClick:()=>p(!1),children:"إلغاء"}),e.jsx(b,{onClick:te,disabled:!v||T,children:T?e.jsx(e.Fragment,{children:"جاري الرفع..."}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"h-4 w-4 mr-2"}),"رفع الإثبات"]})})]})]})})]})}export{Ee as default};
