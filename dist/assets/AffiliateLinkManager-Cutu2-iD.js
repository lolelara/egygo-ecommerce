import{r as x,j as e,bF as E,s as ae,bq as se,aT as re,bu as ne,as as k,u as ie,H as le,f as J,J as X,aX as ce,aq as oe,h as de,i as xe,M as me,br as ue,aY as he}from"./vendor-react-BTCGZZAN.js";import{d as c,c as pe,o as te,C as T,r as _,s as O,G as z,f as A,L as I,I as H,e as p,B as D,u as fe,p as ge}from"./index-DAwEpow4.js";import{Q as d,I as V}from"./vendor-appwrite-BQhTxLk4.js";import{S as je,a as Ne,b as ke,c as ve,d as we}from"./select-DcBOtlUf.js";import{T as ye,a as be,b as Y,c as w,d as Ce,e as y}from"./table-C5DXC0ob.js";import{T as Le,a as Se,b as W,c as Z}from"./tabs-43GTZMZA.js";import{bi as Te}from"./vendor-other-ws_0vYaO.js";import"./vendor-ui-BA32w1ww.js";import"./vendor-query-GexG3wnZ.js";import"./vendor-animations-W1Z2cmit.js";const h=pe.databaseId,L="affiliate_links",G="affiliate_clicks",Ae="affiliate_conversions";class De{async getAffiliateLinks(a){try{return(await c.listDocuments(h,L,[d.equal("affiliateId",a),d.orderDesc("$createdAt")])).documents}catch(s){return console.error("Error fetching affiliate links:",s),[]}}async createLink(a,s,i,o){try{return await c.createDocument(h,L,V.unique(),{affiliateId:a,linkCode:s,url:i,productId:o||null,clicks:0,conversions:0,earnings:0,createdAt:new Date().toISOString()})}catch(l){return console.error("Error creating affiliate link:",l),null}}async trackClick(a,s,i,o,l,g){try{await c.createDocument(h,G,V.unique(),{affiliateId:a,linkId:s,productId:i||null,ipAddress:o||null,userAgent:l||null,referrer:g||null,clickedAt:new Date().toISOString()});const m=await c.getDocument(h,L,s);await c.updateDocument(h,L,s,{clicks:(m.clicks||0)+1})}catch(m){console.error("Error tracking click:",m)}}async getLinkStats(a){try{const s=await c.getDocument(h,L,a),i=s.clicks||0,o=s.conversions||0,l=s.earnings||0,g=i>0?o/i*100:0;return{clicks:i,conversions:o,earnings:l,conversionRate:g}}catch(s){return console.error("Error fetching link stats:",s),{clicks:0,conversions:0,earnings:0,conversionRate:0}}}async deleteLink(a){try{return await c.deleteDocument(h,L,a),!0}catch(s){return console.error("Error deleting link:",s),!1}}async getLinkClicks(a,s=100){try{return(await c.listDocuments(h,G,[d.equal("linkId",a),d.orderDesc("clickedAt"),d.limit(s)])).documents}catch(i){return console.error("Error fetching link clicks:",i),[]}}async getTotalClicks(a){try{return(await c.listDocuments(h,G,[d.equal("affiliateId",a),d.limit(1)])).total}catch(s){return console.error("Error fetching total clicks:",s),0}}async getConversions(a){try{return(await c.listDocuments(h,Ae,[d.equal("affiliateId",a),d.orderDesc("convertedAt")])).documents}catch(s){return console.error("Error fetching conversions:",s),[]}}}const ee=new De;function Ee({productId:r,productName:a}){const{user:s}=te(),[i,o]=x.useState(""),[l,g]=x.useState(""),[m,U]=x.useState(""),[$,j]=x.useState(!1),[q,R]=x.useState("general"),[v,M]=x.useState({clicks:0,conversions:0,conversionRate:0}),[b,Q]=x.useState(null);x.useEffect(()=>{b&&P(b)},[b]);const P=async n=>{try{const f=await ee.getLinkStats(n);M(f)}catch(f){console.error("Error loading link stats:",f)}},B=async()=>{if(!(s!=null&&s.affiliateCode)||!(s!=null&&s.$id)){k.error("كود المسوق غير متوفر");return}let n=i||window.location.origin;r&&q==="product"&&(n=`${window.location.origin}/product/${r}`);const f=K(),C=`${n}${n.includes("?")?"&":"?"}ref=${f}`;g(C);try{const N=await ee.createLink(s.$id,f,C,r);N&&(Q(N.$id),k.success("تم إنشاء الرابط وحفظه بنجاح!"))}catch(N){console.error("Error saving link:",N),k.warning("تم إنشاء الرابط ولكن فشل الحفظ")}try{const N=await Te.toDataURL(C,{width:300,margin:2,color:{dark:"#8b5cf6",light:"#ffffff"}});U(N)}catch(N){console.error("Error generating QR code:",N),k.error("فشل إنشاء رمز QR")}},K=()=>{const n="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let f="";for(let C=0;C<8;C++)f+=n.charAt(Math.floor(Math.random()*n.length));return f},t=async()=>{try{await navigator.clipboard.writeText(l),j(!0),k.success("تم نسخ الرابط!"),setTimeout(()=>j(!1),2e3)}catch{k.error("فشل نسخ الرابط")}},u=()=>{const n=document.createElement("a");n.download=`qr-code-${s==null?void 0:s.affiliateCode}.png`,n.href=m,n.click(),k.success("تم تحميل رمز QR!")},S=async()=>{if(navigator.share)try{await navigator.share({title:a||"تسوق من EgyGo",text:"اكتشف هذا المنتج الرائع على EgyGo!",url:l}),k.success("تم المشاركة بنجاح!")}catch(n){console.error("Error sharing:",n)}else t()};return e.jsxs(T,{className:"shadow-lg",children:[e.jsxs(_,{className:"bg-gradient-to-r from-purple-50 to-pink-50",children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-6 h-6 text-purple-600"}),"مولد الروابط التسويقية"]}),e.jsx(z,{children:"أنشئ روابط تسويقية مخصصة مع رمز QR لمشاركتها مع عملائك"})]}),e.jsxs(A,{className:"pt-6",children:[e.jsxs(Le,{value:q,onValueChange:n=>R(n),children:[e.jsxs(Se,{className:"grid w-full grid-cols-2 mb-6",children:[e.jsx(W,{value:"general",children:"رابط عام"}),e.jsx(W,{value:"product",disabled:!r,children:"رابط منتج"})]}),e.jsx(Z,{value:"general",className:"space-y-4",children:e.jsxs("div",{children:[e.jsx(I,{htmlFor:"url",children:"رابط الصفحة (اختياري)"}),e.jsx(H,{id:"url",placeholder:"https://egygo.me/products",value:i,onChange:n=>o(n.target.value),className:"mt-2"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"اتركه فارغاً لإنشاء رابط للصفحة الرئيسية"})]})}),e.jsx(Z,{value:"product",className:"space-y-4",children:a&&e.jsxs("div",{className:"p-4 bg-purple-50 rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium text-purple-900",children:"المنتج المحدد:"}),e.jsx("p",{className:"text-lg font-bold text-purple-700",children:a})]})})]}),e.jsx("div",{className:"mt-6",children:e.jsxs(p,{onClick:B,className:"w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700",size:"lg",children:[e.jsx(E,{className:"w-5 h-5 ml-2"}),"إنشاء الرابط"]})}),l&&e.jsxs("div",{className:"mt-6 space-y-4 animate-in fade-in slide-in-from-bottom-4",children:[e.jsxs("div",{className:"p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200",children:[e.jsx(I,{className:"text-green-900 font-semibold mb-2 block",children:"الرابط التسويقي الخاص بك:"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(H,{value:l,readOnly:!0,className:"bg-white font-mono text-sm"}),e.jsx(p,{onClick:t,variant:"outline",size:"icon",className:"shrink-0",children:$?e.jsx(ae,{className:"w-4 h-4 text-green-600"}):e.jsx(se,{className:"w-4 h-4"})}),e.jsx(p,{onClick:S,variant:"outline",size:"icon",className:"shrink-0",children:e.jsx(re,{className:"w-4 h-4"})})]})]}),m&&e.jsxs("div",{className:"p-6 bg-white rounded-lg border-2 border-purple-200 text-center",children:[e.jsx(I,{className:"text-purple-900 font-semibold mb-4 block",children:"رمز QR للمشاركة:"}),e.jsx("div",{className:"inline-block p-4 bg-white rounded-lg shadow-lg",children:e.jsx("img",{src:m,alt:"QR Code",className:"w-64 h-64 mx-auto"})}),e.jsxs(p,{onClick:u,variant:"outline",className:"mt-4",children:[e.jsx(ne,{className:"w-4 h-4 ml-2"}),"تحميل رمز QR"]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:v.clicks}),e.jsx("p",{className:"text-xs text-blue-900",children:"نقرات"})]}),e.jsxs("div",{className:"p-3 bg-green-50 rounded-lg text-center",children:[e.jsx("p",{className:"text-2xl font-bold text-green-600",children:v.conversions}),e.jsx("p",{className:"text-xs text-green-900",children:"تحويلات"})]}),e.jsxs("div",{className:"p-3 bg-purple-50 rounded-lg text-center",children:[e.jsxs("p",{className:"text-2xl font-bold text-purple-600",children:[v.conversionRate.toFixed(1),"%"]}),e.jsx("p",{className:"text-xs text-purple-900",children:"معدل التحويل"})]})]}),e.jsxs("div",{className:"p-4 bg-yellow-50 rounded-lg border border-yellow-200",children:[e.jsx("p",{className:"text-sm font-semibold text-yellow-900 mb-2",children:"💡 نصائح للنجاح:"}),e.jsxs("ul",{className:"text-xs text-yellow-800 space-y-1",children:[e.jsx("li",{children:"• شارك الرابط على وسائل التواصل الاجتماعي"}),e.jsx("li",{children:"• استخدم رمز QR في المطبوعات والإعلانات"}),e.jsx("li",{children:"• أضف وصف جذاب عند المشاركة"}),e.jsx("li",{children:"• تابع الإحصائيات لتحسين أدائك"})]})]})]}),e.jsxs("div",{className:"mt-6 flex items-center justify-between p-3 bg-purple-50 rounded-lg",children:[e.jsx("span",{className:"text-sm text-purple-900",children:"كود المسوق الخاص بك:"}),e.jsx(D,{variant:"secondary",className:"bg-purple-600 text-white text-lg px-4 py-1",children:(s==null?void 0:s.affiliateCode)||"غير متوفر"})]})]})]})}const F="",Ie=()=>{const r="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let a="";for(let s=0;s<8;s++)a+=r.charAt(Math.floor(Math.random()*r.length));return a};function Be(){const{user:r}=te(),{toast:a}=fe(),s=ie(),i=le(),[o,l]=x.useState(""),[g,m]=x.useState(""),[U,$]=x.useState(null),{data:j,isLoading:q}=J({queryKey:["products"],queryFn:()=>ge.getAll()}),R=Array.isArray(j)?j:(j==null?void 0:j.products)||[],{data:v=[],isLoading:M}=J({queryKey:["affiliate-links",r==null?void 0:r.$id],queryFn:async()=>r!=null&&r.$id?(await c.listDocuments(F,"affiliate_links",[d.equal("affiliateId",r.$id),d.orderDesc("$createdAt")])).documents:[],enabled:!!(r!=null&&r.$id)}),b=X({mutationFn:async({productId:t,linkCode:u})=>{if(!(r!=null&&r.$id))throw new Error("User not authenticated");if((await c.listDocuments(F,"affiliate_links",[d.equal("linkCode",u)])).documents.length>0)throw new Error("رمز الرابط مستخدم بالفعل. جرب رمز آخر.");return await c.createDocument(F,"affiliate_links",V.unique(),{affiliateId:r.$id,productId:t,linkCode:u,clicks:0,conversions:0,revenue:0,createdAt:new Date().toISOString(),lastClickAt:null})},onSuccess:()=>{i.invalidateQueries({queryKey:["affiliate-links"]}),a({title:"تم إنشاء الرابط! 🎉",description:"يمكنك الآن مشاركة الرابط مع عملائك"}),l(""),m("")},onError:t=>{a({title:"خطأ",description:t.message,variant:"destructive"})}}),Q=X({mutationFn:async t=>{await c.deleteDocument(F,"affiliate_links",t)},onSuccess:()=>{i.invalidateQueries({queryKey:["affiliate-links"]}),a({title:"تم حذف الرابط",description:"تم حذف الرابط بنجاح"})}}),P=()=>{if(!o){a({title:"تنبيه",description:"الرجاء اختيار منتج",variant:"destructive"});return}const t=g.trim()||Ie();b.mutate({productId:o,linkCode:t})},B=t=>{const u=`${window.location.origin}/l/${t}`;navigator.clipboard.writeText(u),$(t),a({title:"تم النسخ! ✓",description:"تم نسخ الرابط إلى الحافظة"}),setTimeout(()=>$(null),2e3)},K=t=>{window.open(`/l/${t}`,"_blank")};return r!=null&&r.isAffiliate?e.jsxs("div",{className:"container mx-auto px-4 py-8 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"إدارة روابط التسويق"}),e.jsx("p",{className:"text-muted-foreground",children:"أنشئ روابط تتبع خاصة لكل منتج وتابع أداء حملاتك"})]}),e.jsx(Ee,{}),e.jsxs(T,{children:[e.jsxs(_,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-5 w-5"}),"إنشاء رابط جديد"]}),e.jsx(z,{children:"اختر منتجاً وأنشئ رابط تسويقي خاص به"})]}),e.jsxs(A,{className:"space-y-4",children:[e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{children:"اختر المنتج"}),e.jsxs(je,{value:o,onValueChange:l,disabled:q,children:[e.jsx(Ne,{children:e.jsx(ke,{placeholder:"اختر منتج..."})}),e.jsx(ve,{children:R.map(t=>e.jsxs(we,{value:t.id,children:[t.name," - ",t.price.toFixed(2)," جنيه"]},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{children:"رمز مخصص (اختياري)"}),e.jsx(H,{placeholder:"اتركه فارغاً للتوليد التلقائي",value:g,onChange:t=>m(t.target.value.toUpperCase().slice(0,12)),maxLength:12}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"سيتم توليد رمز عشوائي إذا تركت هذا الحقل فارغاً"})]})]}),e.jsxs(p,{onClick:P,disabled:!o||b.isPending,className:"w-full md:w-auto",children:[e.jsx(E,{className:"ml-2 h-4 w-4"}),"إنشاء الرابط"]})]})]}),e.jsxs(T,{children:[e.jsxs(_,{children:[e.jsxs(O,{children:["روابطك التسويقية (",v.length,")"]}),e.jsx(z,{children:"جميع الروابط التي أنشأتها مع إحصائيات الأداء"})]}),e.jsx(A,{children:M?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"جاري التحميل..."}):v.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"h-12 w-12 mx-auto text-muted-foreground mb-3"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"لم تنشئ أي روابط بعد"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"ابدأ بإنشاء أول رابط تسويقي لك من الأعلى"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ye,{children:[e.jsx(be,{children:e.jsxs(Y,{children:[e.jsx(w,{children:"المنتج"}),e.jsx(w,{children:"رمز الرابط"}),e.jsxs(w,{className:"text-center",children:[e.jsx(oe,{className:"h-4 w-4 inline ml-1"}),"نقرات"]}),e.jsxs(w,{className:"text-center",children:[e.jsx(de,{className:"h-4 w-4 inline ml-1"}),"تحويلات"]}),e.jsxs(w,{className:"text-center",children:[e.jsx(xe,{className:"h-4 w-4 inline ml-1"}),"معدل التحويل"]}),e.jsxs(w,{className:"text-center",children:[e.jsx(me,{className:"h-4 w-4 inline ml-1"}),"العمولة"]}),e.jsx(w,{className:"text-left",children:"إجراءات"})]})}),e.jsx(Ce,{children:v.map(t=>{const u=R.find(n=>n.id===t.productId),S=t.clicks>0?(t.conversions/t.clicks*100).toFixed(1):"0.0";return e.jsxs(Y,{children:[e.jsx(y,{className:"font-medium",children:(u==null?void 0:u.name)||"منتج غير معروف"}),e.jsx(y,{children:e.jsx("code",{className:"bg-muted px-2 py-1 rounded text-sm",children:t.linkCode})}),e.jsx(y,{className:"text-center",children:e.jsx(D,{variant:"outline",children:t.clicks||0})}),e.jsx(y,{className:"text-center",children:e.jsx(D,{variant:"outline",children:t.conversions||0})}),e.jsx(y,{className:"text-center",children:e.jsxs(D,{variant:parseFloat(S)>5?"default":"secondary",children:[S,"%"]})}),e.jsxs(y,{className:"text-center font-semibold text-green-600",children:[(t.revenue||0).toFixed(2)," جنيه"]}),e.jsx(y,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{size:"sm",variant:"outline",onClick:()=>B(t.linkCode),children:U===t.linkCode?e.jsx(D,{variant:"default",className:"h-4 w-4 p-0",children:"✓"}):e.jsx(se,{className:"h-4 w-4"})}),e.jsx(p,{size:"sm",variant:"outline",onClick:()=>K(t.linkCode),children:e.jsx(ue,{className:"h-4 w-4"})}),e.jsx(p,{size:"sm",variant:"outline",onClick:()=>Q.mutate(t.$id),disabled:Q.isPending,children:e.jsx(he,{className:"h-4 w-4 text-destructive"})})]})})]},t.$id)})})]})})})]}),e.jsxs(T,{className:"bg-gradient-to-r from-primary/10 to-orange-500/10 border-primary",children:[e.jsx(_,{children:e.jsx(O,{className:"flex items-center gap-2",children:"💡 نصائح لزيادة أرباحك"})}),e.jsxs(A,{className:"space-y-2",children:[e.jsx("p",{className:"text-sm",children:"• شارك الروابط على وسائل التواصل الاجتماعي للوصول لجمهور أكبر"}),e.jsx("p",{className:"text-sm",children:"• أنشئ محتوى قيم حول المنتجات التي تسوق لها"}),e.jsx("p",{className:"text-sm",children:"• استخدم الكوبونات الخاصة بك لتحفيز العملاء على الشراء"}),e.jsx("p",{className:"text-sm",children:"• راقب الإحصائيات بانتظام لمعرفة أي المنتجات تحقق أفضل أداء"})]})]})]}):e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(T,{children:e.jsxs(A,{className:"p-12 text-center space-y-4",children:[e.jsx("div",{className:"mx-auto w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(E,{className:"h-8 w-8 text-orange-600"})}),e.jsx("h2",{className:"text-2xl font-bold",children:"هذه الصفحة للمسوقين فقط"}),e.jsx("p",{className:"text-muted-foreground max-w-md mx-auto",children:"يجب أن يكون حسابك مفعّلاً كحساب مسوق للوصول إلى أدوات إنشاء الروابط التسويقية"}),e.jsxs("div",{className:"flex gap-3 justify-center pt-4",children:[e.jsx(p,{onClick:()=>s("/update-affiliate-prefs"),children:"تفعيل حساب المسوق"}),e.jsx(p,{variant:"outline",onClick:()=>s("/affiliate"),children:"معرفة المزيد عن التسويق بالعمولة"})]})]})})})}export{Be as default};
